<!DOCTYPE html>
<html lang="mr">
<head>
  <meta charset="UTF-8">
  <title>‡§§‡§æ‡§≤‡•Å‡§ï‡§æ ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§§‡•Å‡§≤‡§®‡§æ‡§§‡•ç‡§Æ‡§ï ‡§°‡•Ö‡§∂‡§¨‡•ã‡§∞‡•ç‡§° ‚Äì ‡§ú‡§≥‡§ó‡§æ‡§µ ‡§ú‡§ø‡§≤‡•ç‡§π‡§æ</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;700&display=swap" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <style>
    body {font-family:'Noto Sans Devanagari',sans-serif;background:#f7fafc;color:#23263a;margin:0;padding:1rem;}
    .glass{background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(99,102,241,0.1);margin-bottom:1rem;padding:1rem;}
    .dashboard-4col{display:flex;gap:.8rem;height:460px;}
    .kpi-col{flex:0 0 22%;background:#f0f4fa;border-radius:8px;padding:.6rem;overflow-y:auto;}
    .chart-col,.donut-col,.scheme-col{flex:0 0 26%;background:#f0f4fa;border-radius:8px;padding:.6rem;display:flex;flex-direction:column;}
    .kpi-card{position:relative;border-radius:50px;text-align:center;padding:.5rem;font-weight:700;margin:.3rem 0;cursor:pointer;transition:box-shadow .2s,border .2s;}
    .kpi-card:hover{border:2px solid #6366f1;box-shadow:0 2px 10px rgba(99,102,241,.3);}
    .kpi-card.top{background:linear-gradient(90deg,#10b981,#6ee7b7);color:#fff;}
    .kpi-card.mid{background:linear-gradient(90deg,#f59e0b,#fbbf24);color:#fff;}
    .kpi-card.bot{background:linear-gradient(90deg,#ef4444,#f87171);color:#fff;}
    .kpi-card.blink .kpi-icon{animation:blink 1.2s infinite;}
    @keyframes blink{0%,50%,100%{opacity:1}25%,75%{opacity:0.4}}
    .kpi-icon{font-size:1.6em;margin-bottom:.3rem;}
    .kpi-name{font-size:1em;margin:2px 0;}
    .kpi-score{font-size:1.2em;font-weight:800;}
    .dept-chip{display:inline-block;padding:4px 8px;border-radius:15px;background:#e0e7ff;color:#3730a3;font-weight:600;margin:2px;cursor:pointer;transition:transform .15s,border .15s;}
    .dept-chip:hover,.dept-chip.selected{background:#fbbf24;color:#92400e;border:1px solid #f59e0b;transform:scale(1.05);}
    .chart-header{font-size:1em;font-weight:700;color:#6366f1;text-align:center;margin-bottom:.4rem;user-select:none;}
    .chart-container{flex:1;position:relative;margin-bottom:.8rem;}
    .btn-compact{padding:.3rem .6rem;font-size:.8em;margin-top:.2rem;}
    .table thead th{background:#6366f1;color:#fff;padding:.4rem;text-align:center;}
    .table tbody td{padding:.3rem .2rem;text-align:center;border:1px solid #e5e7eb;}
    .table .selected-block td{background:#dbeafe!important;font-weight:700;}
    .table .top5 td{background:#d1fae5!important;}
    .table .mid5 td{background:#fef3c7!important;}
    .table .bot5 td{background:#fee2e2!important;}
    @media(max-width:1200px){.dashboard-4col{flex-direction:column;height:auto}.kpi-col,.chart-col,.donut-col,.scheme-col{flex:none;height:300px}}
  </style>
</head>
<body>
  <div class="container-fluid">
    <h2 class="text-center mb-3">üìä ‡§§‡§æ‡§≤‡•Å‡§ï‡§æ ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§§‡•Å‡§≤‡§®‡§æ‡§§‡•ç‡§Æ‡§ï ‡§°‡•Ö‡§∂‡§¨‡•ã‡§∞‡•ç‡§°<br><small class="text-muted">(‡§ú‡§≥‡§ó‡§æ‡§µ ‡§ú‡§ø‡§≤‡•ç‡§π‡§æ)</small></h2>
    <div class="glass mb-3">
      <div class="row g-2">
        <div class="col-md-6 col-lg-5">
          <label class="form-label">‡§Ø‡•ã‡§ú‡§®‡§æ ‡§®‡§ø‡§µ‡§°‡§æ:</label>
          <select id="schemeSelect" multiple class="form-select form-select-sm" size="7"></select>
        </div>
        <div class="col-md-6 col-lg-5">
          <label class="form-label">‡§§‡§æ‡§≤‡•Å‡§ï‡§æ ‡§®‡§ø‡§µ‡§°‡§æ:</label>
          <div id="talukaChips" class="mt-1"></div>
        </div>
        <div class="col-md-12 col-lg-2 text-end mt-2 mt-lg-0">
          <button id="resetBtn" class="btn btn-outline-danger btn-compact">Reset</button>
          <button id="submitBtn" class="btn btn-primary btn-compact ms-2">Submit</button>
        </div>
      </div>
    </div>

    <div class="glass">
      <div class="dashboard-4col">
        <!-- KPI Column -->
        <div class="kpi-col" id="kpiCol" aria-live="polite"></div>

        <!-- Bar Chart -->
        <div class="chart-col">
          <div class="chart-header">üìà ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§™‡•ç‡§∞‡§¶‡§∞‡•ç‡§∂‡§® ‡§§‡•Å‡§≤‡§®‡§æ</div>
          <div class="chart-container"><canvas id="barChart"></canvas></div>
          <button id="downloadBarBtn" class="btn btn-success btn-compact">‚¨áÔ∏è ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°</button>
        </div>

        <!-- Donut Chart -->
        <div class="donut-col">
          <div class="chart-header">üìä ‡§™‡•ç‡§∞‡§§‡§ø‡§∂‡§§ ‡§µ‡§æ‡§ü‡§™</div>
          <div class="chart-container"><canvas id="donutChart"></canvas></div>
          <button id="downloadDonutBtn" class="btn btn-warning btn-compact">‚¨áÔ∏è ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°</button>
        </div>

        <!-- Scheme Rank Chart -->
        <div class="scheme-col">
          <div class="chart-header">üóÇ ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§∞‡§Å‡§ï ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£</div>
          <div class="chart-container"><canvas id="schemeRankChart"></canvas></div>
          <button id="downloadSchemeBtn" class="btn btn-info btn-compact">‚¨áÔ∏è ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°</button>
        </div>
      </div>
    </div>

    <div class="glass mb-3">
      <h6 class="mb-2 text-primary">üìã ‡§§‡§æ‡§≤‡•Å‡§ï‡•ç‡§Ø‡§æ‡§Ç‡§ö‡•Ä ‡§∏‡§Ç‡§™‡•Ç‡§∞‡•ç‡§£ ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§µ ‡§∞‡§Å‡§ï‡§ø‡§Ç‡§ó</h6>
      <div class="table-responsive" style="max-height:340px;overflow-y:auto">
        <table class="table" id="dataTable">
          <thead><tr id="tableHeader"></tr></thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
      <div class="text-end mt-1">
        <button id="downloadCsvBtn" class="btn btn-secondary btn-compact">üìä CSV ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°</button>
      </div>
    </div>
  </div>

  <script>
    const CONFIG={apiKey:'AIzaSyDhCjnUv7x5yj9cXKV52Qv8CrYwUhBIWuU',spreadsheetId:'1y_EVqNg-reS3xV-Kn6cmTou7u_6kuyqykNdgdzXEMkE',range:'Rank!B5:AJ20'};
    let rawData=[], headers=[], blocks=[], schemes=[];let barChart,donutChart,schemeRankChart;
    const selectedBlocks=new Set(),selectedSchemes=new Set();

    async function fetchSheet(){
      const url=`https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.spreadsheetId}/values/${encodeURIComponent(CONFIG.range)}?majorDimension=ROWS&key=${CONFIG.apiKey}`;
      const res=await fetch(url);if(!res.ok)throw Error(res.statusText);
      return(await res.json()).values;
    }
    function parse(vals){
      headers=vals[0];
      const idx=headers.findIndex(h=>/‡§§‡§æ‡§≤‡•Å‡§ï‡§æ/i.test(h));
      blocks=vals.slice(1).map(r=>{const o={};headers.forEach((h,i)=>o[h]=r[i]);o._block=r[idx];return o;});
      schemes=headers.filter((_,i)=>i!==idx);rawData=blocks;
    }
    function renderControls(){
      const s=document.getElementById('schemeSelect');
      s.innerHTML=`<option value="__all__" style="font-weight:bold;">‡§∏‡§∞‡•ç‡§µ ‡§Ø‡•ã‡§ú‡§®‡§æ</option>`+schemes.map(v=>`<option>${v}</option>`).join('');
      s.addEventListener('change',()=>{const v=Array.from(s.selectedOptions).map(o=>o.value),all=v.includes('__all__');if(all)for(let o of s.options)if(o.value!=='__all__')o.selected=true;
        const act=Array.from(s.options).filter(o=>o.value!=='__all__'&&o.selected);
        s.querySelector('option[value="__all__"]').selected=(act.length===schemes.length);
      });
      const d=document.getElementById('talukaChips');
      d.innerHTML=blocks.map(b=>`<span class="dept-chip" data-block="${b._block}">${b._block}</span>`).join('');
      d.querySelectorAll('.dept-chip').forEach(el=>{
        el.onclick=()=>{const n=el.dataset.block;
          if(selectedBlocks.delete(n)) el.classList.remove('selected');
          else{selectedBlocks.add(n);el.classList.add('selected');}
          if(selectedBlocks.size===1)renderSchemeRankChart([...selectedBlocks][0]);
        };
      });
      document.getElementById('resetBtn').onclick=()=>{selectedBlocks.clear();selectedSchemes.clear();
        d.querySelectorAll('.dept-chip').forEach(e=>e.classList.remove('selected'));
        s.selectedIndex=-1;clearDashboard();showAllDefault();};
      document.getElementById('submitBtn').onclick=updateAll;
      document.getElementById('downloadBarBtn').onclick=()=>barChart&&downloadChart(barChart,'bar-chart.png');
      document.getElementById('downloadDonutBtn').onclick=()=>donutChart&&downloadChart(donutChart,'donut-chart.png');
      document.getElementById('downloadSchemeBtn').onclick=()=>schemeRankChart&&downloadChart(schemeRankChart,'scheme-rank-chart.png');
      document.getElementById('downloadCsvBtn').onclick=downloadCSV;
    }
    function downloadChart(c,f){const a=document.createElement('a');a.href=c.toBase64Image();a.download=f;a.click();}
    function collectSelections(){
      selectedBlocks.clear();selectedSchemes.clear();
      document.querySelectorAll('.dept-chip.selected').forEach(e=>selectedBlocks.add(e.dataset.block));
      Array.from(document.getElementById('schemeSelect').selectedOptions).forEach(o=>o.value==='__all__'?schemes.forEach(v=>selectedSchemes.add(v)):selectedSchemes.add(o.value));
    }
    function getRankOnes(){
      const cnt={};schemes.forEach(s=>{let best=1e9,t=[];rawData.forEach(r=>{const rk=parseInt(r[s])||1e9;rk<best?(best=rk,t=[r._block]):rk===best&&t.push(r._block)});if(best===1)t.forEach(b=>cnt[b]=(cnt[b]||0)+1)});
      return Object.entries(cnt).map(([b,c])=>({b,c})).sort((a,b)=>b.c-a.c);
    }
    function compute(){
      collectSelections();
      const sch=selectedSchemes.size?[...selectedSchemes]:schemes.slice(),bl=selectedBlocks.size?[...selectedBlocks].map(b=>rawData.find(r=>r._block===b)):rawData.slice();
      const ro=getRankOnes();
      const k=bl.map(r=>({b:r._block,ones:(ro.find(x=>x.b===r._block)||{c:0}).c,val:parseInt(r[sch[0]])||0}))
        .sort((a,b)=>b.ones-a.ones||a.val-b.val).map((x,i)=>({...x,rank:i+1}));
      return{blocksArr:bl,kpiData:k,schemesArr:sch};
    }
    function renderKPI(D){
      const C=document.getElementById('kpiCol');C.innerHTML='';
      if(!D||!D.kpiData.length)return;
      [['top','fa-trophy'],['mid','fa-balance-scale'],['bot','fa-exclamation-circle']].forEach((c,i)=>{
        const it=D.kpiData[i===0?0:i===1?Math.floor(D.kpiData.length/2):D.kpiData.length-1];
        if(it)C.innerHTML+=`<div class="kpi-card ${c[0]}${i===0?' blink':''}" onclick="showTalukaAnalysis('${it.b}')">
          <i class="fas ${c[1]} kpi-icon"></i>
          <div class="kpi-name">${it.b}</div>
          <div class="kpi-score">${i===0?it.ones+' #1s':it.val}</div>
        </div>`;
      });
    }
    window.showTalukaAnalysis=name=>{
      const A=schemes.map(s=>({s,rank:parseInt(rawData.find(r=>r._block===name)[s])||999})).sort((a,b)=>a.rank-b.rank),T=rawData.length;
      const exc=A.slice(0,3),need=A.slice(3,Math.ceil(A.length*0.7)),att=A.slice(Math.ceil(A.length*0.7));
      let R=`‡§§‡§æ‡§≤‡•Å‡§ï‡§æ: ${name}\n\nüèÜ Top 3:\n${exc.map(a=>`${a.s}:#${a.rank}/${T}`).join('\n')}
\n‚öñÔ∏è ‡§Æ‡§ß‡•ç‡§Ø‡§Æ:\n${need.map(a=>`${a.s}:#${a.rank}/${T}`).join('\n')}
\nüö® ‡§§‡§≥:\n${att.map(a=>`${a.s}:#${a.rank}/${T}`).join('\n')}`;
      alert(R);
    };
    function renderBar(D){
      const ctx=document.getElementById('barChart').getContext('2d');barChart&&barChart.destroy();
      const pal=['#6366f1','#10b981','#f59e0b','#ef4444','#3b82f6','#818cf8','#f472b6','#2dd4bf'],bg=D.kpiData.map((_,i)=>pal[i%pal.length]);
      barChart=new Chart(ctx,{type:'bar',data:{labels:D.kpiData.map(x=>x.b),datasets:[{data:D.kpiData.map(x=>x.ones),backgroundColor:bg,borderRadius:4}]},
        options:{indexAxis:'y',plugins:{legend:{display:false},datalabels:{anchor:'end',align:'right',formatter:v=>v+' #1s'}},responsive:true,maintainAspectRatio:false},
        plugins:[ChartDataLabels]});
    }
    function renderDonut(D){
      const ctx=document.getElementById('donutChart').getContext('2d');donutChart&&donutChart.destroy();
      const pal=['#6366f1','#10b981','#f59e0b','#ef4444','#3b82f6','#818cf8','#f472b6','#2dd4bf'];
      donutChart=new Chart(ctx,{type:'doughnut',data:{labels:D.kpiData.map(x=>x.b),datasets:[{data:D.kpiData.map(x=>x.ones),backgroundColor:pal}]},
        options:{plugins:{legend:{position:'bottom'},datalabels:{formatter:v=>v}},responsive:true,maintainAspectRatio:false},plugins:[ChartDataLabels]});
    }
    function renderSchemeRankChart(name){
      const tal=rawData.find(r=>r._block===name);if(!tal)return;const arr=schemes.map(s=>({s,rank:parseInt(tal[s])||999})).sort((a,b)=>a.rank-b.rank);
      const ctx=document.getElementById('schemeRankChart').getContext('2d');schemeRankChart&&schemeRankChart.destroy();
      schemeRankChart=new Chart(ctx,{type:'bar',data:{labels:arr.map(a=>a.s),datasets:[{data:arr.map(a=>a.rank),
        backgroundColor:arr.map(a=>a.rank===1?'#10b981':a.rank<=3?'#f59e0b':'#ef4444'),borderRadius:4}]},options:{plugins:{legend:{display:false},datalabels:{anchor:'end',align:'top',formatter:v=>`#${v}`,font:{size:8}}},responsive:true,maintainAspectRatio:false,scales:{y:{reverse:true}}},plugins:[ChartDataLabels]});
    }
    function renderTable(D){
      const th='<th>‡§∞‡§Å‡§ï</th><th>#1s</th>'+headers.map(h=>`<th>${h}</th>`).join('');
      document.getElementById('tableHeader').innerHTML=th;
      const rows=D.kpiData.map((r,i)=>{const cls=[i<3?'top5':'',i>=D.kpiData.length-3?'bot5':'',selectedBlocks.has(r.b)?'selected-block':''].filter(Boolean).join(' ');
        const tal=rawData.find(x=>x._block===r.b);
        return `<tr class="${cls}"><td>${r.rank}</td><td><b>${r.ones}</b></td>`+headers.map(h=>`<td>${tal[h]||''}</td>`).join('')+`</tr>`;}).
      join('');
      document.getElementById('tableBody').innerHTML=rows;
    }
    function clearDashboard(){
      document.getElementById('kpiCol').innerHTML='';
      document.getElementById('tableBody').innerHTML='';
      document.getElementById('tableHeader').innerHTML='';
      barChart&&barChart.destroy();donutChart&&donutChart.destroy();schemeRankChart&&schemeRankChart.destroy();
    }
    function showAllDefault(){
      selectedSchemes.clear();schemes.forEach(s=>selectedSchemes.add(s));
      selectedBlocks.clear();blocks.forEach(b=>selectedBlocks.add(b._block));
      document.querySelectorAll('.dept-chip').forEach(e=>e.classList.add('selected'));
      document.getElementById('schemeSelect').querySelectorAll('option').forEach(o=>o.selected=true);
      updateAll();
    }
    function updateAll(){
      const D=compute();
      if(!D||!D.kpiData.length){alert('‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§µ ‡§§‡§æ‡§≤‡•Å‡§ï‡§æ ‡§®‡§ø‡§µ‡§°‡§æ.');return;}
      renderKPI(D);renderBar(D);renderDonut(D);renderTable(D);
      if(selectedBlocks.size===1)renderSchemeRankChart([...selectedBlocks][0]);
    }
    function downloadCSV(){
      const D=compute();if(!D)return;
      const hd=['‡§∞‡§Å‡§ï','#1s'].concat(headers);
      let csv=hd.join(',')+'\n'+D.kpiData.map(r=>`${r.rank},${r.ones},`+headers.map(h=>`"${rawData.find(x=>x._block===r.b)[h]||''}"`).join(',')).join('\n');
      const blob=new Blob([csv],{type:'text/csv'}),u=URL.createObjectURL(blob),a=document.createElement('a');a.href=u;a.download='taluka-data.csv';a.click();URL.revokeObjectURL(u);
    }
    (async()=>{
      try{const v=await fetchSheet();parse(v);renderControls();showAllDefault();}
      catch(e){alert('‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§§‡•ç‡§∞‡•Å‡§ü‡•Ä: '+e.message);}
    })();
  </script>
</body>
</html>
