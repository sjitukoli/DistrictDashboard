<!DOCTYPE html>
<html lang="mr">
<head>
  <meta charset="UTF-8" />
  <title>‡§§‡§æ‡§≤‡•Å‡§ï‡§æ ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§§‡•Å‡§≤‡§®‡§æ‡§§‡•ç‡§Æ‡§ï ‡§°‡•Ö‡§∂‡§¨‡•ã‡§∞‡•ç‡§° - ‡§ú‡§≥‡§ó‡§æ‡§µ ‡§ú‡§ø‡§≤‡•ç‡§π‡§æ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js and DataLabels Plugin -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.2.0/chartjs-plugin-datalabels.umd.min.js"></script>
  <!-- Font Awesome -->
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    rel="stylesheet"
  />
  <style>
    body {
      background: linear-gradient(135deg, #667eea, #764ba2 50%, #f093fb);
      font-family: "Inter", sans-serif;
      color: #1f2937;
      min-height: 100vh;
      padding-bottom: 4rem;
    }
    h1,
    h2 {
      color: #fff;
    }
    .glass-card {
      background: rgba(255 255 255 / 0.12);
      backdrop-filter: blur(14px) saturate(180%);
      -webkit-backdrop-filter: blur(14px) saturate(180%);
      border-radius: 16px;
      border: 1px solid rgba(255 255 255 / 0.24);
      padding: 1rem 1.5rem;
      box-shadow: 0px 6px 15px rgba(255 255 255 / 0.15);
    }
    .kpi-card {
      background: linear-gradient(90deg, #10b981aa, #b6f7d688 110%);
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 1rem;
      color: #065f46;
      font-weight: 600;
      box-shadow: 0 8px 24px #10b98150;
      transition: transform 0.15s ease-in-out;
      cursor: default;
    }
    .kpi-card.mid {
      background: linear-gradient(90deg, #fbbf24aa, #fef08a88 110%);
      color: #92400e;
      box-shadow: 0 8px 24px #d9770590;
    }
    .kpi-card.bot {
      background: linear-gradient(90deg, #ef4444aa, #fca5a588 110%);
      color: #991b1b;
      box-shadow: 0 8px 20px #ef444470;
    }
    .kpi-card:hover {
      transform: scale(1.03);
      box-shadow: 0 12px 35px rgba(0 0 0 / 0.3);
    }
    table {
      border-collapse: separate;
      border-spacing: 0 0.5rem;
      width: 100%;
    }
    thead tr th {
      background: linear-gradient(to right, #667eea, #764ba2);
      color: white;
      padding: 0.7rem 1.2rem;
      font-weight: 700;
      text-align: left;
      user-select: none;
      border-radius: 8px;
    }
    tbody tr {
      background: rgba(255 255 255 / 0.15);
      transition: background-color 0.3s ease;
      cursor: default;
      border-radius: 12px;
    }
    tbody tr:hover {
      background: rgba(255 255 255 / 0.3);
    }
    tbody tr td {
      padding: 0.6rem 1rem;
      color: #f0fdfa;
      border-radius: 8px;
    }
    .rank-cell {
      font-weight: 700;
      padding-left: 1.2rem;
      position: relative;
    }
    /* Gradient backgrounds for top/mid/bottom rows */
    tbody tr.top5 {
      background: linear-gradient(to right, #22c55e, #4ade80);
      color: white;
      font-weight: 700;
    }
    tbody tr.mid5 {
      background: linear-gradient(to right, #fbbf24, #fde68a);
      font-weight: 600;
      color: #351c07;
    }
    tbody tr.bot5 {
      background: linear-gradient(to right, #ef4444, #fca5a5);
      color: white;
      font-weight: 700;
    }
    /* Scroll and responsiveness */
    .scrollable {
      overflow-x: auto;
      margin-top: 1rem;
      border-radius: 12px;
    }
    /* Checkbox container */
    .checkbox-container {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1rem;
      max-height: 200px;
      overflow-y: auto;
      padding: 0.5rem;
      background: rgba(255 255 255 / 0.15);
      border-radius: 12px;
    }
    .checkbox-container label {
      font-weight: 600;
      color: #f0fdfa;
      cursor: pointer;
      user-select: none;
    }
    select,
    button {
      padding: 0.4rem 0.8rem;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s;
      color: white;
    }
    select {
      background: #4338ca;
      margin-right: 1rem;
      min-width: 200px;
    }
    button {
      background: #2563eb;
    }
    button:hover {
      background: #1d4ed8;
    }
    @media (max-width: 768px) {
      .checkbox-container {
        max-height: 150px;
      }
      select {
        min-width: 100%;
        margin-bottom: 0.75rem;
      }
    }
  </style>
</head>
<body>
  <main class="max-w-7xl mx-auto p-6">
    <h1 class="text-4xl font-extrabold mb-8 text-white text-center">
      ‡§§‡§æ‡§≤‡•Å‡§ï‡§æ ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§§‡•Å‡§≤‡§®‡§æ‡§§‡•ç‡§Æ‡§ï ‡§°‡•Ö‡§∂‡§¨‡•ã‡§∞‡•ç‡§° - ‡§ú‡§≥‡§ó‡§æ‡§µ ‡§ú‡§ø‡§≤‡•ç‡§π‡§æ
    </h1>

    <!-- Scheme selection dropdown and multi-block checkboxes -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6 gap-4">
      <div class="flex items-center gap-2">
        <label for="schemeSelect" class="text-white font-semibold">‡§Ø‡•ã‡§ú‡§®‡§æ ‡§®‡§ø‡§µ‡§°‡§æ:</label>
        <select id="schemeSelect" aria-label="‡§Ø‡•ã‡§ú‡§®‡§æ ‡§®‡§ø‡§µ‡§°‡§æ"></select>
      </div>

      <div class="flex-1">
        <div class="checkbox-container" id="blockCheckboxes" aria-label="‡§§‡§æ‡§≤‡•Å‡§ï‡§æ ‡§®‡§ø‡§µ‡§°‡§æ (Multiple select)"></div>
      </div>
    </div>

    <div class="flex flex-wrap gap-4 mb-6 items-center">
      <button id="compareBtn" aria-label="‡§§‡§æ‡§≤‡•Å‡§ï‡§æ ‡§§‡•Å‡§≤‡§®‡§æ ‡§ï‡§∞‡§æ" title="üßÆ ‡§§‡•Å‡§≤‡§®‡§æ ‡§ï‡§∞‡§æ" class="select-none">
        üßÆ ‡§§‡•Å‡§≤‡§®‡§æ ‡§ï‡§∞‡§æ
      </button>
      <button id="refreshBtn" aria-label="‡§°‡•á‡§ü‡§æ ‡§∞‡•Ä‡§´‡•ç‡§∞‡•á‡§∂ ‡§ï‡§∞‡§æ" title="‡§∞‡•Ä‡§´‡•ç‡§∞‡•á‡§∂ ‡§ï‡§∞‡§æ">
        üîÑ ‡§∞‡•Ä‡§´‡•ç‡§∞‡•á‡§∂ ‡§ï‡§∞‡§æ
      </button>
      <button id="downloadChartBtn" aria-label="‡§ö‡§æ‡§∞‡•ç‡§ü ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡§æ" title="‡§ö‡§æ‡§∞‡•ç‡§ü PNG ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°">
        ‚¨áÔ∏è ‡§ö‡§æ‡§∞‡•ç‡§ü PNG ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°
      </button>
      <button id="downloadCsvBtn" aria-label="CSV ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡§æ" title="‡§°‡•á‡§ü‡§æ CSV ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°">
        ‚¨áÔ∏è CSV ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°
      </button>
    </div>

    <!-- Bar chart for selected scheme -->
    <section class="glass-card mb-8 p-6">
      <h2 class="text-xl font-bold mb-4 text-white flex items-center gap-2">
        <i class="fa fa-chart-bar"></i> ‡§§‡§æ‡§≤‡•Å‡§ï‡•ç‡§Ø‡§æ‡§Ç‡§ö‡•ç‡§Ø‡§æ ‡§∏‡•ç‡§ï‡•ã‡§Ö‡§∞‡§ö‡•Ä ‡§§‡•Å‡§≤‡§®‡§æ (‡§Ø‡•ã‡§ú‡§®‡§æ ‡§Ö‡§®‡•Å‡§∏‡§æ‡§∞)
      </h2>
      <canvas id="barChart" style="height: 340px;"></canvas>
    </section>

    <!-- Data table with gradient ranks -->
    <section class="glass-card p-6">
      <h2 class="text-xl font-bold mb-4 text-white flex items-center gap-2">
        <i class="fa fa-table"></i> ‡§§‡§æ‡§≤‡•Å‡§ï‡•ç‡§Ø‡§æ‡§Ç‡§ö‡•Ä ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä (‡§∞‡§Å‡§ï‡§ø‡§Ç‡§ó‡§∏‡§π)
      </h2>
      <div class="scrollable">
        <table id="dataTable" aria-describedby="tableDescription" role="grid" aria-live="polite">
          <thead>
            <tr id="tableHeader"></tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    // Google Sheet config - update if needed!
    const GOOGLE_SHEETS_CONFIG = {
      apiKey: 'AIzaSyDhCjnUv7x5yj9cXKV52Qv8CrYwUhBIWuU',
      spreadsheetId: '1y_EVqNg-reS3xV-Kn6cmTou7u_6kuyqykNdgdzXEMkE',
      range: 'Rank!B5:AJ20',
      baseUrl: 'https://sheets.googleapis.com/v4/spreadsheets'
    };

    let rawData = [];
    let headers = [];
    let blockNameColIndex = -1;

    let selectedScheme = '';
    const selectedBlocks = new Set();

    let barChartInstance = null;

    // Load data from Google Sheets
    async function loadData() {
      const { baseUrl, spreadsheetId, range, apiKey } = GOOGLE_SHEETS_CONFIG;
      const url = `${baseUrl}/${spreadsheetId}/values/${encodeURIComponent(
        range
      )}?majorDimension=ROWS&valueRenderOption=UNFORMATTED_VALUE&key=${apiKey}`;
      const response = await fetch(url);
      if (!response.ok) {
        throw new Error(`Sheet fetch error: ${response.status}`);
      }
      const data = await response.json();
      return data.values;
    }

    // Parse and map data
    function parseData(values) {
      headers = values[0];
      blockNameColIndex = headers.findIndex((h) =>
        /block.?name|‡§§‡§æ‡§≤‡•Å‡§ï‡§æ/i.test(h)
      );
      if (blockNameColIndex === -1) {
        alert('‡§§‡§æ‡§≤‡•Å‡§ï‡§æ ‡§Ø‡§æ ‡§ï‡•â‡§≤‡§Æ‡§æ‡§ö‡§æ ‡§∂‡•ã‡§ß ‡§≤‡§æ‡§ó‡§≤‡§æ ‡§®‡§æ‡§π‡•Ä. ‡§ï‡•É‡§™‡§Ø‡§æ ‡§ï‡•â‡§≤‡§Æ ‡§®‡§æ‡§µ ‡§§‡§™‡§æ‡§∏‡§æ.');
        throw new Error('‡§§‡§æ‡§≤‡•Å‡§ï‡§æ ‡§ï‡•â‡§≤‡§Æ ‡§®‡§æ‡§π‡•Ä');
      }

      // Map rows to objects with keys as columns
      return values
        .slice(1)
        .filter((r) => r.length && r[blockNameColIndex])
        .map((row) => {
          const obj = {};
          headers.forEach((h, i) => {
            obj[h] = row[i];
          });
          obj.__blockName = row[blockNameColIndex];
          return obj;
        });
    }

    // Generate options for dropdown
    function populateSchemeDropdown(schemes) {
      const select = document.getElementById('schemeSelect');
      select.innerHTML = '';
      schemes.forEach((scheme, i) => {
        const option = document.createElement('option');
        option.value = scheme;
        option.textContent = scheme;
        select.appendChild(option);
      });
      selectedScheme = schemes[0] || '';
    }

    // Render checkboxes for blocks
    function renderBlockCheckboxes(blockNames) {
      const container = document.getElementById('blockCheckboxes');
      container.innerHTML = '';
      blockNames.forEach((block) => {
        const id = `chk_${block.replace(/\s+/g, '_')}`;
        const label = document.createElement('label');
        label.className = 'checkbox-block';
        label.htmlFor = id;
        label.innerHTML = `
          <input type="checkbox" id="${id}" value="${block}" checked />
          <span>${block}</span>
        `;
        container.appendChild(label);
        container.querySelector('input').addEventListener('change', (e) => {
          if (e.target.checked) selectedBlocks.add(e.target.value);
          else selectedBlocks.delete(e.target.value);
          updateDashboard();
        });
      });
      // Initialize selected blocks as all checked
      blockNames.forEach((b) => selectedBlocks.add(b));
    }

    // Compute numeric values for selected scheme and filter blocks
    function prepareDisplayData() {
      if (!selectedScheme) return [];
      // Map each row and parse the scheme value as number
      const filteredData = rawData
        .filter((r) => selectedBlocks.has(r.__blockName))
        .map((row) => {
          const valRaw = row[selectedScheme];
          const valNum = parseFloat(valRaw);
          return {
            ...row,
            __val: isNaN(valNum) ? 0 : valNum
          };
        });
      // Sort descending by __val
      filteredData.sort((a, b) => b.__val - a.__val);
      // Assign rank 1..n
      filteredData.forEach((row, idx) => {
        row.__rank = idx + 1;
      });
      return filteredData;
    }

    // Render bar chart
    function renderBarChart(data) {
      const ctx = document.getElementById('barChart').getContext('2d');
      if (barChartInstance) {
        barChartInstance.destroy();
      }
      const labels = data.map((r) => r.__blockName);
      const values = data.map((r) => r.__val);
      // Colors: Top 5 green, Bottom 5 red, Mid yellow otherwise
      const colors = data.map((_, idx) => {
        if (idx < 5) return '#22c55e'; // green
        else if (idx >= data.length - 5) return '#ef4444'; // red
        else return '#fbbf24'; // yellow
      });
      barChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: selectedScheme,
              data: values,
              backgroundColor: colors,
              borderRadius: 8,
              maxBarThickness: 50
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            datalabels: {
              color: '#111',
              anchor: 'end',
              align: 'top',
              font: { weight: 'bold', size: 14 },
              formatter: (value) => value.toFixed(1)
            },
            tooltip: {
              callbacks: {
                label: (ctx) => `${ctx.parsed.y !== undefined ? ctx.parsed.y : ctx.parsed} `
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { stepSize: 10 },
              grid: { color: 'rgba(255,255,255,0.1)' }
            },
            x: { grid: { color: 'rgba(255,255,255,0.1)' } }
          }
        },
        plugins: [ChartDataLabels]
      });
    }

    // Render full data table with gradients by ranking group
    function renderDataTable(data) {
      // Construct table header
      const thead = document.getElementById('tableHeader');
      thead.innerHTML =
        '<th>‡§∞‡§Å‡§ï</th>' +
        headers
          .map((h) => `<th>${h}</th>`)
          .join('');

      // Construct body rows
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '';
      const totalRows = data.length;
      const midStart = Math.floor(totalRows / 2) - 2; // 5 middle rows approx

      data.forEach((row, idx) => {
        const tr = document.createElement('tr');

        // Style row based on rank group
        if (idx < 5) tr.classList.add('top5');
        else if (idx >= totalRows - 5) tr.classList.add('bot5');
        else if (idx >= midStart && idx < midStart + 5) tr.classList.add('mid5');

        tr.innerHTML = `<td class="rank-cell">${row.__rank}</td>` +
          headers
            .map((h) => `<td>${row[h] ?? ''}</td>`)
            .join('');
        tbody.appendChild(tr);
      });
    }

    // Download CSV helper
    function downloadCSV(data) {
      const csvRows = [];
      // Header
      csvRows.push(['‡§∞‡§Å‡§ï', ...headers].join(','));
      // Data rows
      data.forEach((row) => {
        const vals = headers.map((h) =>
          `"${(row[h] ?? '').toString().replace(/"/g, '""')}"`
        );
        csvRows.push([row.__rank, ...vals].join(','));
      });
      const csvString = csvRows.join('\n');
      const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `taluka_ranking_${selectedScheme.replace(/\s+/g, '_')}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // Download chart as PNG
    function downloadChart() {
      if (!barChartInstance) return;
      const url = barChartInstance.toBase64Image();
      const a = document.createElement('a');
      a.href = url;
      a.download = `taluka_chart_${selectedScheme.replace(/\s+/g, '_')}.png`;
      a.click();
    }

    // Update dashboard - main update
    function updateDashboard() {
      if (!selectedScheme) return;
      let filteredData = prepareDisplayData();

      renderBarChart(filteredData);
      renderDataTable(filteredData);
    }

    async function initialize() {
      let sheetValues;
      try {
        sheetValues = await loadData();
      } catch (e) {
        console.error('Error loading sheet data:', e);
        alert(
          'Google Sheets ‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§£‡•ç‡§Ø‡§æ‡§§ ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§Ü‡§≤‡•Ä. ‡§ï‡•É‡§™‡§Ø‡§æ ‡§®‡§Ç‡§§‡§∞ ‡§™‡•Å‡§®‡§∞‡•ç‡§™‡•ç‡§∞‡§Ø‡§§‡•ç‡§® ‡§ï‡§∞‡§æ.'
        );
        return;
      }

      rawData = parseData(sheetValues);

      // Extract block names
      const blockNames = Array.from(
        new Set(rawData.map((r) => r.__blockName))
      ).sort();

      // Extract scheme names - all headers except block name
      const schemeCandidates = headers.filter(
        (_, i) => i !== blockNameColIndex && headers[i] !== ''
      );

      // Initialize dropdown and checkboxes
      populateSchemeDropdown(schemeCandidates);
      renderBlockCheckboxes(blockNames);

      // Setup event listeners
      document
        .getElementById('schemeSelect')
        .addEventListener('change', (e) => {
          selectedScheme = e.target.value;
          updateDashboard();
        });
      document
        .getElementById('compareBtn')
        .addEventListener('click', () => {
          if (selectedBlocks.size === 0) {
            alert('‡§ï‡•É‡§™‡§Ø‡§æ ‡§ï‡§ø‡§Æ‡§æ‡§® ‡§è‡§ï ‡§§‡§æ‡§≤‡•Å‡§ï‡§æ ‡§®‡§ø‡§µ‡§°‡§æ.');
            return;
          }
          const blocks = Array.from(selectedBlocks).join(', ');
          alert(
            `‡§®‡§ø‡§µ‡§°‡§≤‡•á‡§≤‡•Ä ‡§§‡§æ‡§≤‡•Å‡§ï‡•á: ${blocks}\n\n*** ‡§™‡•ã‡§∞‡•ç‡§ü‡•á‡§¨‡§≤ ‡§§‡•Å‡§≤‡§®‡§æ --- ‡§™‡•Å‡§¢‡•Ä‡§≤ ‡§∏‡•Å‡§ß‡§æ‡§∞‡§£‡§æ ‡§Æ‡§ß‡•ç‡§Ø‡•á ***`
          );
        });
      document
        .getElementById('refreshBtn')
        .addEventListener('click', async () => {
          selectedBlocks.clear();
          await initialize();
          // Reset all checkboxes checked
          const checkboxes = document.querySelectorAll(
            '#blockCheckboxes input[type=checkbox]'
          );
          checkboxes.forEach((cb) => {
            cb.checked = true;
            selectedBlocks.add(cb.value);
          });
          updateDashboard();
        });
      document
        .getElementById('downloadCsvBtn')
        .addEventListener('click', () =>
          downloadCSV(prepareDisplayData())
        );
      document
        .getElementById('downloadChartBtn')
        .addEventListener('click', downloadChart);

      // Initial render
      updateDashboard();
    }

    // initialize page
    initialize();
  </script>
</body>
</html>
