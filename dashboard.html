<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Department Ranking Dashboard Pro</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js & DataLabels -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.2.0/chartjs-plugin-datalabels.umd.min.js"></script>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

  <style>
    /* ---------- CUSTOM PROPERTIES ---------- */
    :root{
      --glass-bg:rgba(255,255,255,0.08);
      --glass-border:rgba(255,255,255,0.18);
      --glass-shadow:0 8px 32px rgba(31,38,135,0.37);
      --primary-gradient:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      --accent-gradient:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);
      --success-gradient:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);
      --warning-gradient:linear-gradient(135deg,#43e97b 0%,#38f9d7 100%);
    }

    /* ---------- GLOBAL ---------- */
    *{scroll-behavior:smooth}
    body{
      font-family:'Inter',sans-serif;
      background:linear-gradient(135deg,#667eea,#764ba2 50%,#f093fb);
      color:#fff;
      margin:0;
      min-height:100vh;
      overflow-x:hidden;
    }

    /* ---------- REUSABLE GLASS CARD ---------- */
    .glass-card{
      background:rgba(255,255,255,0.12);
      backdrop-filter:blur(20px) saturate(200%);
      border:1px solid rgba(255,255,255,0.2);
      border-radius:20px;
      transition:transform .3s,box-shadow .3s;
      position:relative;
      overflow:hidden;
    }
    .glass-card:hover{
      transform:translateY(-8px);
      box-shadow:0 20px 40px rgba(31,38,135,.5);
      border-color:rgba(255,255,255,.3);
    }

    /* ---------- SIDEBAR & BUTTONS ---------- */
    .sidebar,.dark-mode-toggle,.menu-toggle,.fab,.api-status,.notification{
      backdrop-filter:blur(16px);
      border:1px solid var(--glass-border);
      border-radius:12px;
    }
    .sidebar{
      position:fixed;top:0;left:0;
      width:280px;height:100vh;
      background:rgba(0,0,0,.3);
      transform:translateX(-100%);
      transition:transform .3s;
      z-index:1000;
      padding-top:2rem;
    }
    .sidebar.open{transform:translateX(0)}
    .sidebar-item{
      color:rgba(255,255,255,.8);
      padding:1rem 2rem;
      display:flex;align-items:center;gap:1rem;
      cursor:pointer;
      transition:background .3s;
    }
    .sidebar-item:hover{background:rgba(255,255,255,.1);color:#fff}

    .menu-toggle,.dark-mode-toggle{
      position:fixed;top:20px;padding:.75rem;
      color:#fff;cursor:pointer;z-index:1100;
    }
    .menu-toggle{left:20px}
    .dark-mode-toggle{right:20px}
    .menu-toggle:hover,.dark-mode-toggle:hover{
      background:rgba(255,255,255,.2);transform:scale(1.1)
    }

    .fab{
      position:fixed;bottom:30px;right:30px;
      width:60px;height:60px;
      background:var(--accent-gradient);
      color:#fff;
      display:flex;align-items:center;justify-content:center;
      font-size:1.5rem;border:none;cursor:pointer;
      transition:transform .3s,box-shadow .3s;z-index:1000;
    }
    .fab:hover{transform:scale(1.1);box-shadow:0 12px 35px rgba(0,0,0,.4)}

    .api-status{
      position:fixed;top:70px;right:20px;
      padding:.5rem 1rem;font-size:.875rem;z-index:1000;
    }
    .api-status.connected{border-color:#10b981}
    .api-status.disconnected{border-color:#ef4444}

    .notification{
      position:fixed;top:4rem;right:1rem;
      padding:1rem;max-width:300px;
      transform:translateX(100%);transition:transform .3s;
      z-index:1000;
    }
    .notification.show{transform:translateX(0)}

    /* ---------- GRID LAYOUTS ---------- */
    .dashboard-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(350px,1fr));
      gap:1.5rem;
    }
    .kpi-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
      gap:1.5rem;
    }
    .department-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(300px,1fr));
      gap:1rem;
    }

    /* ---------- DROPDOWNS & BUTTONS ---------- */
    .filter-dropdown,.interactive-btn{
      background:var(--glass-bg);
      border:1px solid var(--glass-border);
      color:#fff;padding:.75rem 1.5rem;
      border-radius:12px;font-weight:600;cursor:pointer;
      transition:background .3s,transform .3s;
    }
    .filter-dropdown:hover,.interactive-btn:hover{
      background:rgba(255,255,255,.2);transform:translateY(-2px);
    }

    /* ---------- CHART --------- */
    .chart-container{position:relative;height:300px;padding:1.5rem}

    /* ---------- TABLE ---------- */
    .data-table,.ranking-table{width:100%;border-collapse:collapse;color:#fff}
    .data-table th,.data-table td,
    .ranking-table th,.ranking-table td{
      padding:1rem;text-align:left;
      border-bottom:1px solid rgba(255,255,255,.1);
    }
    .data-table th,.ranking-table th{
      background:rgba(255,255,255,.1);
      font-weight:600;text-transform:uppercase;
      font-size:.875rem;letter-spacing:.05em;
    }
    .data-table tbody tr:hover,
    .ranking-table tbody tr:hover{background:rgba(255,255,255,.05)}

    /* ---------- DEPARTMENT CARD ---------- */
    .department-card{
      background:var(--glass-bg);
      border-left:4px solid rgba(255,255,255,.3);
      padding:1.5rem;border-radius:16px;cursor:pointer;
      transition:transform .3s,border-color .3s,background .3s;
      position:relative;
    }
    .department-card:hover{transform:translateX(5px);border-left-color:rgba(255,255,255,.8)}
    .department-card.selected{
      background:rgba(255,255,255,.2);border-left-color:#fff;
    }
    .department-rank{
      position:absolute;top:10px;right:15px;
      width:40px;height:40px;border-radius:50%;
      background:rgba(255,255,255,.2);
      display:flex;align-items:center;justify-content:center;
      font-weight:bold;font-size:1.2rem;color:#fff;
    }
    .rank-1{background:#FFD700;color:#000}
    .rank-2{background:#C0C0C0;color:#000}
    .rank-3{background:#CD7F32;color:#fff}

    .score-bar{height:8px;background:rgba(255,255,255,.1);border-radius:4px;overflow:hidden;margin-top:5px}
    .score-fill{height:100%;background:linear-gradient(90deg,#43e97b,#38f9d7);transition:width .5s}

    .status-indicator{display:inline-block;width:12px;height:12px;border-radius:50%;margin-right:8px}
    .status-excellent{background:#10b981}
    .status-good{background:#3b82f6}
    .status-average{background:#f59e0b}
    .status-poor{background:#ef4444}

    @media(max-width:768px){
      .dashboard-grid,.department-grid{grid-template-columns:1fr}
      .kpi-grid{grid-template-columns:repeat(auto-fit,minmax(200px,1fr))}
      .chart-container{height:250px;padding:1rem}
    }
  </style>
</head>
<body>

  <!-- API Status -->
  <div id="apiStatus" class="api-status connected">
    <span id="statusIndicator" class="status-indicator status-excellent"></span>
    <span id="statusText">Google Sheets Connected</span>
  </div>

  <!-- Menu & Dark-Mode -->
  <button class="menu-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
  <button class="dark-mode-toggle" onclick="toggleDarkMode()"><i class="fas fa-moon"></i></button>

  <!-- Sidebar -->
  <nav id="sidebar" class="sidebar">
    <div class="sidebar-item" onclick="navigateTo('departmentRanking')"><i class="fas fa-chart-line"></i><span>Department Ranking</span></div>
    <div class="sidebar-item" onclick="navigateTo('rankingChartSection')"><i class="fas fa-trophy"></i><span>Rankings</span></div>
    <div class="sidebar-item" onclick="navigateTo('performanceSection')"><i class="fas fa-speedometer-alt"></i><span>Performance Trends</span></div>
    <div class="sidebar-item" onclick="navigateTo('reportsSection')"><i class="fas fa-file-alt"></i><span>Detailed Table</span></div>
    <div class="sidebar-item" onclick="refreshData()"><i class="fas fa-sync-alt"></i><span>Refresh Data</span></div>
  </nav>

  <!-- Main -->
  <main class="min-h-screen p-6 pt-20 max-w-7xl mx-auto">

    <!-- Header -->
    <header class="glass-card mb-8 p-6">
      <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
        <div>
          <h1 class="text-4xl font-bold">Department Ranking Dashboard Pro üèÜ</h1>
          <p class="opacity-80">Real-time Google Sheets integration</p>
        </div>
        <div class="flex flex-wrap gap-3">
          <select id="departmentFilter" class="filter-dropdown" onchange="filterByDepartment()">
            <option value="">All Departments</option>
          </select>
          <select id="timeFilter" class="filter-dropdown" onchange="filterByTime()">
            <option value="current">Current Period</option>
            <option value="quarter">This Quarter</option>
            <option value="year">This Year</option>
            <option value="custom">Custom Range</option>
          </select>
          <button class="interactive-btn" onclick="exportData()"><i class="fas fa-download mr-2"></i>Export All</button>
          <button class="interactive-btn" onclick="refreshData()"><i class="fas fa-sync-alt mr-2"></i>Refresh</button>
        </div>
      </div>
    </header>

    <!-- Department Ranking -->
    <section id="departmentRanking" class="mb-8">
      <h2 class="text-2xl font-bold mb-4">Department Ranking</h2>
      <div id="departmentCards" class="department-grid"></div>
    </section>

    <!-- KPI Cards -->
    <section id="kpiSection" class="kpi-grid mb-8">
      <div id="kpi1" class="glass-card p-6" style="background:var(--primary-gradient)">
        <div class="text-xl font-semibold mb-2">Overall Score</div>
        <div class="text-3xl font-bold" id="kpiValue1">‚Äî</div>
        <div class="kpi-change" id="kpiChange1">‚Äî</div>
      </div>
      <div id="kpi2" class="glass-card p-6" style="background:var(--accent-gradient)">
        <div class="text-xl font-semibold mb-2">Current Rank</div>
        <div class="text-3xl font-bold" id="kpiValue2">‚Äî</div>
        <div class="kpi-change" id="kpiChange2">‚Äî</div>
      </div>
      <div id="kpi3" class="glass-card p-6" style="background:var(--success-gradient)">
        <div class="text-xl font-semibold mb-2">Efficiency Rate</div>
        <div class="text-3xl font-bold" id="kpiValue3">‚Äî</div>
        <div class="kpi-change" id="kpiChange3">‚Äî</div>
      </div>
      <div id="kpi4" class="glass-card p-6" style="background:var(--warning-gradient)">
        <div class="text-xl font-semibold mb-2">Total Departments</div>
        <div class="text-3xl font-bold" id="kpiValue4">‚Äî</div>
        <div class="kpi-change" id="kpiChange4">‚Äî</div>
      </div>
    </section>

    <!-- Charts & Feed -->
    <div class="dashboard-grid mb-8">
      <!-- Rankings Bar -->
      <section id="rankingChartSection" class="glass-card p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-semibold">Department Rankings</h3>
          <select id="rankingMetric" class="filter-dropdown" onchange="updateRankingChart()">
            <option value="overall">Overall Score</option>
            <option value="efficiency">Efficiency</option>
            <option value="innovation">Innovation</option>
            <option value="satisfaction">Satisfaction</option>
          </select>
        </div>
        <div class="chart-container"><canvas id="rankingChart"></canvas></div>
      </section>

      <!-- Performance Line -->
      <section id="performanceSection" class="glass-card p-6">
        <h3 class="text-xl font-semibold mb-4">Performance Trends</h3>
        <div class="chart-container"><canvas id="performanceChart"></canvas></div>
      </section>

      <!-- Radar Comparison -->
      <section class="glass-card p-6">
        <h3 class="text-xl font-semibold mb-4">Top 3 Comparison</h3>
        <div class="chart-container"><canvas id="comparisonChart"></canvas></div>
      </section>

      <!-- Live Feed -->
      <section class="glass-card p-6">
        <h3 class="text-xl font-semibold mb-4">Live Performance Feed</h3>
        <div id="performanceFeed" class="space-y-4"></div>
      </section>
    </div>

    <!-- Detailed Table -->
    <section id="reportsSection" class="glass-card p-6 mb-8">
      <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
        <h3 class="text-xl font-semibold">Detailed Department Rankings</h3>
        <div class="flex gap-3">
          <input id="searchInput" type="text" placeholder="Search departments..." class="interactive-btn bg-opacity-20 placeholder-white" onkeyup="searchDepartments()">
          <button class="interactive-btn" onclick="sortTable()"><i class="fas fa-sort"></i></button>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table id="rankingTable" class="ranking-table">
          <thead>
            <tr>
              <th>Rank</th><th>Department</th><th>Overall</th><th>Efficiency</th><th>Innovation</th><th>Satisfaction</th><th>Status</th><th>Change</th><th>Actions</th>
            </tr>
          </thead>
          <tbody id="rankingTableBody"></tbody>
        </table>
      </div>
    </section>

    <!-- Footer -->
    <footer class="glass-card p-6">
      <div class="flex flex-col md:flex-row justify-between items-center gap-4">
        <div class="opacity-80">¬© 2025 Department Ranking Dashboard Pro</div>
        <div class="flex gap-6">
          <a href="#" class="opacity-80 hover:opacity-100">API Docs</a>
          <a href="#" class="opacity-80 hover:opacity-100">Privacy</a>
          <a href="#" class="opacity-80 hover:opacity-100">Support</a>
        </div>
      </div>
    </footer>

  </main>

  <!-- Floating Button -->
  <button class="fab" onclick="showUploadModal()"><i class="fas fa-plus"></i></button>


  <!-- ---------- SCRIPTS ---------- -->
  <script>
    /* ---------- GOOGLE SHEETS CONFIG ---------- */
    const GOOGLE_SHEETS_CONFIG={
      apiKey:'AIzaSyDhCjnUv7x5yj9cXKV52Qv8CrYwUhBIWuU',
      spreadsheetId:'1y_EVqNg-reS3xV-Kn6cmTou7u_6kuyqykNdgdzXEMkE',
      range:'Sheet1!A:G',
      baseUrl:'https://sheets.googleapis.com/v4/spreadsheets'
    };

    /* ---------- STATE ---------- */
    let departmentData=[],selectedDepartment=null,charts={},isDataLoading=false,lastRefresh=0;

    /* ---------- INIT ---------- */
    document.addEventListener('DOMContentLoaded',initializeDashboard);

    async function initializeDashboard(){
      showLoading(true);
      try{await loadDataFromGoogleSheets()}catch{departmentData=getSampleData()}
      setupFilters();setupDepartmentCards();setupCharts();updateKPIs();populateRankingTable();setupLiveFeed();
      showLoading(false);showNotification('Dashboard loaded!','success');
    }

    /* ---------- DATA ---------- */
    async function loadDataFromGoogleSheets(){
      updateAPIStatus('connecting');
      const{baseUrl,spreadsheetId,range,apiKey}=GOOGLE_SHEETS_CONFIG;
      const endpoint=\`\${baseUrl}/\${spreadsheetId}/values/\${encodeURIComponent(range)}?majorDimension=ROWS&valueRenderOption=UNFORMATTED_VALUE&key=\${apiKey}\`;
      const res=await fetch(endpoint,{cache:'no-store'});
      if(!res.ok)throw new Error('Sheets API '+res.status);
      const json=await res.json();
      if(!json.values||json.values.length<2)throw new Error('Empty sheet');
      departmentData=parseSheetData(json.values);
      updateAPIStatus('connected');
    }

    function parseSheetData(values){
      const headers=values[0].map(h=>h.trim().toLowerCase());
      return values.slice(1).map((row,i)=>{
        const get=name=>row[headers.indexOf(name)]||'';
        const score=parseFloat(get('overall score'))||0;
        const eff=parseFloat(get('efficiency'))||0;
        const inv=parseFloat(get('innovation'))||0;
        const sat=parseFloat(get('satisfaction'))||0;
        const change=get('change')||'0%';
        const status=score>=85?'excellent':score>=75?'good':score>=65?'average':'poor';
        return{ id:i+1,name:get('department'),score,efficiency:eff,innovation:inv,satisfaction:sat,change,status,trend:change.includes('+')?'up':'down'};
      }).sort((a,b)=>b.score-a.score).map((d,idx)=>({...d,rank:idx+1}));
    }

    /* ---------- FALLBACK SAMPLE ---------- */
    function getSampleData(){return[
      {id:1,name:'Housing & Urban Affairs',score:87.03,efficiency:92.5,innovation:88.2,satisfaction:85.7,change:'+2.5%',status:'excellent',trend:'up'},
      {id:2,name:'Petroleum & Natural Gas',score:83.56,efficiency:89.1,innovation:82.3,satisfaction:79.8,change:'+1.2%',status:'excellent',trend:'up'},
      {id:3,name:'Youth Affairs',score:83.25,efficiency:91.2,innovation:85.1,satisfaction:73.4,change:'+3.1%',status:'good',trend:'up'},
      {id:4,name:'Food & Public Distribution',score:79.98,efficiency:85.7,innovation:74.2,satisfaction:80,change:'-0.5%',status:'good',trend:'down'},
      {id:5,name:'Pharmaceuticals',score:79.43,efficiency:83.2,innovation:88.5,satisfaction:66.6,change:'+1.8%',status:'good',trend:'up'}
    ].map((d,idx)=>({...d,rank:idx+1}))}

    /* ---------- STATUS ---------- */
    function updateAPIStatus(status){
      const el=document.getElementById('apiStatus'),ind=document.getElementById('statusIndicator'),txt=document.getElementById('statusText');
      el.className='api-status '+status;
      if(status==='connected'){ind.className='status-indicator status-excellent';txt.textContent='Google Sheets Connected'}
      else if(status==='connecting'){ind.className='status-indicator status-good';txt.textContent='Connecting‚Ä¶'}
      else{ind.className='status-indicator status-poor';txt.textContent='Offline ‚Äì sample data'}
    }

    /* ---------- UI BUILDERS ---------- */
    function setupFilters(){
      const sel=document.getElementById('departmentFilter');
      sel.innerHTML='<option value="">All Departments</option>';
      departmentData.forEach(d=>{sel.innerHTML+=\`<option value="\${d.id}">\${d.name}</option>\`});
    }

    function setupDepartmentCards(){
      const container=document.getElementById('departmentCards');container.innerHTML='';
      departmentData.slice(0,8).forEach((d,i)=>{
        const card=document.createElement('div');
        card.className='department-card';card.style.background=\`var(--\${['primary','accent','success','warning'][i%4]}-gradient)\`;
        card.onclick=()=>selectDepartment(d.id);
        card.innerHTML=\`
          <div class="department-rank rank-\${d.rank<=3?d.rank:''}">\${d.rank}</div>
          <h4 class="font-bold text-lg">\${d.name}</h4>
          <div class="flex justify-between items-center"><span>Score</span><span>\${d.score.toFixed(1)}</span></div>
          <div class="score-bar"><div class="score-fill" style="width:\${d.score}%"></div></div>
          <div class="flex justify-between items-center mt-2">
            <span class="status-indicator status-\${d.status}"></span>
            <span class="\${d.trend==='up'?'text-green-300':'text-red-300'}"><i class="fas fa-arrow-\${d.trend}"></i>\${d.change}</span>
          </div>\`;
        container.appendChild(card);
      });
    }

    /* ---------- KPI ---------- */
    function updateKPIs(deptId){
      const overall=!deptId,dept=departmentData.find(d=>d.id===deptId);
      const avgScore=departmentData.reduce((s,d)=>s+d.score,0)/departmentData.length;
      const avgEff=departmentData.reduce((s,d)=>s+d.efficiency,0)/departmentData.length;
      const vals=overall?[avgScore,departmentData.length,avgEff,departmentData.length]:[dept.score,'#'+dept.rank,dept.efficiency,departmentData.length];
      ['kpiValue1','kpiValue2','kpiValue3','kpiValue4'].forEach((id,i)=>{
        document.getElementById(id).textContent=(i===2?vals[i]+'%':vals[i].toFixed?vals[i].toFixed(1):vals[i]);
      });
      ['kpiChange1','kpiChange2','kpiChange3','kpiChange4'].forEach((cid,i)=>{
        document.getElementById(cid).innerHTML=overall?'<i class="fas fa-arrow-up"></i>+2.1%':(i===1?'<i class="fas fa-arrow-'+dept.trend+'"></i>Rank '+dept.rank:'<i class="fas fa-arrow-'+dept.trend+'"></i>'+dept.change);
      });
    }

    /* ---------- CHARTS ---------- */
    function setupCharts(){
      const commonOpts={responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},datalabels:{display:false}},scales:{y:{beginAtZero:true,grid:{color:'rgba(255,255,255,.1)'}},x:{grid:{color:'rgba(255,255,255,.1)'}}}};
      // Bar
      charts.ranking=new Chart(document.getElementById('rankingChart'),{
        type:'bar',
        data:{labels:departmentData.slice(0,8).map(d=>d.name),datasets:[{label:'Overall Score',data:departmentData.slice(0,8).map(d=>d.score),backgroundColor:'rgba(102,126,234,.8)',borderColor:'#667eea',borderWidth:2,borderRadius:8,borderSkipped:false}]},
        options:{...commonOpts,plugins:{...commonOpts.plugins,datalabels:{color:'#fff',anchor:'end',align:'top',formatter:v=>v.toFixed(1)}}}
      });
      // Line
      const m=['Jan','Feb','Mar','Apr','May','Jun'],base=departmentData[0];
      charts.performance=new Chart(document.getElementById('performanceChart'),{
        type:'line',
        data:{labels:m,datasets:[
          {label:'Overall Score',data:[75,78,82,85,83,base.score],borderColor:'#60a5fa',backgroundColor:'rgba(96,165,250,.1)',fill:true,tension:.4,borderWidth:3,pointBackgroundColor:'#60a5fa',pointBorderColor:'#fff',pointRadius:6},
          {label:'Efficiency',data:[70,73,77,82,85,base.efficiency],borderColor:'#f093fb',backgroundColor:'rgba(240,147,251,.1)',fill:true,tension:.4,borderWidth:3,pointBackgroundColor:'#f093fb',pointBorderColor:'#fff',pointRadius:6}
        ]},
        options:{...commonOpts,plugins:{legend:{position:'top',labels:{padding:20,usePointStyle:true,font:{size:12}}},datalabels:{display:false}}}
      });
      // Radar
      const top3=departmentData.slice(0,3),cols=['#667eea','#f093fb','#4facfe'];
      charts.comparison=new Chart(document.getElementById('comparisonChart'),{
        type:'radar',
        data:{labels:['Overall','Efficiency','Innovation','Satisfaction'],datasets:top3.map((d,i)=>({label:d.name,data:[d.score,d.efficiency,d.innovation,d.satisfaction],borderColor:cols[i],backgroundColor:cols[i].replace(')',' ,.2)'),borderWidth:2,pointBackgroundColor:cols[i],pointBorderColor:'#fff',pointBorderWidth:2}))},
        options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{padding:20,usePointStyle:true,font:{size:12}}}},scales:{r:{beginAtZero:true,max:100,grid:{color:'rgba(255,255,255,.1)'},angleLines:{color:'rgba(255,255,255,.1)'},pointLabels:{color:'#fff',font:{size:12}}}}}
      });
    }

    /* ---------- TABLE ---------- */
    function populateRankingTable(){
      const tbody=document.getElementById('rankingTableBody');tbody.innerHTML='';
      departmentData.forEach(d=>{
        const tr=document.createElement('tr');
        tr.innerHTML=\`
          <td>\${d.rank}</td><td>\${d.name}</td><td>\${d.score.toFixed(1)}</td>
          <td>\${d.efficiency.toFixed(1)}%</td><td>\${d.innovation.toFixed(1)}%</td><td>\${d.satisfaction.toFixed(1)}%</td>
          <td><span class="status-indicator status-\${d.status}"></span> \${d.status}</td>
          <td class="\${d.trend==='up'?'text-green-300':'text-red-300'}"><i class="fas fa-arrow-\${d.trend}"></i>\${d.change}</td>
          <td><button class="text-blue-400 mr-2" onclick="viewDetails(\${d.id})"><i class="fas fa-eye"></i></button><button class="text-green-400" onclick="exportDept(\${d.id})"><i class="fas fa-download"></i></button></td>\`;
        tbody.appendChild(tr);
      });
    }

    /* ---------- INTERACTIONS ---------- */
    function selectDepartment(id){selectedDepartment=id;document.querySelectorAll('.department-card').forEach(c=>c.classList.toggle('selected',c.onclick.toString().includes('('+id+')')));updateKPIs(id);updateChartsForDept(id);document.getElementById('departmentFilter').value=id;showNotification('Selected department #'+id,'info')}
    function updateChartsForDept(id){const d=departmentData.find(x=>x.id===id);if(!d)return;charts.performance.data.datasets[0].data=[d.score-15,d.score-10,d.score-5,d.score-2,d.score+1,d.score];charts.performance.data.datasets[1].data=[d.efficiency-12,d.efficiency-8,d.efficiency-4,d.efficiency-1,d.efficiency+2,d.efficiency];charts.performance.update()}
    function filterByDepartment(){const id=+document.getElementById('departmentFilter').value;if(id)selectDepartment(id);else{selectedDepartment=null;updateKPIs();document.querySelectorAll('.department-card').forEach(c=>c.classList.remove('selected'))}}
    function filterByTime(){showNotification('Time filter changed','info')}
    function searchDepartments(){const t=document.getElementById('searchInput').value.toLowerCase();document.querySelectorAll('#rankingTableBody tr').forEach(r=>r.style.display=r.cells[1].textContent.toLowerCase().includes(t)?'':'none')}
    function sortTable(){const b=document.getElementById('rankingTableBody');Array.from(b.children).sort((a,b)=>parseFloat(b.cells[2].textContent)-parseFloat(a.cells[2].textContent)).forEach(r=>b.appendChild(r));showNotification('Table sorted by score','success')}
    function updateRankingChart(){const metric=document.getElementById('rankingMetric').value;const map={'efficiency':'Efficiency','innovation':'Innovation','satisfaction':'Satisfaction','overall':'Overall Score'};const data=departmentData.slice(0,8).map(d=>metric==='efficiency'?d.efficiency:metric==='innovation'?d.innovation:metric==='satisfaction'?d.satisfaction:d.score);charts.ranking.data.datasets[0].data=data;charts.ranking.data.datasets[0].label=map[metric];charts.ranking.update()}

    /* ---------- REFRESH ---------- */
    async function refreshData(){if(Date.now()-lastRefresh<100)return;lastRefresh=Date.now();showLoading(true);try{await loadDataFromGoogleSheets();setupFilters();setupDepartmentCards();updateKPIs(selectedDepartment);populateRankingTable();Object.values(charts).forEach(c=>c.destroy());setupCharts();showNotification('Data refreshed','success')}catch{showNotification('Refresh failed','error')}showLoading(false)}

    /* ---------- LIVE FEED ---------- */
    function setupLiveFeed(){const feed=document.getElementById('performanceFeed');feed.innerHTML=[{icon:'fa-trophy',text:'Housing leads ranking',time:'2m ago',type:'success'},{icon:'fa-chart-line',text:'Efficiency +5%',time:'5m ago',type:'info'},{icon:'fa-bell',text:'New data available',time:'8m ago',type:'warning'},{icon:'fa-sync-alt',text:'Sync complete',time:'12m ago',type:'success'}].map(u=>\`<div class="flex items-center gap-3 p-3 rounded-lg bg-white bg-opacity-10"><i class="fas \${u.icon} text-\${u.type==='success'?'green':u.type==='warning'?'yellow':'blue'}-400"></i><div><div class="font-medium">\${u.text}</div><div class="text-sm opacity-60">\${u.time}</div></div></div>\`).join('')}

    /* ---------- EXPORT ---------- */
    function exportData(){const rows=departmentData.map(d=>\`\${d.rank},"${d.name}",\${d.score},\${d.efficiency},\${d.innovation},\${d.satisfaction},"${d.change}"\`);const csv=['Rank,Department,Score,Efficiency,Innovation,Satisfaction,Change',...rows].join('\\n');downloadCSV(csv,'department_rankings.csv');showNotification('All data exported','success')}
    function exportDept(id){const d=departmentData.find(x=>x.id===id);const csv=['Metric,Value',\`Department,"${d.name}"\`,\`Rank,\${d.rank}\`,\`Score,\${d.score}\`,\`Efficiency,\${d.efficiency}\`,\`Innovation,\${d.innovation}\`,\`Satisfaction,\${d.satisfaction}\`,\`Change,"${d.change}"\`].join('\\n');downloadCSV(csv,d.name.replace(/\\s+/g,'_')+'.csv');showNotification(d.name+' exported','success')}
    function downloadCSV(csv,filename){const uri='data:text/csv;charset=utf-8,'+encodeURIComponent(csv);const link=document.createElement('a');link.href=uri;link.download=filename;document.body.appendChild(link);link.click();document.body.removeChild(link)}

    /* ---------- MISC ---------- */
    function showUploadModal(){showNotification('Upload feature coming soon','info')}
    function viewDetails(id){selectDepartment(id);showNotification('Viewing details for department '+id,'info')}
    function showLoading(show){isDataLoading=show;document.querySelectorAll('.interactive-btn').forEach(btn=>{if(show){btn.innerHTML='<div class="animate-spin h-5 w-5 border-2 border-white border-t-transparent rounded-full"></div>';btn.disabled=true}else{btn.disabled=false;btn.innerHTML=btn.innerHTML.replace(/<.*?>/,'')}})}
    function showNotification(msg,type='info'){const n=document.createElement('div');n.className='notification';n.innerHTML=\`<i class="fas \${type==='success'?'fa-check-circle':type==='error'?'fa-exclamation-circle':type==='warning'?'fa-exclamation-triangle':'fa-info-circle'} text-\${type==='success'?'green':type==='error'?'red':type==='warning'?'yellow':'blue'}-400 mr-2"></i>\${msg}\`;document.body.appendChild(n);setTimeout(()=>n.classList.add('show'),100);setTimeout(()=>{n.classList.remove('show');setTimeout(()=>document.body.removeChild(n),300)},3000)}
    function toggleSidebar(){document.getElementById('sidebar').classList.toggle('open')}
    function toggleDarkMode(){showNotification('Dark-mode toggle clicked','info')}
    function navigateTo(id){document.getElementById(id).scrollIntoView({behavior:'smooth'});toggleSidebar()}

    /* ---------- AUTO REFRESH (5 min) ---------- */
    setInterval(()=>{if(!isDataLoading)refreshData()},300000);
  </script>
</body>
</html>
