<!DOCTYPE html>
<html lang="mr">
<head>
  <meta charset="UTF-8">
  <title>‡§§‡§æ‡§≤‡•Å‡§ï‡§æ ‡§Ø‡•ã‡•Ö‡§∂‡§¨‡•ã‡§∞‡•ç‡§° ‚Äì ‡§ú‡§≥‡§ó‡§æ‡§µ ‡§ú‡§ø‡§≤‡•ç‡§π‡§æ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@500;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <style>
    body { font-family: 'Noto Sans Devanagari', sans-serif; background: #f8fafc; color: #1f2937; margin:0; padding:0.8rem;}
    .glass { background: #fff; border-radius: 10px; box-shadow: 0 2px 8px rgba(99,102,241,0.1); margin-bottom: 1rem; padding:0.8rem;}
    
    /* Main Dashboard Layout - 30%-35%-35% */
    .dashboard-3col { display: flex; gap: 0.8rem; height: 420px; }
    .kpi-col { flex: 0 0 30%; background: #f8fafc; border-radius: 8px; padding: 0.5rem; overflow-y: auto;}
    .chart-col { flex: 0 0 35%; background: #f8fafc; border-radius: 8px; padding: 0.4rem; display: flex; flex-direction: column;}
    .donut-col { flex: 0 0 35%; background: #f8fafc; border-radius: 8px; padding: 0.4rem; display: flex; flex-direction: column;}
    
    /* Compact KPI Cards */
    .kpi-card { border-radius: 6px; text-align: center; font-size: 0.85em; font-weight: 600; margin: 0.2rem 0; padding: 0.3rem 0.2rem; cursor: pointer; transition: all 0.2s; border: 1px solid transparent;}
    .kpi-card:hover { transform: scale(1.02); border-color: #6366f1; box-shadow: 0 2px 8px rgba(99,102,241,0.2);}
    .kpi-card.top { background: linear-gradient(90deg,#10b981,#6ee7b7); color: white;}
    .kpi-card.mid { background: linear-gradient(90deg,#f59e0b,#fbbf24); color: white;}
    .kpi-card.bot { background: linear-gradient(90deg,#ef4444,#f87171); color: white;}
    .kpi-rank { font-size: 0.9em; font-weight: 700;}
    .kpi-name { font-size: 0.95em; margin: 2px 0;}
    .kpi-score { font-size: 1.1em; font-weight: 800;}
    
    /* Charts */
    .chart-container { flex: 1; height: calc(100% - 60px); min-height: 200px;}
    .chart-header { font-size: 0.9em; font-weight: 700; color: #6366f1; margin-bottom: 0.3rem; text-align: center;}
    
    /* Department Chips */
    .dept-chip { display: inline-block; padding: 4px 8px; border-radius: 15px; font-size: 0.85em; background: #e0e7ff; margin: 2px 4px; color: #3730a3; font-weight: 600; cursor: pointer; transition: all 0.15s; border: 1px solid transparent;}
    .dept-chip:hover, .dept-chip.selected { background: #fbbf24; color: #92400e; border-color: #f59e0b; transform: scale(1.05);}
    
    /* Date Controls */
    .date-controls { background: #f1f5f9; padding: 0.5rem; border-radius: 6px; margin-bottom: 0.8rem;}
    
    /* Progress Categories */
    .progress-section { margin: 0.5rem 0; padding: 0.4rem; border-radius: 6px; font-size: 0.85em;}
    .progress-excellent { background: #d1fae5; border-left: 4px solid #10b981;}
    .progress-needs { background: #fef3c7; border-left: 4px solid #f59e0b;}
    .progress-attention { background: #fee2e2; border-left: 4px solid #ef4444;}
    
    /* Buttons */
    .btn-compact { padding: 0.25rem 0.5rem; font-size: 0.8em; margin: 0.1rem;}
    
    /* Table */
    .table { font-size: 0.85em;}
    .table thead th { background: #6366f1; color: white; padding: 0.4rem; text-align: center;}
    .table tbody td { padding: 0.3rem 0.2rem; text-align: center; border: 1px solid #e5e7eb;}
    .table tbody tr.selected-block td { background: #dbeafe !important; font-weight: 700;}
    .table tbody tr.top5 td { background: #d1fae5 !important;}
    .table tbody tr.mid5 td { background: #fef3c7 !important;}
    .table tbody tr.bot5 td { background: #fee2e2 !important;}
    
    @media (max-width: 1200px) { 
      .dashboard-3col { flex-direction: column; height: auto;}
      .kpi-col, .chart-col, .donut-col { flex: none; height: 300px;}
    }
  </style>
</head>
<body>
<div class="container-fluid">
  <h2 class="text-center mb-2">üìä ‡§§‡§æ‡§≤‡•Å‡§ï‡§æ ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§§‡•Å‡§≤‡§®‡§æ‡§§‡•ç‡§Æ‡§ï ‡§°‡•Ö‡§∂‡§¨‡•ã‡§∞‡•ç‡§°<br>
    <small class="text-muted">(‡§ú‡§≥‡§ó‡§æ‡§µ ‡§ú‡§ø‡§≤‡•ç‡§π‡§æ)</small>
  </h2>
  
  <!-- Date Range Controls for Backdated Reports -->
  <div class="glass">
    <div class="date-controls">
      <div class="row g-2 align-items-center">
        <div class="col-md-3">
          <label class="form-label">üìÖ ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§™‡§æ‡§∏‡•Ç‡§®:</label>
          <input type="date" id="startDate" class="form-control form-control-sm">
        </div>
        <div class="col-md-3">
          <label class="form-label">üìÖ ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§™‡§∞‡•ç‡§Ø‡§Ç‡§§:</label>
          <input type="date" id="endDate" class="form-control form-control-sm">
        </div>
        <div class="col-md-3">
          <label class="form-label">‡§Ø‡•ã‡§ú‡§®‡§æ ‡§®‡§ø‡§µ‡§°‡§æ:</label>
          <select id="schemeSelect" multiple class="form-select form-select-sm" size="4">
            <option value="__all__" style="font-weight:bold;">‡§∏‡§∞‡•ç‡§µ ‡§Ø‡•ã‡§ú‡§®‡§æ</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">‡§§‡§æ‡§≤‡•Å‡§ï‡§æ ‡§®‡§ø‡§µ‡§°‡§æ:</label>
          <div id="talukaChips" class="mt-1"></div>
          <button id="resetBtn" class="btn btn-outline-danger btn-compact mt-1">Reset</button>
          <button id="submitBtn" class="btn btn-primary btn-compact mt-1">Submit</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Dashboard with 30%-35%-35% Layout -->
  <div class="glass">
    <div class="dashboard-3col">
      <!-- KPI Column (30%) -->
      <div class="kpi-col">
        <div class="chart-header">üèÜ ‡§§‡§æ‡§≤‡•Å‡§ï‡§æ ‡§∞‡§Å‡§ï‡§ø‡§Ç‡§ó</div>
        <div id="kpiCol"></div>
        
        <!-- Progress Categories Section -->
        <div id="progressCategories" class="mt-3"></div>
      </div>
      
      <!-- Bar Chart Column (35%) -->
      <div class="chart-col">
        <div class="chart-header">üìä Bar Chart</div>
        <div class="chart-container">
          <canvas id="barChart"></canvas>
        </div>
        <button id="downloadBarBtn" class="btn btn-success btn-compact">‚¨áÔ∏è Bar Chart</button>
      </div>
      
      <!-- Donut Chart Column (35%) -->
      <div class="donut-col">
        <div class="chart-header">üç© Donut Chart</div>
        <div class="chart-container">
          <canvas id="donutChart"></canvas>
        </div>
        <button id="downloadDonutBtn" class="btn btn-warning btn-compact">‚¨áÔ∏è Donut Chart</button>
      </div>
    </div>
  </div>

  <!-- Detailed Table -->
  <div class="glass">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h6 class="mb-0 text-primary">üìã ‡§§‡§æ‡§≤‡•Å‡§ï‡•ç‡§Ø‡§æ‡§Ç‡§ö‡•Ä ‡§∏‡§Ç‡§™‡•Ç‡§∞‡•ç‡§£ ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä</h6>
      <button id="downloadCsvBtn" class="btn btn-secondary btn-compact">üìä CSV</button>
    </div>
    <div class="table-responsive">
      <table class="table table-bordered mb-0" id="dataTable">
        <thead><tr id="tableHeader"></tr></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
const CONFIG = {
  apiKey: "AIzaSyDhCjnUv7x5yj9cXKV52Qv8CrYwUhBIWuU",
  spreadsheetId: "1y_EVqNg-reS3xV-Kn6cmTou7u_6kuyqykNdgdzXEMkE",
  range: "Rank!B5:AJ20"
};

let rawData=[], headers=[], blocks=[], schemes=[];
let barChart, donutChart;
const selectedBlocks = new Set(), selectedSchemes = new Set();

async function fetchSheet() {
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.spreadsheetId}/values/${encodeURIComponent(CONFIG.range)}?majorDimension=ROWS&valueRenderOption=UNFORMATTED_VALUE&key=${CONFIG.apiKey}`;
  const res = await fetch(url);
  if (!res.ok) throw Error(res.statusText);
  return (await res.json()).values;
}

function parse(values) {
  headers = values[0];
  const idxBlock = headers.findIndex(h => /‡§§‡§æ‡§≤‡•Å‡§ï‡§æ/i.test(h));
  blocks = values.slice(1).map(r => {
    const obj = {}; 
    headers.forEach((h,i) => obj[h] = r[i]); 
    obj._block = r[idxBlock]; 
    return obj;
  });
  schemes = headers.filter((_,i) => i !== idxBlock);
  rawData = blocks;
}

function renderControls() {
  // Set default dates (last 30 days)
  const today = new Date();
  const lastMonth = new Date(today);
  lastMonth.setDate(today.getDate() - 30);
  document.getElementById('endDate').value = today.toISOString().split('T')[0];
  document.getElementById('startDate').value = lastMonth.toISOString().split('T')[0];
  
  // Schemes dropdown
  const schemeSel = document.getElementById('schemeSelect');
  schemeSel.innerHTML = `<option value="__all__" style="font-weight:bold;">‡§∏‡§∞‡•ç‡§µ ‡§Ø‡•ã‡§ú‡§®‡§æ</option>` 
        + schemes.map(s => `<option value="${s}">${s}</option>`).join('');
  
  schemeSel.addEventListener('change', () => {
    const val = Array.from(schemeSel.selectedOptions).map(o => o.value);
    const allSelected = val.includes('__all__');
    if(allSelected) {
      for (let option of schemeSel.options) 
        if (option.value !== '__all__') option.selected = true;
    }
    const allActual = Array.from(schemeSel.options).filter(o => o.value !== "__all__" && o.selected);
    schemeSel.querySelector('option[value="__all__"]').selected = (allActual.length === schemes.length);
  });

  // Taluka chips
  const talukaDiv = document.getElementById('talukaChips');
  talukaDiv.innerHTML = blocks.map(b => `
    <span class="dept-chip" data-block="${b._block}">${b._block}</span>
  `).join('');
  
  talukaDiv.querySelectorAll('.dept-chip').forEach(span => {
    span.onclick = () => {
      const name = span.getAttribute('data-block');
      if(selectedBlocks.has(name)) { 
        selectedBlocks.delete(name); 
        span.classList.remove('selected');
      } else {
        selectedBlocks.add(name); 
        span.classList.add('selected');
      }
    };
  });

  // Event listeners
  document.getElementById('resetBtn').onclick = resetAll;
  document.getElementById('submitBtn').onclick = updateAll;
  document.getElementById('downloadBarBtn').onclick = () => barChart && downloadChart(barChart, "bar-chart.png");
  document.getElementById('downloadDonutBtn').onclick = () => donutChart && downloadChart(donutChart, "donut-chart.png");
  document.getElementById('downloadCsvBtn').onclick = downloadCSV;
}

function resetAll() {
  selectedBlocks.clear(); 
  selectedSchemes.clear();
  document.querySelectorAll('.dept-chip').forEach(span => span.classList.remove('selected'));
  document.getElementById('schemeSelect').selectedIndex = -1;
  clearDashboard();
  showAllDefault();
}

function collectSelections() {
  selectedBlocks.clear();
  document.querySelectorAll('.dept-chip.selected').forEach(el => 
    selectedBlocks.add(el.getAttribute('data-block'))
  );
  
  selectedSchemes.clear();
  Array.from(document.getElementById('schemeSelect').selectedOptions).forEach(opt => {
    if(opt.value === "__all__") {
      schemes.forEach(s => selectedSchemes.add(s));
    } else {
      selectedSchemes.add(opt.value);
    }
  });
}

// FIXED: Correct KPI ranking logic - highest performers at top
function getBestTalukasByOverallRank() {
  // Calculate overall ranking based on average position across all schemes
  const talukaOverallRanks = rawData.map(taluka => {
    let totalRank = 0;
    let schemeCount = 0;
    
    schemes.forEach(scheme => {
      // Get all talukas sorted by this scheme (highest score first)
      const sortedByScheme = rawData.slice().sort((a,b) => 
        (parseFloat(b[scheme]) || 0) - (parseFloat(a[scheme]) || 0)
      );
      
      const rank = sortedByScheme.findIndex(t => t._block === taluka._block) + 1;
      if(rank > 0) {
        totalRank += rank;
        schemeCount++;
      }
    });
    
    return {
      _block: taluka._block,
      avgRank: schemeCount > 0 ? totalRank / schemeCount : 999,
      topPositions: schemes.filter(scheme => {
        const sortedByScheme = rawData.slice().sort((a,b) => 
          (parseFloat(b[scheme]) || 0) - (parseFloat(a[scheme]) || 0)
        );
        return sortedByScheme.findIndex(t => t._block === taluka._block) === 0;
      }).length
    };
  }).sort((a,b) => a.avgRank - b.avgRank); // Sort by best average rank (lowest number)
  
  return talukaOverallRanks;
}

function compute() {
  collectSelections();
  const schemesArr = selectedSchemes.size ? Array.from(selectedSchemes) : schemes.slice();
  const blocksArr = selectedBlocks.size ? 
    Array.from(selectedBlocks).map(b => rawData.find(r => r._block === b)).filter(Boolean) : 
    rawData.slice();
  
  // Get best talukas by overall performance (FIXED LOGIC)
  const overallRanks = getBestTalukasByOverallRank();
  
  // For KPI display, use first selected scheme or calculate composite score
  const kpiScheme = schemesArr.length ? schemesArr[0] : schemes[0];
  
  let kpiData = blocksArr.map(r => {
    const overallRank = overallRanks.find(or => or._block === r._block);
    return {
      _block: r._block,
      val: kpiScheme ? (parseFloat(r[kpiScheme]) || 0) : 0,
      avgRank: overallRank ? overallRank.avgRank : 999,
      topPositions: overallRank ? overallRank.topPositions : 0
    };
  });
  
  // Sort by overall performance (best average rank first)
  kpiData.sort((a,b) => a.avgRank - b.avgRank);
  kpiData.forEach((d,i) => d.rank = i + 1);
  
  return { blocksArr, kpiData, schemesArr, kpiScheme };
}

function renderKPI(data) {
  if(!data || !data.kpiData.length) { 
    document.getElementById('kpiCol').innerHTML = ""; 
    return; 
  }
  
  let out = "";
  const kpiData = data.kpiData;
  
  // Top performer
  if(kpiData[0]) {
    out += `<div class="kpi-card top" onclick="showTalukaAnalysis('${kpiData[0]._block}')">
      <div class="kpi-rank">üèÜ #${kpiData[0].rank}</div>
      <div class="kpi-name">${kpiData[0]._block}</div>
      <div class="kpi-score">${kpiData[0].val}</div>
    </div>`;
  }
  
  // Middle performer
  if(kpiData.length > 2) {
    const mid = kpiData[Math.floor(kpiData.length/2)];
    out += `<div class="kpi-card mid" onclick="showTalukaAnalysis('${mid._block}')">
      <div class="kpi-rank">‚öñÔ∏è #${mid.rank}</div>
      <div class="kpi-name">${mid._block}</div>
      <div class="kpi-score">${mid.val}</div>
    </div>`;
  }
  
  // Bottom performer
  if(kpiData.length > 1) {
    const last = kpiData[kpiData.length - 1];
    out += `<div class="kpi-card bot" onclick="showTalukaAnalysis('${last._block}')">
      <div class="kpi-rank">üö® #${last.rank}</div>
      <div class="kpi-name">${last._block}</div>
      <div class="kpi-score">${last.val}</div>
    </div>`;
  }
  
  document.getElementById('kpiCol').innerHTML = out;
}

// Enhanced Taluka Analysis with Progress Categories
window.showTalukaAnalysis = function(talukaName) {
  if(!talukaName) return;
  
  const assessments = schemes.map(scheme => {
    const ranks = rawData.map(r => ({
      taluka: r._block, 
      val: parseFloat(r[scheme]) || 0
    })).sort((a,b) => b.val - a.val);
    
    const rankObj = ranks.find(x => x.taluka === talukaName);
    const rank = rankObj ? ranks.indexOf(rankObj) + 1 : null;
    
    return { 
      scheme, 
      rank: rank, 
      score: rankObj ? rankObj.val : 0,
      total: rawData.length
    };
  }).filter(a => a.rank).sort((a,b) => a.rank - b.rank);
  
  const excellent = assessments.filter(a => a.rank <= 3);
  const needsWork = assessments.filter(a => a.rank > 3 && a.rank <= Math.ceil(assessments.length * 0.7));
  const attention = assessments.filter(a => a.rank > Math.ceil(assessments.length * 0.7));
  
  let report = `‡§§‡§æ‡§≤‡•Å‡§ï‡§æ: ${talukaName}\n\n`;
  
  if(excellent.length) {
    report += "üèÜ ‡§™‡•ç‡§∞‡§ó‡§§‡•Ä ‡§Ö‡§∏‡§≤‡•á‡§≤‡•á ‡§µ‡§ø‡§∑‡§Ø (Top 3):\n";
    report += excellent.map(a => `${a.scheme}: ‡§∞‡§Å‡§ï ${a.rank}/${a.total} (${a.score})`).join('\n') + '\n\n';
  }
  
  if(needsWork.length) {
    report += "‚öñÔ∏è ‡§™‡•ç‡§∞‡§ó‡§§‡•Ä ‡§ï‡§∞‡§£‡•á ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§Ö‡§∏‡§≤‡•á‡§≤‡•á ‡§µ‡§ø‡§∑‡§Ø:\n";
    report += needsWork.map(a => `${a.scheme}: ‡§∞‡§Å‡§ï ${a.rank}/${a.total} (${a.score})`).join('\n') + '\n\n';
  }
  
  if(attention.length) {
    report += "üö® ‡§µ‡§ø‡§∂‡•á‡§∑ ‡§≤‡§ï‡•ç‡§∑ ‡§¶‡•á‡§£‡•ç‡§Ø‡§æ‡§ö‡•á ‡§µ‡§ø‡§∑‡§Ø:\n";
    report += attention.map(a => `${a.scheme}: ‡§∞‡§Å‡§ï ${a.rank}/${a.total} (${a.score})`).join('\n');
  }
  
  alert(report);
  
  // Also update progress categories display
  renderProgressCategories(talukaName, excellent, needsWork, attention);
};

function renderProgressCategories(talukaName, excellent, needsWork, attention) {
  if(!talukaName) {
    document.getElementById('progressCategories').innerHTML = "";
    return;
  }
  
  let out = `<div class="mt-2"><strong>${talukaName} - ‡§™‡•ç‡§∞‡§ó‡§§‡•Ä ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£:</strong></div>`;
  
  if(excellent.length) {
    out += `<div class="progress-section progress-excellent">
      <strong>üèÜ ‡§™‡•ç‡§∞‡§ó‡§§‡•Ä ‡§Ö‡§∏‡§≤‡•á‡§≤‡•á ‡§µ‡§ø‡§∑‡§Ø (${excellent.length})</strong><br>
      ${excellent.map(a => `${a.scheme} (#${a.rank})`).join(', ')}
    </div>`;
  }
  
  if(needsWork.length) {
    out += `<div class="progress-section progress-needs">
      <strong>‚öñÔ∏è ‡§™‡•ç‡§∞‡§ó‡§§‡•Ä ‡§ï‡§∞‡§£‡•á ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï (${needsWork.length})</strong><br>
      ${needsWork.map(a => `${a.scheme} (#${a.rank})`).join(', ')}
    </div>`;
  }
  
  if(attention.length) {
    out += `<div class="progress-section progress-attention">
      <strong>üö® ‡§µ‡§ø‡§∂‡•á‡§∑ ‡§≤‡§ï‡•ç‡§∑ ‡§¶‡•á‡§£‡•ç‡§Ø‡§æ‡§ö‡•á (${attention.length})</strong><br>
      ${attention.map(a => `${a.scheme} (#${a.rank})`).join(', ')}
    </div>`;
  }
  
  document.getElementById('progressCategories').innerHTML = out;
}

function renderBar(data) {
  const ctx = document.getElementById('barChart').getContext('2d');
  barChart?.destroy();
  
  barChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: data.kpiData.map(d => d._block),
      datasets: [{
        label: data.kpiScheme,
        data: data.kpiData.map(d => d.val),
        backgroundColor: '#6366f1',
        borderRadius: 4
      }]
    },
    options: {
      indexAxis: 'y',
      plugins: { 
        legend: { display: false }, 
        datalabels: { 
          anchor: 'end', 
          align: 'right', 
          formatter: v => v,
          font: { size: 10 }
        }
      },
      responsive: true,
      maintainAspectRatio: false
    },
    plugins: [ChartDataLabels]
  });
}

function renderDonut(data) {
  const ctx = document.getElementById('donutChart').getContext('2d');
  donutChart?.destroy();
  
  donutChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: data.kpiData.map(d => d._block),
      datasets: [{
        data: data.kpiData.map(d => d.val),
        backgroundColor: [
          '#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#3b82f6',
          '#818cf8', '#f472b6', '#2dd4bf', '#facc15', '#eab308'
        ]
      }]
    },
    options: {
      plugins: {
        legend: { position: 'bottom' },
        datalabels: { 
          formatter: v => v,
          font: { size: 9 }
        }
      },
      responsive: true,
      maintainAspectRatio: false
    },
    plugins: [ChartDataLabels]
  });
}

function renderTable(data) {
  const th = `<th>‡§∞‡§Å‡§ï</th>` + headers.map(h => `<th>${h}</th>`).join('');
  document.getElementById('tableHeader').innerHTML = th;
  
  const n = data.kpiData.length;
  const midStart = Math.floor((n - 5) / 2);
  
  const rows = data.kpiData.map((r, i) => {
    const classes = [
      i < 5 ? 'top5' : '',
      i >= n - 5 ? 'bot5' : '',
      i >= midStart && i < midStart + 5 ? 'mid5' : '',
      selectedBlocks.has(r._block) ? 'selected-block' : ''
    ].filter(Boolean).join(' ');
    
    return `<tr class="${classes}">
      <td>${r.rank}</td>
      ${headers.map(h => `<td>${rawData.find(x => x._block === r._block)[h] || ''}</td>`).join('')}
    </tr>`;
  }).join('');
  
  document.getElementById('tableBody').innerHTML = rows;
}

function downloadChart(chart, filename) {
  const a = document.createElement('a');
  a.href = chart.toBase64Image();
  a.download = filename;
  a.click();
}

function downloadCSV() {
  const data = compute();
  if(!data) return;
  
  let csv = '‡§∞‡§Å‡§ï,' + headers.join(',') + '\n' + 
    data.kpiData.map(r => `${r.rank},` + 
      headers.map(h => `"${rawData.find(x => x._block === r._block)[h] || ''}"`).join(',')
    ).join('\n');
  
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; 
  a.download = 'taluka-data.csv'; 
  a.click();
  URL.revokeObjectURL(url);
}

function clearDashboard() {
  document.getElementById('kpiCol').innerHTML = "";
  document.getElementById('progressCategories').innerHTML = "";
  document.getElementById('tableBody').innerHTML = "";
  document.getElementById('tableHeader').innerHTML = "";
  barChart?.destroy(); 
  donutChart?.destroy();
}

function showAllDefault() {
  selectedSchemes.clear(); 
  schemes.forEach(s => selectedSchemes.add(s));
  selectedBlocks.clear(); 
  blocks.forEach(b => selectedBlocks.add(b._block));
  updateAll();
}

function updateAll() {
  const data = compute();
  if(!data || !data.kpiData.length) {
    return alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§ï‡§Æ‡•Ä‡§§ ‡§ï‡§Æ‡•Ä ‡§è‡§ï ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§Ü‡§£‡§ø ‡§§‡§æ‡§≤‡•Å‡§ï‡§æ ‡§®‡§ø‡§µ‡§°‡§æ.");
  }
  
  renderKPI(data);
  renderBar(data);
  renderDonut(data);
  renderTable(data);
}

// Initialize
(async () => {
  try {
    const vals = await fetchSheet();
    parse(vals);
    renderControls();
    showAllDefault();
  } catch (e) {
    alert("‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§°‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§Ö‡§°‡§ö‡§£: " + e.message);
  }
})();
</script>
</body>
</html>
