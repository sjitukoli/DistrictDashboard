<!DOCTYPE html>
<html lang="mr">
<head>
  <meta charset="UTF-8" />
  <title>‡§§‡§æ‡§≤‡•Å‡§ï‡§æ ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§°‡•Ö‡§∂‡§¨‡•ã‡§∞‡•ç‡§° ‚Äì Advanced UI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(to bottom right, #f0f4f8, #ffffff);
      color: #1f2937;
      padding-bottom: 60px;
    }
    .header {
      text-align: center;
      margin: 2rem 0;
    }
    .header h2 {
      font-weight: 800;
      font-size: 2rem;
      color: #1e3a8a;
    }
    .card-glass {
      background: #ffffffdd;
      border-radius: 16px;
      box-shadow: 0 10px 24px rgba(0,0,0,0.06);
      padding: 1.5rem;
      margin-bottom: 2rem;
    }
    .kpi-wrap, .chart-wrap {
      display: flex;
      flex-wrap: wrap;
      gap: 1.2rem;
      justify-content: center;
    }
    .kpi-card {
      flex: 1 1 240px;
      background: #fff;
      border-radius: 12px;
      padding: 1rem;
      text-align: center;
      transition: 0.3s ease;
      box-shadow: 0 4px 14px rgba(0,0,0,0.05);
    }
    .kpi-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.08);
    }
    .kpi-card h5 {
      font-weight: bold;
      font-size: 1.1rem;
      margin-bottom: 0.3rem;
    }
    .kpi-card span { font-size: 0.9rem; color: #555; }
    .top { background: linear-gradient(135deg, #bbf7d0, #22c55e); }
    .mid { background: linear-gradient(135deg, #fef9c3, #eab308); }
    .bot { background: linear-gradient(135deg, #fecaca, #ef4444); }
    .chart-box {
      flex: 1 1 48%;
      padding: 1rem;
      background: #f9fafb;
      border-radius: 12px;
    }
    .form-select, .form-control {
      max-width: 300px;
    }
    .action-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      justify-content: space-between;
      align-items: center;
      margin: 1rem 0;
    }
    .btn-action {
      font-size: 0.9rem;
      font-weight: 600;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      transition: 0.2s ease;
    }
    .btn-action:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .table th, .table td {
      text-align: center;
    }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h2>üìä ‡§§‡§æ‡§≤‡•Å‡§ï‡§æ ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§§‡•Å‡§≤‡§®‡§æ‡§§‡•ç‡§Æ‡§ï ‡§°‡•Ö‡§∂‡§¨‡•ã‡§∞‡•ç‡§°</h2>
  </div>

  <div class="card-glass">
    <div class="d-flex flex-wrap gap-3 align-items-center justify-content-between">
      <div>
        <label class="form-label">‡§Ø‡•ã‡§ú‡§®‡§æ ‡§®‡§ø‡§µ‡§°‡§æ:</label>
        <select id="schemeSelect" class="form-select form-select-sm"></select>
      </div>
      <div>
        <label class="form-label">‡§§‡§æ‡§≤‡•Å‡§ï‡§æ ‡§∂‡•ã‡§ß‡§æ:</label>
        <input type="text" id="searchInput" class="form-control form-control-sm" placeholder="‡§â‡§¶‡§æ. ‡§ú‡§æ‡§Æ‡§®‡•á‡§∞">
      </div>
      <div class="d-flex gap-2">
        <button id="downloadCSV" class="btn btn-outline-secondary btn-action">‚¨áÔ∏è CSV</button>
        <button id="downloadBar" class="btn btn-outline-primary btn-action">üìä Bar Chart</button>
        <button id="downloadDonut" class="btn btn-outline-success btn-action">üç© Donut Chart</button>
      </div>
    </div>
  </div>

  <div class="card-glass">
    <div class="kpi-wrap" id="kpiRow"></div>
  </div>

  <div class="card-glass">
    <div class="chart-wrap">
      <div class="chart-box">
        <h6>Bar Chart</h6>
        <canvas id="barChart"></canvas>
      </div>
      <div class="chart-box">
        <h6>Donut Chart</h6>
        <canvas id="donutChart"></canvas>
      </div>
    </div>
  </div>

  <div class="card-glass">
    <h5 class="mb-3">üìã ‡§§‡§æ‡§≤‡•Å‡§ï‡•ç‡§Ø‡§æ‡§Ç‡§ö‡•Ä ‡§∞‡§Å‡§ï ‡§Ø‡§æ‡§¶‡•Ä</h5>
    <div class="table-responsive">
      <table class="table table-bordered table-sm">
        <thead><tr><th>#</th><th>‡§§‡§æ‡§≤‡•Å‡§ï‡§æ</th><th>‡§∞‡§Å‡§ï</th></tr></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
const CONFIG = {
  apiKey: "AIzaSyDhCjnUv7x5yj9xKV52Qv8CrYwUhBIWuU",
  spreadsheetId: "1y_EVqNg-reS3xV-Kn6cmTou7u_6kuyqykNdgdzXEMkE",
  range: "Rank!B5:AJ20"
};

let rawData = [], headers = [], schemes = [], selectedScheme = "";

async function fetchData() {
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.spreadsheetId}/values/${CONFIG.range}?key=${CONFIG.apiKey}`;
  const res = await fetch(url);
  const data = await res.json();
  headers = data.values[0];
  const blockIndex = headers.findIndex(h => /‡§§‡§æ‡§≤‡•Å‡§ï‡§æ/i.test(h));
  rawData = data.values.slice(1).map(row => {
    let obj = {};
    headers.forEach((h, i) => obj[h] = row[i]);
    obj._block = row[blockIndex];
    return obj;
  });
  schemes = headers.filter((_, i) => i !== blockIndex);
  selectedScheme = schemes[0];
  populateDropdown();
  updateDashboard();
}

function populateDropdown() {
  const sel = document.getElementById('schemeSelect');
  sel.innerHTML = schemes.map(s => `<option value="${s}">${s}</option>`).join('');
  sel.onchange = () => { selectedScheme = sel.value; updateDashboard(); };
}

function getTopRankedTalukas() {
  const tally = {};
  rawData.forEach(row => {
    schemes.forEach(s => {
      if ((row[s] || '') === '1') {
        tally[row._block] = (tally[row._block] || 0) + 1;
      }
    });
  });
  const sorted = Object.entries(tally).sort((a,b) => b[1] - a[1]);
  return sorted.slice(0, 3).map(([taluka, count]) => ({ taluka, count }));
}

function updateDashboard() {
  const rankedData = rawData.map(row => ({
    taluka: row._block,
    rank: parseInt(row[selectedScheme]) || 999
  })).sort((a,b) => a.rank - b.rank);
  renderKPI(rankedData);
  renderCharts(rankedData);
  renderTable(rankedData);
}

function renderKPI(data) {
  const kpiRow = document.getElementById('kpiRow');
  kpiRow.innerHTML = "";
  const top3 = data.slice(0, 3);
  const mid9 = data.slice(Math.floor(data.length/2 - 4), Math.floor(data.length/2 + 5));
  const bottom3 = data.slice(-3);
  const list = [
    ...top3.map(d => ({ ...d, cls: 'top', tag: 'üèÜ Top' })),
    ...mid9.map(d => ({ ...d, cls: 'mid', tag: '‚öñÔ∏è Mid' })),
    ...bottom3.map(d => ({ ...d, cls: 'bot', tag: 'üö® Bottom' })),
  ];
  list.forEach(({ taluka, rank, cls, tag }) => {
    const div = document.createElement('div');
    div.className = `kpi-card ${cls}`;
    div.innerHTML = `<h5>${tag}</h5><span>${taluka}</span><div>Rank: ${rank}</div>`;
    kpiRow.appendChild(div);
  });
}

function renderCharts(data) {
  const labels = data.map(d => d.taluka);
  const values = data.map(d => d.rank);
  window.barChart?.destroy();
  window.donutChart?.destroy();
  window.barChart = new Chart(document.getElementById('barChart'), {
    type: 'bar',
    data: { labels, datasets: [{ label: selectedScheme, data: values, backgroundColor: '#6366f1' }] },
    options: { indexAxis: 'y', plugins: { legend: { display: false } }, responsive: true }
  });
  window.donutChart = new Chart(document.getElementById('donutChart'), {
    type: 'doughnut',
    data: { labels, datasets: [{ data: values }] },
    options: { plugins: { legend: { position: 'bottom' } }, responsive: true }
  });
}

function renderTable(data) {
  const keyword = document.getElementById('searchInput').value.toLowerCase();
  const tbody = document.getElementById('tableBody');
  tbody.innerHTML = data.filter(d => d.taluka.toLowerCase().includes(keyword))
    .map((d, i) => `<tr><td>${i+1}</td><td>${d.taluka}</td><td>${d.rank}</td></tr>`).join('');
}

document.getElementById('searchInput').addEventListener('input', updateDashboard);

document.getElementById('downloadCSV').onclick = function() {
  let csv = `‡§§‡§æ‡§≤‡•Å‡§ï‡§æ,${selectedScheme} Rank\n`;
  rawData.forEach(r => { csv += `${r._block},${r[selectedScheme] || ''}\n`; });
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `${selectedScheme}-ranks.csv`; a.click();
  URL.revokeObjectURL(url);
};

document.getElementById('downloadBar').onclick = () => {
  const a = document.createElement('a');
  a.href = window.barChart.toBase64Image();
  a.download = 'bar-chart.png';
  a.click();
};

document.getElementById('downloadDonut').onclick = () => {
  const a = document.createElement('a');
  a.href = window.donutChart.toBase64Image();
  a.download = 'donut-chart.png';
  a.click();
};

fetchData();
</script>
</body>
</html>
