<!DOCTYPE html>
<html lang="mr">
<head>
  <meta charset="UTF-8">
  <title>‡§§‡§æ‡§≤‡•Å‡§ï‡§æ ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§§‡•Å‡§≤‡§®‡§æ‡§§‡•ç‡§Æ‡§ï ‡§°‡•Ö‡§∂‡§¨‡•ã‡§∞‡•ç‡§° - ‡§ú‡§≥‡§ó‡§æ‡§µ ‡§ú‡§ø‡§≤‡•ç‡§π‡§æ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Tailwind for quick styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js & ChartDataLabels -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.2.0/chartjs-plugin-datalabels.umd.min.js"></script>
  <!-- FontAwesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <style>
    body { background: linear-gradient(135deg,#667eea,#f093fb 72%); color: #222; }
    .kpi-card { border-radius:12px;padding:16px;box-shadow:0 2px 12px 0 rgba(30,30,50,.13);margin-bottom:12px;}
    .kpi-top {background:linear-gradient(90deg,#10b98188 70%,#b6f7d688 120%);}
    .kpi-middle {background:linear-gradient(90deg,#fde68a88 70%,#f5ccb188 120%);}
    .kpi-bottom {background:linear-gradient(90deg,#fca5a588 70%,#feb2b288 120%);}
    .selected {box-shadow:0 0 0 3px #6366f1; font-weight:bold;}
    .kpi-card h3 {font-size:1.1em;margin-bottom:.2em;font-weight:700;}
    .kpi-card .rank {font-weight:700}
    .tag {display:inline-block;background:#f3f4f6;border-radius:99px;font-size:13px;padding:2px 12px;}
    .tag.top{background:#10b981;color:#fff;}
    .tag.mid{background:#f59e0b;color:#fff;}
    .tag.bot{background:#ef4444;color:#fff;}
    .btn {transition:.1s;background:#6366f1;color:#fff; border:0; outline:0; border-radius:6px; padding:.38em 1.1em;font-size:1em; font-weight:600; margin:2px;}
    .btn:hover {background:#4f46e5;}
    .btn2 {background:#2dd4bf;}
    .btn3 {background:#eab308;}
    .btn4 {background:#f43f5e;}
    .checkbox-block {display:inline-block;min-width:100px; margin-right:8px; margin-bottom:6px;}
    .table-auto th, .table-auto td {font-size: 1em;}
    @media (max-width:600px) {
      .kpi-row{flex-direction:column;}
      .checkboxes {flex-direction:column;}
    }
  </style>
</head>
<body class="p-0 m-0">
<main class="max-w-6xl mx-auto px-3 pt-5 pb-12">

  <header class="mb-3">
    <h1 class="text-3xl font-bold text-center mb-0 text-indigo-800">‡§§‡§æ‡§≤‡•Å‡§ï‡§æ ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§§‡•Å‡§≤‡§®‡§æ‡§§‡•ç‡§Æ‡§ï ‡§°‡•Ö‡§∂‡§¨‡•ã‡§∞‡•ç‡§° - ‡§ú‡§≥‡§ó‡§æ‡§µ ‡§ú‡§ø‡§≤‡•ç‡§π‡§æ</h1>
    <p class="text-center text-slate-600 text-md mb-4">‡§∏‡§∞‡•ç‡§µ ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§ü‡§∞‡•ç‡§Æ‡§ø‡§®‡•á‡§ü‡§ø‡§µ ‡§°‡•á‡§ü‡§æ (Live Google Sheets API ‡§µ‡§∞‡•Ç‡§®) ‚Ä¢ ‡§Æ‡§≤‡•ç‡§ü‡•Ä-‡§§‡§æ‡§≤‡•Å‡§ï‡§æ ‡§§‡•Å‡§≤‡§®‡§æ ‚Ä¢ CSV/‡§ö‡§æ‡§∞‡•ç‡§ü ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°</p>
  </header>

  <!-- Taluka Checkbox Selection -->
  <section class="glass-card mb-5 px-4 py-3 border">
    <h2 class="font-bold text-xl mb-1 text-indigo-800 text-center">‡§§‡§æ‡§≤‡•Å‡§ï‡§æ ‡§®‡§ø‡§µ‡§°‡§æ / Comparison (‡§Æ‡§≤‡•ç‡§ü‡•Ä-‡§∏‡•á‡§≤‡•á‡§ï‡•ç‡§ü)</h2>
    <form id="talukaSelector" class="checkboxes flex flex-wrap justify-center mb-2 gap-y-1"></form>
    <button type="button" class="btn btn3 my-1" id="cmpBtn">üßÆ ‡§§‡•Å‡§≤‡§®‡§æ ‡§ï‡§∞‡§æ</button>
    <span id="selectedTalukas" class="ml-3 text-indigo-700 font-bold"></span>
    <button class="btn btn2 ml-3" id="refreshBtn"><i class="fa fa-rotate-right"></i> Refresh</button>
  </section>
  
  <!-- Main Cards -->
  <div class="flex flex-wrap justify-between items-stretch gap-2 mb-6 kpi-row">
    <div class="flex-1 min-w-[180px]">
      <div class="kpi-card kpi-top">
        <h3>Top 5 ‡§§‡§æ‡§≤‡•Å‡§ï‡•á</h3>
        <ul id="top5" class="ml-1 text-lg"></ul>
      </div>
    </div>
    <div class="flex-1 min-w-[180px]">
      <div class="kpi-card kpi-middle">
        <h3>‡§Æ‡§ß‡•ç‡§Ø‡§Æ 5 ‡§§‡§æ‡§≤‡•Å‡§ï‡•á</h3>
        <ul id="mid5" class="ml-1 text-lg"></ul>
      </div>
    </div>
    <div class="flex-1 min-w-[180px]">
      <div class="kpi-card kpi-bottom">
        <h3>‡§§‡§≥ 5 ‡§§‡§æ‡§≤‡•Å‡§ï‡•á</h3>
        <ul id="bot5" class="ml-1 text-lg"></ul>
      </div>
    </div>
  </div>

  <!-- Chart & Downloads -->
  <section class="glass-card p-4 mb-4">
    <h2 class="font-bold text-lg mb-2 text-indigo-800">üéØ ‡§§‡§æ‡§≤‡•Å‡§ï‡§æ ‡§∏‡•ç‡§ï‡•ã‡§Ö‡§∞‡§ö‡•á Donut Chart</h2>
    <div class="text-right mb-1">
      <button class="btn btn2" id="downloadDonut"><i class="fa fa-download"></i> Chart (PNG)</button>
      <button class="btn btn3" id="downloadCSV"><i class="fa fa-file-csv"></i> CSV</button>
    </div>
    <canvas id="donutChart" style="max-width:100%;min-height:260px;height:340px"></canvas>
  </section>

  <!-- Data Table -->
  <section class="glass-card py-3 px-2">
    <h2 class="font-bold text-lg text-indigo-800 mb-1">üìã ‡•ß‡•´ ‡§§‡§æ‡§≤‡•Å‡§ï‡•ç‡§Ø‡§æ‡§Ç‡§ö‡§æ ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§°‡•á‡§ü‡§æ ‡§ü‡•á‡§¨‡§≤</h2>
    <div class="overflow-x-auto">
    <table class="table-auto w-full text-base text-indigo-900 border" id="dataTable">
      <thead><tr id="tblHead"></tr></thead>
      <tbody id="tblBody"></tbody>
    </table>
    </div>
  </section>
</main>
<script>
const GOOGLE_SHEETS_CONFIG = {
  apiKey: 'AIzaSyDhCjnUv7x5yj9cXKV52Qv8CrYwUhBIWuU',
  spreadsheetId: '1y_EVqNg-reS3xV-Kn6cmTou7u_6kuyqykNdgdzXEMkE',
  range: 'Rank!B5:AJ20',
  baseUrl: 'https://sheets.googleapis.com/v4/spreadsheets'
};

let allData = [], headers = [];
let selectedTalukaSet = new Set();
let donutChart;

// --- 1. Load Data ---
async function loadData() {
  try {
    const { baseUrl, spreadsheetId, range, apiKey } = GOOGLE_SHEETS_CONFIG;
    const endpoint = `${baseUrl}/${spreadsheetId}/values/${encodeURIComponent(range)}?majorDimension=ROWS&valueRenderOption=UNFORMATTED_VALUE&key=${apiKey}`;
    const res = await fetch(endpoint);
    if (!res.ok) throw new Error("Google Sheet fetch failed (status "+res.status+")");
    const json = await res.json();
    return parseSheetData(json.values);
  } catch (e) {
    alert("Google Sheet Data Load Error: "+e.message+"\n\nShowing sample data.");
    return getSampleData();
  }
}
function parseSheetData(values) {
  headers = values[0].map(h => h.toString());
  // Find columns of interest (usually "Block Name" or "‡§§‡§æ‡§≤‡•Å‡§ï‡§æ" and "Total Score" or similar)
  const blockCol = headers.findIndex(h => /block.?name|‡§§‡§æ‡§≤‡•Å‡§ï‡§æ/i.test(h));
  const scoreCol = headers.findIndex(h => /total.?score|score|‡§è‡§ï‡•Ç‡§£/i.test(h));
  // Parse all rows as objects
  return values.slice(1).filter(r => r.length && r[blockCol])
    .map(row => {
      const obj = {};
      headers.forEach((h,i) => obj[h]=row[i]);
      obj['__taluka'] = row[blockCol];
      obj['__score'] = parseFloat(row[scoreCol]) || 0;
      return obj;
    });
}
function getSampleData() {
  headers = ["‡§§‡§æ‡§≤‡•Å‡§ï‡§æ", "Total Score", "Sanitation", "Agriculture"];
  return [
    {"‡§§‡§æ‡§≤‡•Å‡§ï‡§æ":"‡§™‡§æ‡§ö‡•ã‡§∞‡§æ","Total Score":99,"Sanitation":87,"Agriculture":77,"__taluka":"‡§™‡§æ‡§ö‡•ã‡§∞‡§æ","__score":99},
    {"‡§§‡§æ‡§≤‡•Å‡§ï‡§æ":"‡§≠‡§°‡§ó‡§æ‡§µ","Total Score":82,"Sanitation":60,"Agriculture":78,"__taluka":"‡§≠‡§°‡§ó‡§æ‡§µ","__score":82},
    {"‡§§‡§æ‡§≤‡•Å‡§ï‡§æ":"‡§ö‡§æ‡§≥‡•Ä‡§∏‡§ó‡§æ‡§µ","Total Score":76,"Sanitation":71,"Agriculture":77,"__taluka":"‡§ö‡§æ‡§≥‡•Ä‡§∏‡§ó‡§æ‡§µ","__score":76},
    {"‡§§‡§æ‡§≤‡•Å‡§ï‡§æ":"‡§ú‡§æ‡§Æ‡§®‡•á‡§∞","Total Score":65,"Sanitation":67,"Agriculture":68,"__taluka":"‡§ú‡§æ‡§Æ‡§®‡•á‡§∞","__score":65},
    {"‡§§‡§æ‡§≤‡•Å‡§ï‡§æ":"‡§ß‡§∞‡§£‡§ó‡§æ‡§µ","Total Score":61,"Sanitation":81,"Agriculture":79,"__taluka":"‡§ß‡§∞‡§£‡§ó‡§æ‡§µ","__score":61},
    {"‡§§‡§æ‡§≤‡•Å‡§ï‡§æ":"‡§è‡§∞‡§Ç‡§°‡•ã‡§≤","Total Score":58,"Sanitation":77,"Agriculture":76,"__taluka":"‡§è‡§∞‡§Ç‡§°‡•ã‡§≤","__score":58},
    {"‡§§‡§æ‡§≤‡•Å‡§ï‡§æ":"‡§ú‡§≥‡§ó‡§æ‡§µ","Total Score":56,"Sanitation":80,"Agriculture":73,"__taluka":"‡§ú‡§≥‡§ó‡§æ‡§µ","__score":56},
    {"‡§§‡§æ‡§≤‡•Å‡§ï‡§æ":"‡§™‡§æ‡§∞‡•ã‡§≥‡§æ","Total Score":54,"Sanitation":52,"Agriculture":53,"__taluka":"‡§™‡§æ‡§∞‡•ã‡§≥‡§æ","__score":54},
    {"‡§§‡§æ‡§≤‡•Å‡§ï‡§æ":"‡§Ö‡§Æ‡§≥‡§®‡•á‡§∞","Total Score":52,"Sanitation":87,"Agriculture":71,"__taluka":"‡§Ö‡§Æ‡§≥‡§®‡•á‡§∞","__score":52},
    {"‡§§‡§æ‡§≤‡•Å‡§ï‡§æ":"‡§¶‡§ø‡§ó‡•ç‡§∞‡§∏","Total Score":48,"Sanitation":70,"Agriculture":68,"__taluka":"‡§¶‡§ø‡§ó‡•ç‡§∞‡§∏","__score":48},
    {"‡§§‡§æ‡§≤‡•Å‡§ï‡§æ":"‡§∏‡§æ‡§∞‡•ç‡§µ‡§ú‡§®‡§ø‡§ï","Total Score":44,"Sanitation":42,"Agriculture":67,"__taluka":"‡§∏‡§æ‡§∞‡•ç‡§µ‡§ú‡§®‡§ø‡§ï","__score":44},
    {"‡§§‡§æ‡§≤‡•Å‡§ï‡§æ":"‡§Ø‡§æ‡§µ‡§≤","Total Score":41,"Sanitation":42,"Agriculture":67,"__taluka":"‡§Ø‡§æ‡§µ‡§≤","__score":41},
    {"‡§§‡§æ‡§≤‡•Å‡§ï‡§æ":"‡§∞‡§æ‡§µ‡•á‡§∞","Total Score":37,"Sanitation":44,"Agriculture":60,"__taluka":"‡§∞‡§æ‡§µ‡•á‡§∞","__score":37},
    {"‡§§‡§æ‡§≤‡•Å‡§ï‡§æ":"‡§¨‡•ã‡§¶‡§µ‡§°","Total Score":32,"Sanitation":77,"Agriculture":63,"__taluka":"‡§¨‡•ã‡§¶‡§µ‡§°","__score":32},
    {"‡§§‡§æ‡§≤‡•Å‡§ï‡§æ":"‡§ö‡•ã‡§™‡§°‡§æ","Total Score":28,"Sanitation":64,"Agriculture":59,"__taluka":"‡§ö‡•ã‡§™‡§°‡§æ","__score":28}
  ];
}

// --- 2. Render Taluka Selection (Checkbox) ---
function renderTalukaCheckboxes() {
  const div = document.getElementById('talukaSelector');
  div.innerHTML = '';
  allData.forEach(row => {
    const taluka = row['__taluka'];
    // Checkbox for each taluka
    div.innerHTML += `
      <label class='checkbox-block'>
        <input type="checkbox" value="${taluka}" onchange="onTalukaSelect(this)">
        <span class='ml-1'>${taluka}</span>
      </label>
    `;
  });
}
window.onTalukaSelect = function(input) {
  if(input.checked) selectedTalukaSet.add(input.value);
  else selectedTalukaSet.delete(input.value);
  document.getElementById("selectedTalukas").innerText = selectedTalukaSet.size
    ? `‡§®‡§ø‡§µ‡§°‡§≤‡•á‡§≤‡•á: ${[...selectedTalukaSet].join(', ')}`
    : '';
}

// --- 3. KPIs: Top/Mid/Bottom 5 cards ---
function renderKPI() {
  // Sort desc. on __score
  const sorted = allData.slice().sort((a,b)=>b.__score - a.__score);
  // Top5, Middle5, Bottom5
  const n = sorted.length;
  // handle for <15!
  let top5 = sorted.slice(0,5);
  let bot5 = sorted.slice(-5).reverse();
  let mid5Start = Math.max(0, Math.floor((n-5)/2));
  let mid5 = sorted.slice(mid5Start, mid5Start+5);

  // Utility
  function itemHTML(entry, colorClass, tag) {
    return `<li>
      <span class="tag ${colorClass}">${entry._rank||''} ${tag||''}</span>
      <b class="ml-1">${entry['__taluka']}</b>
      <span class="ml-2 text-md">(${entry['__score']})</span>
    </li>`;
  }
  // Render
  document.getElementById("top5").innerHTML = top5.map((row,i) => itemHTML({...row,_rank:i+1},"top",'TOP')).join('');
  document.getElementById("mid5").innerHTML = mid5.map((row,i) => itemHTML({...row,_rank:mid5Start+i+1},"mid",'MID')).join('');
  document.getElementById("bot5").innerHTML = bot5.map((row,i) => itemHTML({...row,_rank:n-i},"bot",'BOT')).join('');
}

// --- 4. Donut Chart ---
function renderDonutChart() {
  const ctx = document.getElementById('donutChart').getContext('2d');
  // Data (taluka, score)
  const chartData = allData.map(row => ({
    label: row['__taluka'],
    value: row['__score']
  }));
  // Custom colors for top/mid/bot
  const sorted = allData.slice().sort((a,b)=>b.__score-a.__score);
  let colors = [];
  sorted.forEach((entry,idx)=>{
    if(idx<5) colors.push('#22c55e');
    else if(idx>=sorted.length-5) colors.push('#ef4444');
    else colors.push('#eab308');
  });
  // Arrange color as per label order
  const labelOrder = allData.map(r=>r['__taluka']);
  const colorMap = {};
  sorted.forEach((e,idx)=>{colorMap[e['__taluka']]=colors[idx]});
  const chartColors = labelOrder.map(t=>colorMap[t]||'#8b5cf6');
  // Destroy previous
  if(donutChart) donutChart.destroy();
  donutChart = new Chart(ctx, {
    type: "doughnut",
    data: {
      labels: chartData.map(d=>d.label),
      datasets: [{
        data: chartData.map(d=>d.value),
        backgroundColor: chartColors,
        borderColor: "#fff",
        borderWidth: 2
      }]
    },
    options: {
      responsive:true,
      plugins: {
        legend: {display: true, position:"bottom",labels:{boxWidth:22}},
        datalabels: {
          formatter: (v,ctx) => v,
          color:'#1e293b',
          font:{weight:'bold',size:15}
        },
        tooltip: {callbacks:{label:ctx=>`${ctx.label}: ${ctx.raw}`}}
      }
    },
    plugins: [ChartDataLabels]
  });
}

// --- 5. Data Table ---
function renderTable() {
  // Table Head
  document.getElementById("tblHead").innerHTML =
    `<th>‡§∞‡§Å‡§ï</th>` + headers.map(h=>`<th>${h}</th>`).join('');
  // Body, sorted and with Top/Mid/Bot 5 highlighting
  const sorted = allData.slice().sort((a,b)=>b.__score-a.__score)
    .map((row,idx)=>({...row,_rank:idx+1}));
  let midStart = Math.max(0,Math.floor((sorted.length-5)/2));
  let rows = "";
  sorted.forEach((row,idx) => {
    let tag = "";
    if(idx<5) tag = ' style="background:#bbf7d0;"';
    else if(idx>=sorted.length-5) tag = ' style="background:#fecaca;"';
    else if(idx>=midStart && idx<midStart+5) tag =
      ' style="background:#fef08a;"';
    rows += `<tr${tag}><td>${row._rank}</td>`
      + headers.map(h=>`<td>${row[h]||""}</td>`).join('')
      +`</tr>`;
  });
  document.getElementById("tblBody").innerHTML = rows;
}

// --- 6. CSV Export ---
function downloadCSV() {
  let csv = ["‡§∞‡§Å‡§ï,"+headers.join(",")];
  // Sorted for consistency
  allData.slice().sort((a,b)=>b.__score-a.__score)
    .forEach((row,idx)=> 
      csv.push([idx+1].concat(headers.map(h=>'"'+(row[h]||'')+'"')).join(',')));
  let uri = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv.join("\n"));
  let link = document.createElement('a');
  link.href = uri;
  link.download = 'taluka-ranking.csv';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// --- 7. Chart PNG Download ---
function downloadDonut() {
  let url = donutChart.toBase64Image('image/png',1);
  let link = document.createElement('a');
  link.href = url;
  link.download = 'taluka-score-donut.png';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// --- 8. Multi-Taluka Compare (Alert) ---
document.getElementById("cmpBtn").onclick = function() {
  if(selectedTalukaSet.size===0) {
    alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§ï‡§Æ‡•Ä‡§§ ‡§ï‡§Æ‡•Ä ‡§è‡§ï ‡§§‡§æ‡§≤‡•Å‡§ï‡§æ ‡§®‡§ø‡§µ‡§°‡§æ.");
    return;
  }
  let message = "‡§®‡§ø‡§µ‡§°‡§≤‡•á‡§≤‡•á ‡§§‡§æ‡§≤‡•Å‡§ï‡•á: " + [...selectedTalukaSet].join(", ");
  // If you want detailed comparison, use this below.
  const compareRows = allData.filter(row=>selectedTalukaSet.has(row['__taluka']));
  message += "\n\n(‡§∏‡•ç‡§ï‡•ã‡§Ö‡§∞ comparison):\n";
  compareRows.forEach(r=>{
    message += `${r['__taluka']} - ‡§∏‡•ç‡§ï‡•ã‡§Ö‡§∞: ${r['__score']}\n`;
  });
  alert(message);
};

document.getElementById("refreshBtn").onclick = function(e){
  e.preventDefault(); selectedTalukaSet = new Set();
  document.getElementById("selectedTalukas").textContent = "";
  mainRender();
};
document.getElementById("downloadCSV").onclick = downloadCSV;
document.getElementById("downloadDonut").onclick = downloadDonut;

// -- Main render driver --
async function mainRender() {
  allData = await loadData();
  renderTalukaCheckboxes();
  renderKPI();
  renderDonutChart();
  renderTable();
}
mainRender();
</script>
</body>
</html>
