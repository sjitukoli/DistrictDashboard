<!DOCTYPE html>
<html lang="mr">
<head>
  <meta charset="UTF-8">
  <title>‡§§‡§æ‡§≤‡•Å‡§ï‡§æ ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§§‡•Å‡§≤‡§®‡§æ‡§§‡•ç‡§Æ‡§ï ‡§°‡•Ö‡§∂‡§¨‡•ã‡§∞‡•ç‡§° ‚Äì ‡§ú‡§≥‡§ó‡§æ‡§µ ‡§ú‡§ø‡§≤‡•ç‡§π‡§æ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@500;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <style>
    body {
      font-family: 'Noto Sans Devanagari', sans-serif;
      background: #f7fafc;
      color: #23263a;
      margin: 0;
      padding: 0.8rem;
    }
    .glass {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(99,102,241,0.1);
      margin-bottom: 1rem;
      padding: 0.8rem;
    }
    .dashboard-4col {
      display: flex;
      gap: 0.8rem;
      height: 460px;
    }
    .kpi-col { flex: 0 0 22%; background: #f8fafc; border-radius: 8px; padding: 0.5rem; overflow-y: auto; }
    .chart-col { flex: 0 0 26%; background: #f8fafc; border-radius: 8px; padding: 0.4rem; display: flex; flex-direction: column; }
    .donut-col { flex: 0 0 26%; background: #f8fafc; border-radius: 8px; padding: 0.4rem; display: flex; flex-direction: column; }
    .scheme-col { flex: 0 0 26%; background: #f8fafc; border-radius: 8px; padding: 0.4rem; display: flex; flex-direction: column; }
    .kpi-card {
      border-radius: 6px; text-align:center; font-size:0.85em; font-weight:600; margin:0.2rem 0; padding:0.3rem 0.2rem;
      cursor:pointer; transition: all 0.2s; border:1px solid transparent;
    }
    .kpi-card:hover { border-color:#6366f1; box-shadow:0 2px 8px rgba(99,102,241,0.2); }
    .kpi-card.top { background: linear-gradient(90deg,#10b981,#6ee7b7); color:#fff; }
    .kpi-card.mid { background: linear-gradient(90deg,#f59e0b,#fbbf24); color:#fff; }
    .kpi-card.bot { background: linear-gradient(90deg,#ef4444,#f87171); color:#fff; }
    .kpi-card.blink {
      animation: blink 1.2s infinite;
      background: #22c55e !important;
      color: #fff !important;
    }
    @keyframes blink {
      0%,50%,100% { opacity: 1; }
      25%,75% { opacity: 0.4; }
    }
    .kpi-rank { font-size:0.9em; font-weight:700; }
    .kpi-name { font-size:0.9em; margin:1px 0; }
    .kpi-score { font-size:1em; font-weight:800; }
    .dept-chip {
      display:inline-block; padding:4px 8px; border-radius:15px; font-size:0.8em; background:#e0e7ff;
      margin:2px 3px; color:#3730a3; font-weight:600; cursor:pointer; transition:all 0.15s; border:1px solid transparent;
      user-select:none;
    }
    .dept-chip:hover, .dept-chip.selected {
      background:#fbbf24; color:#92400e; border-color:#f59e0b; transform:scale(1.05);
    }
    .chart-container { width:100%; flex:1; height:250px; margin-bottom:0.8rem; }
    .chart-header { font-size:0.85em; font-weight:700; color:#6366f1; margin-bottom:0.3rem; text-align:center; }
    .btn-compact { padding:0.25rem 0.5rem; font-size:0.75em; margin-top:0.2rem; }
    .table { font-size:0.85em; }
    .table thead th { background:#6366f1; color:#fff; padding:0.35rem; text-align:center; }
    .table tbody td { padding:0.3rem 0.2rem; text-align:center; border:1px solid #e5e7eb; }
    .table tbody tr.selected-block td { background:#dbeafe!important; font-weight:700; }
    .table tbody tr.top5 td { background:#d1fae5!important; }
    .table tbody tr.mid5 td { background:#fef3c7!important; }
    .table tbody tr.bot5 td { background:#fee2e2!important; }
    @media (max-width: 1200px) {
      .dashboard-4col { flex-direction: column; height:auto; }
      .kpi-col, .chart-col, .donut-col, .scheme-col { flex:none; height:300px; }
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <h2 class="text-center mb-2">
      üìä ‡§§‡§æ‡§≤‡•Å‡§ï‡§æ ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§§‡•Å‡§≤‡§®‡§æ‡§§‡•ç‡§Æ‡§ï ‡§°‡•Ö‡§∂‡§¨‡•ã‡§∞‡•ç‡§°<br>
      <small class="text-muted">(‡§ú‡§≥‡§ó‡§æ‡§µ ‡§ú‡§ø‡§≤‡•ç‡§π‡§æ)</small>
    </h2>

    <div class="glass mb-3">
      <div class="row g-2 align-items-center">
        <div class="col-md-6 col-lg-5">
          <label class="form-label">‡§Ø‡•ã‡§ú‡§®‡§æ ‡§®‡§ø‡§µ‡§°‡§æ (Multiple):</label>
          <select id="schemeSelect" multiple class="form-select form-select-sm" size="7"></select>
        </div>
        <div class="col-md-6 col-lg-5">
          <label class="form-label">‡§§‡§æ‡§≤‡•Å‡§ï‡§æ ‡§®‡§ø‡§µ‡§°‡§æ:</label>
          <div id="talukaChips" class="mt-1"></div>
        </div>
        <div class="col-md-12 col-lg-2 text-end mt-2 mt-lg-0">
          <button id="resetBtn" class="btn btn-outline-danger btn-compact">Reset</button>
          <button id="submitBtn" class="btn btn-primary btn-compact ms-2">Submit</button>
        </div>
      </div>
    </div>

    <div class="glass">
      <div class="dashboard-4col">
        <!-- KPI Column -->
        <div class="kpi-col" id="kpiCol" aria-live="polite"></div>

        <!-- Bar Chart -->
        <div class="chart-col">
          <div class="chart-header">üìà ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§™‡•ç‡§∞‡§¶‡§∞‡•ç‡§∂‡§® ‡§§‡•Å‡§≤‡§®‡§æ</div>
          <div class="chart-container"><canvas id="barChart"></canvas></div>
          <button id="downloadBarBtn" class="btn btn-success btn-compact">‚¨áÔ∏è ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°</button>
        </div>

        <!-- Donut Chart -->
        <div class="donut-col">
          <div class="chart-header">üìä ‡§™‡•ç‡§∞‡§§‡§ø‡§∂‡§§ ‡§µ‡§æ‡§ü‡§™</div>
          <div class="chart-container"><canvas id="donutChart"></canvas></div>
          <button id="downloadDonutBtn" class="btn btn-warning btn-compact">‚¨áÔ∏è ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°</button>
        </div>

        <!-- Scheme Rank Chart -->
        <div class="scheme-col">
          <div class="chart-header">üóÇ ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§∞‡§Å‡§ï ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£</div>
          <div class="chart-container"><canvas id="schemeRankChart"></canvas></div>
          <button id="downloadSchemeBtn" class="btn btn-info btn-compact">‚¨áÔ∏è ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°</button>
        </div>
      </div>
    </div>

    <div class="glass mb-3">
      <h6 class="mb-2 text-primary">üìã ‡§§‡§æ‡§≤‡•Å‡§ï‡•ç‡§Ø‡§æ‡§Ç‡§ö‡•Ä ‡§∏‡§Ç‡§™‡•Ç‡§∞‡•ç‡§£ ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§µ ‡§∞‡§Å‡§ï‡§ø‡§Ç‡§ó
        <button id="downloadCsvBtn" class="btn btn-secondary btn-compact float-end">üìä CSV</button>
      </h6>
      <div class="table-responsive" style="max-height: 340px; overflow-y: auto;">
        <table class="table table-bordered" id="dataTable">
          <thead><tr id="tableHeader"></tr></thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const CONFIG = {
      apiKey: 'AIzaSyDhCjnUv7x5yj9cXKV52Qv8CrYwUhBIWuU',
      spreadsheetId: '1y_EVqNg-reS3xV-Kn6cmTou7u_6kuyqykNdgdzXEMkE',
      range: 'Rank!B5:AJ20'
    };
    let rawData=[], headers=[], blocks=[], schemes=[];
    let barChart, donutChart, schemeRankChart;
    const selectedBlocks=new Set(), selectedSchemes=new Set();

    async function fetchSheet() {
      const url=`https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.spreadsheetId}/values/${encodeURIComponent(CONFIG.range)}?majorDimension=ROWS&valueRenderOption=UNFORMATTED_VALUE&key=${CONFIG.apiKey}`;
      const res=await fetch(url);
      if(!res.ok) throw Error(res.statusText);
      return (await res.json()).values;
    }
    function parse(values) {
      headers=values[0];
      const idxBlock=headers.findIndex(h=>/‡§§‡§æ‡§≤‡•Å‡§ï‡§æ/i.test(h));
      blocks=values.slice(1).map(r=>{const o={};headers.forEach((h,i)=>o[h]=r[i]);o._block=r[idxBlock];return o;});
      schemes=headers.filter((_,i)=>i!==idxBlock);
      rawData=blocks;
    }
    function renderControls(){
      const sel=document.getElementById('schemeSelect');
      sel.innerHTML=`<option value="__all__" style="font-weight:bold;">‡§∏‡§∞‡•ç‡§µ ‡§Ø‡•ã‡§ú‡§®‡§æ</option>`+schemes.map(s=>`<option>${s}</option>`).join('');
      sel.addEventListener('change',()=>{
        const v=Array.from(sel.selectedOptions).map(o=>o.value),all=v.includes('__all__');
        if(all) for(let opt of sel.options) if(opt.value!=='__all__') opt.selected=true;
        const actual=Array.from(sel.options).filter(o=>o.value!=='__all__'&&o.selected);
        sel.querySelector('option[value="__all__"]').selected=(actual.length===schemes.length);
      });
      const chips=document.getElementById('talukaChips');
      chips.innerHTML=blocks.map(b=>`<span class="dept-chip" data-block="${b._block}">${b._block}</span>`).join('');
      chips.querySelectorAll('.dept-chip').forEach(span=>{
        span.onclick=()=>{
          const n=span.dataset.block;
          if(selectedBlocks.has(n)){selectedBlocks.delete(n);span.classList.remove('selected');}
          else{selectedBlocks.add(n);span.classList.add('selected');}
          if(selectedBlocks.size===1) renderSchemeRankChart(Array.from(selectedBlocks)[0]);
        };
      });
      document.getElementById('resetBtn').onclick=()=>{selectedBlocks.clear();selectedSchemes.clear();
        chips.querySelectorAll('.dept-chip').forEach(s=>s.classList.remove('selected'));
        sel.selectedIndex=-1;clearDashboard();showAllDefault();};
      document.getElementById('submitBtn').onclick=updateAll;
      document.getElementById('downloadBarBtn').onclick=()=>barChart&&downloadChart(barChart,'bar-chart.png');
      document.getElementById('downloadDonutBtn').onclick=()=>donutChart&&downloadChart(donutChart,'donut-chart.png');
      document.getElementById('downloadSchemeBtn').onclick=()=>schemeRankChart&&downloadChart(schemeRankChart,'scheme-rank-chart.png');
      document.getElementById('downloadCsvBtn').onclick=downloadCSV;
    }
    function downloadChart(c,f){const a=document.createElement('a');a.href=c.toBase64Image();a.download=f;a.click();}
    function collectSelections(){
      selectedBlocks.clear();selectedSchemes.clear();
      document.querySelectorAll('.dept-chip.selected').forEach(el=>selectedBlocks.add(el.dataset.block));
      Array.from(document.getElementById('schemeSelect').selectedOptions).forEach(o=>{
        if(o.value==='__all__') schemes.forEach(s=>selectedSchemes.add(s));
        else selectedSchemes.add(o.value);
      });
    }
    function getRankOnes(){
      const c={};
      schemes.forEach(s=>{
        let best=Infinity,tops=[];
        rawData.forEach(r=>{
          const rk=parseInt(r[s])||999;
          if(rk<best){best=rk;tops=[r._block];}
          else if(rk===best)tops.push(r._block);
        });
        if(best===1)tops.forEach(t=>c[t]=(c[t]||0)+1);
      });
      return Object.entries(c).map(([t,cnt])=>({t,cnt})).sort((a,b)=>b.cnt-a.cnt);
    }
    function compute(){
      collectSelections();
      const schemesArr=selectedSchemes.size?Array.from(selectedSchemes):schemes.slice();
      const blocksArr=selectedBlocks.size?Array.from(selectedBlocks).map(b=>rawData.find(r=>r._block===b)).filter(Boolean):rawData.slice();
      const rankOnes=getRankOnes();
      const mainScheme=schemesArr[0];
      const kpiData=blocksArr.map(r=>{
        const ro=rankOnes.find(x=>x.t===r._block);
        return{_block:r._block,val:mainScheme?(parseInt(r[mainScheme])||999):(ro?ro.cnt:0),ones:ro?ro.cnt:0};
      }).sort((a,b)=>(b.ones-a.ones)||(a.val-b.val));
      kpiData.forEach((d,i)=>d.rank=i+1);
      return{blocksArr,kpiData,schemesArr,mainScheme};
    }
    function renderKPI(d){
      const col=document.getElementById('kpiCol');col.innerHTML='';
      if(!d||!d.kpiData.length)return;
      [['top','üèÜ'],['mid','‚öñÔ∏è'],['bot','üö®']].forEach((cls,idx)=>{
        const item=d.kpiData[idx==0?0:idx==1?Math.floor(d.kpiData.length/2):d.kpiData.length-1];
        if(item)col.innerHTML+=`<div class="kpi-card ${cls[0]}${idx==0?' blink':''}" onclick="showTalukaAnalysis('${item._block}')">
          <div class="kpi-rank">${cls[1]} #${item.rank}</div><div class="kpi-name">${item._block}</div>
          <div class="kpi-score">${idx==0?item.ones+' #1s':item.val}</div></div>`;
      });
    }
    window.showTalukaAnalysis=function(name){
      const asc=schemes.map(s=>({scheme:s,rank:parseInt(rawData.find(r=>r._block===name)[s])||999})).sort((a,b)=>a.rank-b.rank);
      const tot=rawData.length;
      const exc=asc.filter((a,i)=>i<3),need=asc.filter((a,i)=>i>=3&&i<Math.ceil(asc.length*0.7)),att=asc.filter((a,i)=>i>=Math.ceil(asc.length*0.7));
      let rep=`‡§§‡§æ‡§≤‡•Å‡§ï‡§æ: ${name}\n\nüèÜ Top 3:\n`+exc.map(a=>`${a.scheme}: #${a.rank}/${tot}`).join('\n')+
              `\n\n‚öñÔ∏è ‡§Æ‡§ß‡•ç‡§Ø‡§Æ:\n`+need.map(a=>`${a.scheme}: #${a.rank}/${tot}`).join('\n')+
              `\n\nüö® ‡§§‡§≥:\n`+att.map(a=>`${a.scheme}: #${a.rank}/${tot}`).join('\n');
      alert(rep);
    };
    function renderBar(d){const ctx=document.getElementById('barChart').getContext('2d');barChart&&barChart.destroy();
      barChart=new Chart(ctx,{type:'bar',data:{labels:d.kpiData.map(x=>x._block),datasets:[{data:d.kpiData.map(x=>x.ones),backgroundColor:'#6366f1'}]},options:{indexAxis:'y',plugins:{legend:{display:false},datalabels:{anchor:'end',align:'right',formatter:v=>v+' #1s'}},responsive:true,maintainAspectRatio:false},plugins:[ChartDataLabels]});}
    function renderDonut(d){const ctx=document.getElementById('donutChart').getContext('2d');donutChart&&donutChart.destroy();
      donutChart=new Chart(ctx,{type:'doughnut',data:{labels:d.kpiData.map(x=>x._block),datasets:[{data:d.kpiData.map(x=>x.ones),backgroundColor:['#4f46e5','#10b981','#f59e0b','#ef4444','#3b82f6']}]} ,options:{plugins:{legend:{position:'bottom'},datalabels:{formatter:v=>v}},responsive:true,maintainAspectRatio:false},plugins:[ChartDataLabels]});}
    function renderSchemeRankChart(name){
      const tal=rawData.find(r=>r._block===name);if(!tal)return;
      const arr=schemes.map(s=>({scheme:s,rank:parseInt(tal[s])||999})).sort((a,b)=>a.rank-b.rank);
      const ctx=document.getElementById('schemeRankChart').getContext('2d');schemeRankChart&&schemeRankChart.destroy();
      schemeRankChart=new Chart(ctx,{type:'bar',data:{labels:arr.map(a=>a.scheme),datasets:[{data:arr.map(a=>a.rank),backgroundColor:arr.map(a=>a.rank===1?'#10b981':a.rank<=3?'#f59e0b':'#ef4444')}]},options:{plugins:{legend:{display:false},datalabels:{anchor:'end',align:'top',formatter:v=>'#'+v,font:{size:8}}},responsive:true,maintainAspectRatio:false,scales:{y:{reverse:true}}},plugins:[ChartDataLabels]});}
    function renderTable(d){
      const th=`<th>‡§∞‡§Å‡§ï</th><th>#1s</th>`+headers.map(h=>`<th>${h}</th>`).join('');
      document.getElementById('tableHeader').innerHTML=th;
      const rows=d.kpiData.map((r,i)=>{const cls=[i<3?'top5':'',i>=d.kpiData.length-3?'bot5':'',selectedBlocks.has(r._block)?'selected-block':''].filter(Boolean).join(' ');
        const tal=rawData.find(x=>x._block===r._block);
        return `<tr class="${cls}"><td>${r.rank}</td><td><b>${r.ones}</b></td>`+headers.map(h=>`<td>${tal[h]||''}</td>`).join('')+`</tr>`;
      }).join('');
      document.getElementById('tableBody').innerHTML=rows;
    }
    function clearDashboard(){
      document.getElementById('kpiCol').innerHTML='';
      document.getElementById('tableBody').innerHTML='';
      document.getElementById('tableHeader').innerHTML='';
      barChart&&barChart.destroy();
      donutChart&&donutChart.destroy();
      schemeRankChart&&schemeRankChart.destroy();
    }
    function showAllDefault(){
      selectedSchemes.clear();schemes.forEach(s=>selectedSchemes.add(s));
      selectedBlocks.clear();blocks.forEach(b=>selectedBlocks.add(b._block));
      document.querySelectorAll('.dept-chip').forEach(s=>s.classList.add('selected'));
      document.getElementById('schemeSelect').querySelectorAll('option').forEach(o=>o.selected=true);
      updateAll();
    }
    function updateAll(){
      const d=compute();
      if(!d||!d.kpiData.length){alert('‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§Ü‡§£‡§ø ‡§§‡§æ‡§≤‡•Å‡§ï‡§æ ‡§®‡§ø‡§µ‡§°‡§æ.');return;}
      renderKPI(d);renderBar(d);renderDonut(d);renderTable(d);
      if(selectedBlocks.size===1)renderSchemeRankChart(Array.from(selectedBlocks)[0]);
    }
    function downloadCSV(){
      const d=compute();if(!d)return;
      const hd=['‡§∞‡§Å‡§ï','#1 Ranks'].concat(headers);
      let csv=hd.join(',')+'\n'+d.kpiData.map(r=>`${r.rank},${r.ones},`+headers.map(h=>`"${rawData.find(x=>x._block===r._block)[h]||''}"`).join(',')).join('\n');
      const blob=new Blob([csv],{type:'text/csv'}),u=URL.createObjectURL(blob),a=document.createElement('a');a.href=u;a.download='taluka-data.csv';a.click();URL.revokeObjectURL(u);
    }

    (async()=>{
      try{
        const vals=await fetchSheet();
        parse(vals);
        renderControls();
        showAllDefault();
      }catch(e){
        alert('‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§°\xa0‡§§‡•ç‡§∞‡•Å‡§ü‡•Ä: '+e.message);
      }
    })();
  </script>
</body>
</html>
