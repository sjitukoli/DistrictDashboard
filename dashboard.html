<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=10">
    <title>Department Ranking Dashboard Pro - Advanced Analytics</title>
    <!-- CSS Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.2.0/chartjs-plugin-datalabels.min.js"></script>
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --glass-bg: rgba(255,255,255,0.08);
            --glass-border: rgba(255,255,255,0.18);
            --glass-shadow: 0 8px 32px rgba(31,38,135,0.37);
            --primary-gradient: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
            --accent-gradient: linear-gradient(135deg,#f093fb 0%,#f5576c 100%);
            --success-gradient: linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);
            --warning-gradient: linear-gradient(135deg,#43e97b 0%,#38f9d7 100%);
            --dept-grad-1: var(--primary-gradient);
            --dept-grad-2: var(--accent-gradient);
            --dept-grad-3: var(--success-gradient);
            --dept-grad-4: var(--warning-gradient);
            --dept-grad-5: linear-gradient(135deg,#ffa726 0%,#ff7043 100%);
        }
        *{scroll-behavior:smooth;}
        body {
            font-family:'Inter',sans-serif;
            background:linear-gradient(135deg,#667eea 0%,#764ba2 50%,#f093fb 100%);
            min-height:100vh;overflow-x:hidden;color:#fff;
        }
        .glass-card {
            background:rgba(255,255,255,0.12);
            backdrop-filter:blur(20px) saturate(200%);
            -webkit-backdrop-filter:blur(20px) saturate(200%);
            border:1px solid rgba(255,255,255,0.2);
            border-radius:20px;
            transition:0.3s;
            position:relative;overflow:hidden;
        }
        .glass-card:hover {transform:translateY(-8px);box-shadow:0 20px 40px rgba(31,38,135,0.5);border-color:rgba(255,255,255,0.3);}
        .kpi-card, .interactive-btn, .filter-dropdown {transition:0.3s;}
        .kpi-card::after, .department-card::after {content:'';position:absolute;top:0;right:0;width:100px;height:100px;border-radius:50%;background:rgba(255,255,255,0.1);}
        .kpi-value {font-size:2.5rem;font-weight:800;margin-bottom:0.5rem;}
        .kpi-label {font-size:0.875rem;text-transform:uppercase;opacity:0.9;letter-spacing:0.05em;}
        .kpi-change {font-size:0.75rem;padding:0.25rem 0.5rem;border-radius:12px;background:rgba(255,255,255,0.2);}
        .interactive-btn, .filter-dropdown {
            background:var(--glass-bg);backdrop-filter:blur(16px);border:1px solid var(--glass-border);
            color:#fff;padding:0.75rem 1.5rem;border-radius:12px;font-weight:600;cursor:pointer;
        }
        .interactive-btn:hover, .filter-dropdown:hover {background:rgba(255,255,255,0.2);transform:translateY(-2px);}
        .data-table, .ranking-table {width:100%;border-collapse:collapse;color:#fff;}
        .data-table th, .data-table td, .ranking-table th, .ranking-table td {
            padding:1rem;text-align:left;border-bottom:1px solid rgba(255,255,255,0.1);
        }
        .data-table th, .ranking-table th {
            background:rgba(255,255,255,0.1);font-weight:600;text-transform:uppercase;letter-spacing:0.05em;font-size:0.875rem;
        }
        .data-table tbody tr:hover, .ranking-table tbody tr:hover {background:rgba(255,255,255,0.05);}
        .chart-container {position:relative;height:300px;padding:1.5rem;}
        .dashboard-grid, .kpi-grid, .department-grid {display:grid;gap:1.5rem;}
        .dashboard-grid {grid-template-columns:repeat(auto-fit,minmax(350px,1fr));}
        .kpi-grid {grid-template-columns:repeat(auto-fit,minmax(250px,1fr));}
        .department-grid {grid-template-columns:repeat(auto-fit,minmax(300px,1fr));}
        .department-card {
            padding:1.5rem;cursor:pointer;overflow:hidden;border-left:4px solid rgba(255,255,255,0.3);
            transition:0.3s;position:relative;color:#fff;border-radius:16px;
        }
        .department-card:hover {transform:translateX(5px);border-left-color:rgba(255,255,255,0.8);}
        .department-card.selected {border-left-color:#fff;background:rgba(255,255,255,0.2);}
        .department-rank {
            position:absolute;top:10px;right:15px;width:40px;height:40px;border-radius:50%;
            background:rgba(255,255,255,0.2);display:flex;align-items:center;justify-content:center;font-weight:bold;
        }
        .rank-1{background:#FFD700;color:#000;}
        .rank-2{background:#C0C0C0;color:#000;}
        .rank-3{background:#CD7F32;color:#fff;}
        .score-bar {height:8px;background:rgba(255,255,255,0.1);border-radius:4px;overflow:hidden;margin-top:5px;}
        .score-fill {height:100%;background:linear-gradient(90deg,#43e97b,#38f9d7);transition:0.5s;}
        .status-indicator {display:inline-block;width:12px;height:12px;border-radius:50%;margin-right:8px;}
        .status-excellent{background:#10b981;}.status-good{background:#3b82f6;}
        .status-average{background:#f59e0b;}.status-poor{background:#ef4444;}
        .loading-spinner {
            display:inline-block;width:20px;height:20px;border:3px solid rgba(255,255,255,0.3);
            border-radius:50%;border-top-color:#fff;animation:spin 1s linear infinite;
        }
        @keyframes spin{to{transform:rotate(360deg);}}
        @media(max-width:768px){
            .dashboard-grid, .department-grid{grid-template-columns:1fr;}
            .kpi-grid{grid-template-columns:repeat(auto-fit,minmax(200px,1fr));}
            .chart-container{height:250px;padding:1rem;}
            .kpi-value{font-size:2rem;}
        }
        .sidebar, .dark-mode-toggle, .menu-toggle, .fab, .api-status, .notification {
            position:fixed;backdrop-filter:blur(16px);border:1px solid var(--glass-border);border-radius:12px;
        }
        .sidebar {top:0;left:0;width:280px;height:100vh;background:rgba(0,0,0,0.3);
            border-right:1px solid rgba(255,255,255,0.1);transform:translateX(-100%);transition:0.3s;z-index:999;padding:2rem 0;
        }
        .sidebar.open{transform:translateX(0);}
        .sidebar-item{padding:1rem 2rem;color:rgba(255,255,255,0.8);display:flex;align-items:center;gap:1rem;cursor:pointer;transition:0.3s;}
        .sidebar-item:hover{background:rgba(255,255,255,0.1);color:#fff;}
        .menu-toggle{top:20px;left:20px;width:auto;padding:0.75rem;color:#fff;z-index:1001;cursor:pointer;}
        .dark-mode-toggle{top:20px;right:20px;width:50px;height:50px;color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:1000;}
        .dark-mode-toggle:hover,.menu-toggle:hover{background:rgba(255,255,255,0.2);transform:scale(1.1);}
        .fab{bottom:30px;right:30px;width:60px;height:60px;background:var(--accent-gradient);color:#fff;
            display:flex;align-items:center;justify-content:center;font-size:1.5rem;cursor:pointer;z-index:1000;
        }
        .fab:hover{transform:scale(1.1);box-shadow:0 12px 35px rgba(0,0,0,0.4);}
        .api-status{top:70px;right:20px;padding:0.5rem 1rem;font-size:0.875rem;color:#fff;z-index:1000;}
        .api-status.connected{border-color:#10b981;}
        .api-status.disconnected{border-color:#ef4444;}
        .notification{top:4rem;right:1rem;padding:1rem;max-width:300px;color:#fff;z-index:1000;transform:translateX(100%);transition:0.3s;}
        .notification.show{transform:translateX(0);}
    </style>
</head>
<body>
    <!-- API Status -->
    <div class="api-status connected" id="apiStatus">
        <span class="status-indicator status-excellent" id="statusIndicator"></span>
        <span id="statusText">Google Sheets Connected</span>
    </div>

    <!-- Dark Mode & Menu -->
    <button class="dark-mode-toggle" onclick="toggleDarkMode()"><i class="fas fa-moon"></i></button>
    <button class="menu-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-item" onclick="navigateTo('analytics')"><i class="fas fa-chart-line"></i><span>Analytics</span></div>
        <div class="sidebar-item" onclick="navigateTo('ranking')"><i class="fas fa-trophy"></i><span>Rankings</span></div>
        <div class="sidebar-item" onclick="navigateTo('performance')"><i class="fas fa-speedometer-alt"></i><span>Performance</span></div>
        <div class="sidebar-item" onclick="navigateTo('reports')"><i class="fas fa-file-alt"></i><span>Reports</span></div>
        <div class="sidebar-item" onclick="refreshData()"><i class="fas fa-sync-alt"></i><span>Refresh Data</span></div>
    </div>

    <!-- Main Content -->
    <div class="min-h-screen p-6 pt-20 max-w-7xl mx-auto">

        <!-- Header -->
        <div class="glass-card mb-8 p-6 fade-in">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                    <h1 class="text-4xl font-bold">Department Ranking Dashboard Pro üèÜ</h1>
                    <p class="opacity-80">Advanced Department Analytics & Performance Ranking</p>
                </div>
                <div class="flex gap-3 flex-wrap">
                    <select id="departmentFilter" class="filter-dropdown" onchange="filterDept()">
                        <option value="">All Departments</option>
                    </select>
                    <select id="timeFilter" class="filter-dropdown" onchange="filterTime()">
                        <option value="current">Current Period</option>
                        <option value="quarter">This Quarter</option>
                        <option value="year">This Year</option>
                        <option value="custom">Custom Range</option>
                    </select>
                    <button class="interactive-btn" onclick="exportData()"><i class="fas fa-download mr-2"></i>Export</button>
                    <button class="interactive-btn" onclick="refreshData()"><i class="fas fa-sync-alt mr-2"></i>Refresh</button>
                </div>
            </div>
        </div>

        <!-- Department Cards -->
        <section id="analytics" class="mb-8">
            <h2 class="text-2xl font-bold mb-4">Department Selection</h2>
            <div id="departmentCards" class="department-grid"></div>
        </section>

        <!-- KPI Cards -->
        <div id="kpiSection" class="kpi-grid mb-8">
            <div id="kpi1" class="glass-card kpi-card" style="background:var(--primary-gradient);"><div class="kpi-value" id="kpiValue1">‚Äî</div><div class="kpi-label">Overall Score</div><div class="kpi-change" id="kpiChange1">‚Äî</div></div>
            <div id="kpi2" class="glass-card kpi-card" style="background:var(--accent-gradient);"><div class="kpi-value" id="kpiValue2">‚Äî</div><div class="kpi-label">Current Rank</div><div class="kpi-change" id="kpiChange2">‚Äî</div></div>
            <div id="kpi3" class="glass-card kpi-card" style="background:var(--success-gradient);"><div class="kpi-value" id="kpiValue3">‚Äî</div><div class="kpi-label">Efficiency Rate</div><div class="kpi-change" id="kpiChange3">‚Äî</div></div>
            <div id="kpi4" class="glass-card kpi-card" style="background:var(--warning-gradient);"><div class="kpi-value" id="kpiValue4">‚Äî</div><div class="kpi-label">Total Departments</div><div class="kpi-change" id="kpiChange4">‚Äî</div></div>
        </div>

        <!-- Charts & Live Feed -->
        <div class="dashboard-grid mb-8">
            <div id="ranking" class="glass-card p-6">
                <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-semibold">Department Rankings</h3>
                    <select id="rankingMetric" class="filter-dropdown" onchange="updateRankingChart()">
                        <option value="overall">Overall Score</option>
                        <option value="efficiency">Efficiency</option>
                        <option value="innovation">Innovation</option>
                        <option value="customer">Customer Satisfaction</option>
                    </select>
                </div>
                <div class="chart-container"><canvas id="rankingChart"></canvas></div>
            </div>
            <div id="performance" class="glass-card p-6">
                <h3 class="text-xl font-semibold mb-4">Performance Trends</h3>
                <div class="chart-container"><canvas id="performanceChart"></canvas></div>
            </div>
            <div class="glass-card p-6">
                <h3 class="text-xl font-semibold mb-4">Department Comparison</h3>
                <div class="chart-container"><canvas id="comparisonChart"></canvas></div>
            </div>
            <div class="glass-card p-6">
                <h3 class="text-xl font-semibold mb-4">Live Performance Feed</h3>
                <div id="performanceFeed" class="space-y-4"></div>
            </div>
        </div>

        <!-- Detailed Table -->
        <section id="reports" class="glass-card p-6 mb-8">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <h3 class="text-xl font-semibold">Detailed Department Rankings</h3>
                <div class="flex gap-3">
                    <input id="searchInput" type="text" placeholder="Search departments..." class="interactive-btn bg-opacity-20 placeholder-white" onkeyup="searchDepartments()">
                    <button class="interactive-btn" onclick="sortTable()"><i class="fas fa-sort"></i></button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table id="rankingTable" class="ranking-table">
                    <thead><tr>
                        <th>Rank</th><th>Department</th><th>Overall Score</th><th>Efficiency</th><th>Innovation</th><th>Status</th><th>Change</th><th>Actions</th>
                    </tr></thead>
                    <tbody id="rankingTableBody"></tbody>
                </table>
            </div>
        </section>

        <!-- Footer -->
        <div class="glass-card p-6">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="opacity-80">¬© 2025 Department Ranking Dashboard Pro. Real-time data from Google Sheets.</div>
                <div class="flex gap-6">
                    <a href="#" class="opacity-80 hover:opacity-100">API Docs</a>
                    <a href="#" class="opacity-80 hover:opacity-100">Privacy</a>
                    <a href="#" class="opacity-80 hover:opacity-100">Support</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Action Button -->
    <button class="fab" onclick="showUploadModal()"><i class="fas fa-plus"></i></button>

    <!-- Google Sheets Config & Scripts -->
    <script>
        const GOOGLE_SHEETS_CONFIG = {
            apiKey: 'AIzaSyDhCjnUv7x5yj9cXKV52Qv8CrYwUhBIWuU',
            spreadsheetId: '1y_EVqNg-reS3xV-Kn6cmTou7u_6kuyqykNdgdzXEMkE',
            range: 'Sheet1!A:G',
            baseUrl: 'https://sheets.googleapis.com/v4/spreadsheets'
        };
        let departmentData = [], selectedDepartment = null, charts = {}, isDataLoading = false, lastRefresh = 0;

        document.addEventListener('DOMContentLoaded', initializeDashboard);

        async function initializeDashboard() {
            showLoading(true);
            try { await loadDataFromGoogleSheets(); }
            catch { departmentData = getSampleData(); }
            setupFilters(); setupDepartmentCards(); setupCharts(); updateKPIs(); populateRankingTable(); setupLiveFeed();
            showLoading(false); showNotification('Dashboard loaded!', 'success');
        }

        async function loadDataFromGoogleSheets() {
            updateAPIStatus('connecting');
            const { baseUrl, spreadsheetId, range, apiKey } = GOOGLE_SHEETS_CONFIG;
            const endpoint = \`\${baseUrl}/\${spreadsheetId}/values/\${encodeURIComponent(range)}?majorDimension=ROWS&valueRenderOption=UNFORMATTED_VALUE&key=\${apiKey}\`;
            const res = await fetch(endpoint, { cache:'no-store' });
            if (!res.ok) throw new Error('Sheets API '+res.status);
            const json = await res.json();
            if (!json.values || json.values.length<2) throw new Error('Empty sheet');
            departmentData = parseSheetData(json.values);
            updateAPIStatus('connected');
        }

        function parseSheetData(values) {
            const headers = values[0].map(h=>h.toLowerCase());
            return values.slice(1).map((row,i)=>{
                const get = name=>row[headers.indexOf(name)]||0;
                const score=+get('overall score'), eff=+get('efficiency'), inv=+get('innovation'), sat=+get('satisfaction');
                const change = get('change')||'0%';
                const status = score>=85?'excellent':score>=75?'good':score>=65?'average':'poor';
                return { id:i+1, name:get('department'), score, rank:0, efficiency:eff, innovation:inv, satisfaction:sat, change, status, trend:change.includes('+')?'up':'down' };
            }).sort((a,b)=>b.score-a.score).map((d,i)=>({...d,rank:i+1}));
        }

        function getSampleData() {
            return [
                {id:1,name:'Housing & Urban Affairs',score:87.03,efficiency:92.5,innovation:88.2,satisfaction:85.7,change:'+2.5%',status:'excellent',trend:'up'},
                {id:2,name:'Petroleum & Natural Gas',score:83.56,efficiency:89.1,innovation:82.3,satisfaction:79.8,change:'+1.2%',status:'excellent',trend:'up'},
                {id:3,name:'Youth Affairs',score:83.25,efficiency:91.2,innovation:85.1,satisfaction:73.4,change:'+3.1%',status:'good',trend:'up'},
                {id:4,name:'Food & Public Distribution',score:79.98,efficiency:85.7,innovation:74.2,satisfaction:80.0,change:'-0.5%',status:'good',trend:'down'},
                {id:5,name:'Pharmaceuticals',score:79.43,efficiency:83.2,innovation:88.5,satisfaction:66.6,change:'+1.8%',status:'good',trend:'up'}
            ];
        }

        function updateAPIStatus(status) {
            const el=document.getElementById('apiStatus'), ind=document.getElementById('statusIndicator'), txt=document.getElementById('statusText');
            el.className='api-status '+status;
            if(status==='connected'){ind.className='status-indicator status-excellent';txt.textContent='Google Sheets Connected';}
            else if(status==='connecting'){ind.className='status-indicator status-good';txt.textContent='Connecting...';}
            else{ind.className='status-indicator status-poor';txt.textContent='Offline - sample data';}
        }

        function setupFilters() {
            const sel=document.getElementById('departmentFilter');
            sel.innerHTML='<option value="">All Departments</option>';
            departmentData.forEach(d=>sel.innerHTML+=\`<option value="\${d.id}">\${d.name}</option>\`);
        }

        function setupDepartmentCards() {
            const c=document.getElementById('departmentCards');c.innerHTML='';
            departmentData.slice(0,8).forEach((d,i)=>{
                const card=document.createElement('div');card.className='glass-card department-card';card.style.background=`var(--dept-grad-${(i%5)+1})`;
                card.onclick=()=>selectDepartment(d.id);
                card.innerHTML=\`
                    <div class="department-rank rank-\${d.rank<=3?d.rank:''}">\${d.rank}</div>
                    <h4 class="font-bold text-lg">\${d.name}</h4>
                    <div class="flex justify-between items-center"><span>Score</span><span>\${d.score.toFixed(1)}</span></div>
                    <div class="score-bar"><div class="score-fill" style="width:\${d.score}%"></div></div>
                    <div class="flex justify-between items-center mt-2"><span class="status-indicator status-\${d.status}"></span>
                    <span class="\${d.trend==='up'?'text-green-300':'text-red-300'}"><i class="fas fa-arrow-\${d.trend}"></i>\${d.change}</span></div>\`;
                c.appendChild(card);
            });
        }

        function updateKPIs(id=null) {
            const overall= id?departmentData.find(d=>d.id===id):null;
            const avgScore=departmentData.reduce((s,d)=>s+d.score,0)/departmentData.length;
            const avgEff=departmentData.reduce((s,d)=>s+d.efficiency,0)/departmentData.length;
            const vals = id?[overall.score, overall.rank, overall.efficiency, departmentData.length]:[avgScore, departmentData.length, avgEff, departmentData.length];
            document.getElementById('kpiValue1').textContent=vals[0].toFixed(1);
            document.getElementById('kpiValue2').textContent=id?('#'+vals[1]):vals[1];
            document.getElementById('kpiValue3').textContent=vals[2].toFixed(1)+'%';
            document.getElementById('kpiValue4').textContent=vals[3];
            ['kpiChange1','kpiChange2','kpiChange3','kpiChange4'].forEach((cid,i)=>{
                document.getElementById(cid).innerHTML=id?
                    \`<i class="fas fa-arrow-\${overall.trend}"></i>\${i===1?('Rank '+overall.rank):overall.change}\`
                    :'<i class="fas fa-arrow-up"></i>+‚Äô+ (i===2?departmentData.length:‚Äò2.1‚Äô)+‚Äô%‚Äô;
            });
        }

        function setupCharts() {
            const cfg={responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},datalabels:{display:false}},scales:{y:{beginAtZero:true,grid:{color:'rgba(255,255,255,0.1)'}},x:{grid:{color:'rgba(255,255,255,0.1)'}}}};
            const ctxR=document.getElementById('rankingChart').getContext('2d');
            charts.ranking=new Chart(ctxR,{type:'bar',data:{labels:departmentData.slice(0,8).map(d=>d.name),datasets:[{label:'Overall Score',data:departmentData.slice(0,8).map(d=>d.score),backgroundColor:Array(8).fill('rgba(102,126,234,0.8)'),borderColor:Array(8).fill('#667eea'),borderWidth:2,borderRadius:8,borderSkipped:false}]} ,options:{...cfg,plugins:{...cfg.plugins,datalabels:{color:'#fff',anchor:'end',align:'top',formatter:v=>v.toFixed(1)}}}});
            const ctxP=document.getElementById('performanceChart').getContext('2d');
            charts.performance=new Chart(ctxP,{type:'line',data:{labels:['Jan','Feb','Mar','Apr','May','Jun'],datasets:[{label:'Overall Score',data:[...Array(5).fill(0),departmentData[0].score],borderColor:'#60a5fa',backgroundColor:'rgba(96,165,250,0.1)',fill:true,tension:0.4,borderWidth:3,pointBackgroundColor:'#60a5fa',pointBorderColor:'#fff',pointBorderWidth:2,pointRadius:6},{label:'Efficiency',data:[...Array(5).fill(0),departmentData[0].efficiency],borderColor:'#f093fb',backgroundColor:'rgba(240,147,251,0.1)',fill:true,tension:0.4,borderWidth:3,pointBackgroundColor:'#f093fb',pointBorderColor:'#fff',pointBorderWidth:2,pointRadius:6}]},options:{...cfg,plugins:{...cfg.plugins,legend:{position:'top',labels:{padding:20,usePointStyle:true,font:{size:12}}}}}});
            const ctxC=document.getElementById('comparisonChart').getContext('2d');
            const top3=departmentData.slice(0,3);
            charts.comparison=new Chart(ctxC,{type:'radar',data:{labels:['Overall Score','Efficiency','Innovation','Satisfaction'],datasets:top3.map((d,i)=>({label:d.name, data:[d.score,d.efficiency,d.innovation,d.satisfaction],borderColor:['#667eea','#f093fb','#4facfe'][i],backgroundColor:['rgba(102,126,234,0.2)','rgba(240,147,251,0.2)','rgba(79,172,254,0.2)'][i],borderWidth:2,pointBackgroundColor:['#667eea','#f093fb','#4facfe'][i],pointBorderColor:'#fff',pointBorderWidth:2}))},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{padding:20,usePointStyle:true,font:{size:12}}},datalabels:{display:false}},scales:{r:{beginAtZero:true,max:100,grid:{color:'rgba(255,255,255,0.1)'},angleLines:{color:'rgba(255,255,255,0.1)'},pointLabels:{color:'#fff',font:{size:12}}}}}});
        }

        function populateRankingTable() {
            const body=document.getElementById('rankingTableBody');body.innerHTML='';
            departmentData.forEach(d=>{
                const tr=document.createElement('tr');
                tr.innerHTML=\`
                    <td>\${d.rank}</td>
                    <td>\${d.name}</td>
                    <td>\${d.score.toFixed(1)}</td>
                    <td>\${d.efficiency.toFixed(1)}%</td>
                    <td>\${d.innovation.toFixed(1)}%</td>
                    <td><span class="status-indicator status-\${d.status}"></span>\${d.status}</td>
                    <td class="\${d.trend==='up'?'text-green-300':'text-red-300'}"><i class="fas fa-arrow-\${d.trend}"></i>\${d.change}</td>
                    <td><button class="text-blue-400" onclick="viewDetails(\${d.id})"><i class="fas fa-eye"></i></button>
                        <button class="text-green-400" onclick="exportDept(\${d.id})"><i class="fas fa-download"></i></button></td>\`;
                body.appendChild(tr);
            });
        }

        function selectDepartment(id) {
            selectedDepartment=id;
            document.querySelectorAll('.department-card').forEach(c=>c.classList.toggle('selected',c.onclick.toString().includes('('+id+')')));
            updateKPIs(id); updateChartsForDept(id); document.getElementById('departmentFilter').value=id; showNotification('Selected department','info');
        }

        function updateChartsForDept(id) {
            const d=departmentData.find(x=>x.id===id);
            charts.performance.data.datasets[0].data=[d.score-15,d.score-10,d.score-5,d.score-2,d.score+1,d.score];
            charts.performance.data.datasets[1].data=[d.efficiency-12,d.efficiency-8,d.efficiency-4,d.efficiency-1,d.efficiency+2,d.efficiency];
            charts.performance.update();
        }

        function filterDept() {const v=+document.getElementById('departmentFilter').value;v?selectDepartment(v):(selectedDepartment=null,updateKPIs(),document.querySelectorAll('.department-card').forEach(c=>c.classList.remove('selected')));}
        function filterTime(){showNotification('Time filter changed','info');}
        function searchDepartments(){const term=document.getElementById('searchInput').value.toLowerCase();document.querySelectorAll('#rankingTableBody tr').forEach(r=>r.style.display=r.cells[1].textContent.toLowerCase().includes(term)?'':'none');}
        function sortTable(){const body=document.getElementById('rankingTableBody');[...body.children].sort((a,b)=>parseFloat(b.cells[2].textContent)-parseFloat(a.cells[2].textContent)).forEach(r=>body.appendChild(r));showNotification('Sorted','success');}
        function updateRankingChart(){const m=document.getElementById('rankingMetric').value;let data=departmentData.slice(0,8).map(d=>d.score),label='Overall Score';
            if(m==='efficiency'){data=departmentData.slice(0,8).map(d=>d.efficiency);label='Efficiency';}
            if(m==='innovation'){data=departmentData.slice(0,8).map(d=>d.innovation);label='Innovation';}
            if(m==='customer'){data=departmentData.slice(0,8).map(d=>d.satisfaction);label='Customer Satisfaction';}
            charts.ranking.data.datasets[0].data=data;charts.ranking.data.datasets[0].label=label;charts.ranking.update();
        }

        async function refreshData() {
            if(Date.now()-lastRefresh<100) return; lastRefresh=Date.now();
            showLoading(true);
            try{await loadDataFromGoogleSheets(); setupFilters(); setupDepartmentCards(); updateKPIs(selectedDepartment); populateRankingTable(); charts.ranking.destroy(); charts.performance.destroy(); charts.comparison.destroy(); setupCharts(); showNotification('Data refreshed','success');}
            catch{showNotification('Refresh failed','error');}
            showLoading(false);
        }

        function setupLiveFeed(){
            const feed=document.getElementById('performanceFeed');
            const updates=[{icon:'fa-trophy',text:'Housing leads ranking',time:'2m ago',type:'success'},{icon:'fa-chart-line',text:'Efficiency +5%',time:'5m ago',type:'info'},{icon:'fa-bell',text:'New data available',time:'8m ago',type:'warning'},{icon:'fa-sync-alt',text:'Sync complete',time:'12m ago',type:'success'}];
            feed.innerHTML=updates.map(u=>\`<div class="flex items-center gap-3 p-3 rounded-lg bg-white bg-opacity-10"><i class="fas \${u.icon}"></i><div><div>\${u.text}</div><div class="text-sm opacity-60">\${u.time}</div></div></div>\`).join('');
        }

        function exportData(){
            const csv='Rank,Dept,Score,Eff,Inv,Sat,Change\\n'+departmentData.map(d=>[\`\${d.rank}\`,\`"\${d.name}"\`,d.score,d.efficiency,d.innovation,d.satisfaction,\`"\${d.change}"\`].join(',')).join('\\n');
            const uri='data:text/csv;charset=utf-8,'+encodeURIComponent(csv);
            const a=document.createElement('a');a.href=uri;a.download='department_rankings.csv';document.body.appendChild(a);a.click();document.body.removeChild(a);showNotification('Exported','success');
        }
        function exportDept(id){
            const d=departmentData.find(x=>x.id===id);
            const csv='Metric,Value\\nDepartment,'+\`"\${d.name}"\\nRank,\${d.rank}\\nScore,\${d.score}\\nEfficiency,\${d.efficiency}\\nInnovation,\${d.innovation}\\nSatisfaction,\${d.satisfaction}\\nChange,\`+"\\""+d.change+"\\"";
            const uri='data:text/csv;charset=utf-8,'+encodeURIComponent(csv);
            const a=document.createElement('a');a.href=uri;a.download=\`\${d.name.replace(/\\s+/g,'_')}.csv\`;document.body.appendChild(a);a.click();document.body.removeChild(a);showNotification('Dept exported','success');
        }

        function showUploadModal(){showNotification('Upload coming soon','info');}
        function viewDetails(id){selectDepartment(id);showNotification('Viewing details','info');}
        function showLoading(show){isDataLoading=show;document.querySelectorAll('.interactive-btn').forEach(b=>{b.innerHTML=show?'<div class="loading-spinner"></div>':b.innerHTML; b.disabled=show;});}
        function showNotification(msg,type='info'){
            const n=document.createElement('div');n.className='notification';n.innerHTML=\`<i class="fas \${type==='success'?'fa-check-circle':type==='error'?'fa-exclamation-circle':type==='warning'?'fa-exclamation-triangle':'fa-info-circle'} text-\${type==='success'?'green':type==='error'?'red':type==='warning'?'yellow':'blue'}-400 mr-2"></i>\${msg}\`;
            document.body.appendChild(n);setTimeout(()=>n.classList.add('show'),100);setTimeout(()=>{n.classList.remove('show');setTimeout(()=>document.body.removeChild(n),300);},3000);
        }
        function toggleSidebar(){document.getElementById('sidebar').classList.toggle('open');}
        function toggleDarkMode(){showNotification('Dark mode toggle','info');}
        function navigateTo(sec){document.getElementById(sec).scrollIntoView({behavior:'smooth'});toggleSidebar();}
    </script>
</body>
</html>
