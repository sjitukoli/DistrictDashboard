<!DOCTYPE html>
<html lang="mr">
<head>
  <meta charset="UTF-8" />
  <title>‡§§‡§æ‡§≤‡•Å‡§ï‡§æ ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§°‡•Ö‡§∂‡§¨‡•ã‡§∞‡•ç‡§° ‚Äì Enhanced KPI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@500;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <style>
    body { font-family: 'Noto Sans Devanagari', sans-serif; background: #f8fafc; color: #1f2937; }
    .glass { background: #fff; border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.08); padding: 1rem 1.2rem; margin-bottom: 1.5rem; }
    .kpi-row { display: flex; justify-content: space-around; gap: 1rem; margin-bottom: 1.2rem; }
    .kpi-card {
      flex: 1 1 30%;
      background: #f9fafb;
      border-radius: 12px;
      padding: 1rem;
      text-align: center;
      box-shadow: 0 3px 10px rgba(0,0,0,0.05);
      transition: transform 0.2s ease;
    }
    .kpi-card:hover { transform: translateY(-4px); }
    .kpi-card h4 { margin: 0.5rem 0 0.3rem; font-size: 1.2rem; font-weight: bold; }
    .kpi-card span.label { font-size: 0.9rem; font-weight: 600; display: block; opacity: 0.75; }
    .kpi-card.top { background: linear-gradient(90deg, #d1fae5, #6ee7b7); }
    .kpi-card.mid { background: linear-gradient(90deg, #fef9c3, #fde68a); }
    .kpi-card.bot { background: linear-gradient(90deg, #fecaca, #f87171); }
    .chart-container { display: flex; flex-wrap: wrap; gap: 1rem; justify-content: space-between; }
    .chart-box { flex: 1 1 48%; background: #f9fafb; border-radius: 12px; padding: 1rem; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
    canvas { max-width: 100%; }
    .info-badge { background: #eef2ff; padding: 6px 12px; border-left: 4px solid #6366f1; font-size: 0.85em; border-radius: 6px; margin-top: 0.8rem; }
    .form-label { font-weight: 600; }
    .table thead th { background: #6366f1; color: #fff; text-align: center; }
    .table tbody td { text-align: center; font-size: 0.9em; }
  </style>
</head>
<body>
<div class="container-fluid py-3">
  <h2 class="text-center mb-3">üìä ‡§§‡§æ‡§≤‡•Å‡§ï‡§æ ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§§‡•Å‡§≤‡§®‡§æ‡§§‡•ç‡§Æ‡§ï ‡§°‡•Ö‡§∂‡§¨‡•ã‡§∞‡•ç‡§°</h2>
  <div class="glass">
    <div class="row align-items-center g-2">
      <div class="col-md-6">
        <label class="form-label">‡§Ø‡•ã‡§ú‡§®‡§æ ‡§®‡§ø‡§µ‡§°‡§æ:</label>
        <select id="schemeSelect" class="form-select form-select-sm"></select>
      </div>
    </div>
    <div class="info-badge mt-2">
      <i class="fa fa-info-circle me-1"></i> ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§°‡•ç‡§∞‡•â‡§™‡§°‡§æ‡§ä‡§®‡§Æ‡§ß‡•Ç‡§® ‡§®‡§ø‡§µ‡§°‡§æ. ‡§°‡•á‡§ü‡§æ ‡§ñ‡§æ‡§≤‡•Ä ‡§Ö‡§™‡§°‡•á‡§ü ‡§π‡•ã‡§à‡§≤.
    </div>
  </div>

  <div class="glass">
    <div class="kpi-row" id="kpiRow"></div>
    <div class="chart-container">
      <div class="chart-box">
        <h6 class="text-primary">Bar Chart</h6>
        <canvas id="barChart"></canvas>
      </div>
      <div class="chart-box">
        <h6 class="text-primary">Donut Chart</h6>
        <canvas id="donutChart"></canvas>
      </div>
    </div>
  </div>

  <div class="glass">
    <h5 class="mb-2 text-primary">üìã ‡§§‡§æ‡§≤‡•Å‡§ï‡•ç‡§Ø‡§æ‡§Ç‡§ö‡•Ä ‡§Ø‡§æ‡§¶‡•Ä</h5>
    <div class="table-responsive">
      <table class="table table-bordered" id="dataTable">
        <thead><tr><th>‡§∞‡§Å‡§ï</th><th>‡§§‡§æ‡§≤‡•Å‡§ï‡§æ</th><th>‡§ó‡•Å‡§£</th></tr></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
const CONFIG = {
  apiKey: "AIzaSyDhCjnUv7x5yj9cXKV52Qv8CrYwUhBIWuU",
  spreadsheetId: "1y_EVqNg-reS3xV-Kn6cmTou7u_6kuyqykNdgdzXEMkE",
  range: "Rank!B5:AJ20"
};

let rawData = [], schemes = [], selectedScheme = "";

async function fetchData() {
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.spreadsheetId}/values/${CONFIG.range}?majorDimension=ROWS&valueRenderOption=UNFORMATTED_VALUE&key=${CONFIG.apiKey}`;
  const res = await fetch(url);
  const data = await res.json();
  const rows = data.values;
  const headers = rows[0];
  const idxBlock = headers.findIndex(h => /‡§§‡§æ‡§≤‡•Å‡§ï‡§æ/i.test(h));
  rawData = rows.slice(1).map(r => {
    let obj = {};
    headers.forEach((h, i) => obj[h] = r[i]);
    obj._block = r[idxBlock];
    return obj;
  });
  schemes = headers.filter((_, i) => i !== idxBlock);
  populateSchemeDropdown();
  selectedScheme = schemes[0];
  updateDashboard();
}

function populateSchemeDropdown() {
  const sel = document.getElementById('schemeSelect');
  sel.innerHTML = schemes.map(s => `<option value="${s}">${s}</option>`).join('');
  sel.onchange = () => {
    selectedScheme = sel.value;
    updateDashboard();
  };
}

function getTopByCount() {
  const counts = {};
  schemes.forEach(s => {
    let max = -Infinity, bests = [];
    rawData.forEach(r => {
      let v = parseFloat(r[s]);
      if (v > max) { max = v; bests = [r._block]; }
      else if (v === max) bests.push(r._block);
    });
    bests.forEach(t => counts[t] = (counts[t] || 0) + 1);
  });
  return Object.entries(counts).sort((a,b) => b[1]-a[1])[0][0];
}

function updateDashboard() {
  const data = rawData.map(r => ({
    taluka: r._block,
    value: parseFloat(r[selectedScheme]) || 0
  })).filter(d => !isNaN(d.value));
  data.sort((a,b) => b.value - a.value);
  renderKPI(data);
  renderCharts(data);
  renderTable(data);
}

function renderKPI(data) {
  const bestOverall = getTopByCount();
  const kpiRow = document.getElementById('kpiRow');
  kpiRow.innerHTML = '';
  const top = data.find(d => d.taluka === bestOverall) || data[0];
  const mid = data[Math.floor(data.length/2)];
  const bot = data.at(-1);
  [
    { obj: top, label: 'üèÜ ‡§∏‡§∞‡•ç‡§µ‡§æ‡§ß‡§ø‡§ï ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§ü‡•â‡§™‡§∞', cls: 'top' },
    { obj: mid, label: '‚öñÔ∏è ‡§Æ‡§ß‡•ç‡§Ø‡§Æ', cls: 'mid' },
    { obj: bot, label: 'üö® ‡§§‡§≥', cls: 'bot' },
  ].forEach(entry => {
    const div = document.createElement('div');
    div.className = `kpi-card ${entry.cls}`;
    div.innerHTML = `
      <span class="label">${entry.label}</span>
      <h4>${entry.obj.taluka}</h4>
      <div>${entry.obj.value}</div>`;
    kpiRow.appendChild(div);
  });
}

function renderCharts(data) {
  const labels = data.map(d => d.taluka);
  const values = data.map(d => d.value);
  if (window.barChart) window.barChart.destroy();
  if (window.donutChart) window.donutChart.destroy();

  window.barChart = new Chart(document.getElementById('barChart'), {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{ label: selectedScheme, data: values, backgroundColor: '#6366f1', borderRadius: 4 }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      plugins: { legend: { display: false } }
    }
  });

  window.donutChart = new Chart(document.getElementById('donutChart'), {
    type: 'doughnut',
    data: {
      labels: labels,
      datasets: [{ data: values, backgroundColor: ['#4f46e5','#10b981','#f59e0b','#ef4444','#3b82f6','#818cf8','#f472b6','#2dd4bf'] }]
    },
    options: {
      responsive: true,
      plugins: { legend: { position: 'bottom' } }
    }
  });
}

function renderTable(data) {
  const tbody = document.getElementById('tableBody');
  tbody.innerHTML = data.map((d, i) => `<tr><td>${i+1}</td><td>${d.taluka}</td><td>${d.value}</td></tr>`).join('');
}

fetchData();
</script>
</body>
</html>
