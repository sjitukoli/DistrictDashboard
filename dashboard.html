<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Block Ranking Dashboard</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <!-- Chart.js DataLabels plugin -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.2.0/chartjs-plugin-datalabels.umd.min.js"></script>
  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <style>
    body { background: linear-gradient(135deg,#667eea,#f093fb 72%); font-family: 'Inter', sans-serif; color: #fff; min-height: 100vh;}
    .glass-card { background: rgba(255,255,255,0.13); backdrop-filter: blur(14px); border-radius: 12px; box-shadow: 0 4px 32px 0 rgba(30,30,50,0.13);}
    .status-top    {background: #10b981 !important; color: #fff;}
    .status-middle {background: #f59e0b !important; color: #fff;}
    .status-bottom {background: #ef4444 !important; color: #fff;}
    .score-bar{height:8px;background:rgba(255,255,255,.1);border-radius:4px;overflow:hidden;margin-top:5px}
    .score-fill{height:100%;background:linear-gradient(90deg,#43e97b,#38f9d7);transition:width .5s}
    .ranking-table td, .ranking-table th { padding: 0.7em .7em;text-align:left; border-bottom:1px solid rgba(255,255,255,0.08); }
    .ranking-table th {background:rgba(255,255,255,0.11);}
    .selected-row {background:rgba(255,255,255,0.17) !important;}
    .tag { display:inline-block; border-radius:99px; font-size:0.85em; padding: .13em .8em;}
  </style>
</head>
<body class="p-0 m-0">
  <main class="max-w-6xl mx-auto p-4 pt-11">
    <header class="mb-8">
      <h1 class="text-3xl font-black mb-0">Block Ranking Dashboard üèÜ</h1>
      <p class="opacity-80">Live Google Sheets integration (Range: <b>Rank!B5:AJ20</b>)</p>
    </header>

    <!-- Highlight: Top, Middle, Bottom blocks -->
    <div class="glass-card p-4 mb-8 flex flex-wrap justify-between items-center gap-4">
      <div>
        <span class="tag status-top"><i class="fas fa-arrow-up"></i> TOP BLOCK</span>
        <span id="topBlockName" class="ml-2 font-bold text-lg"></span>
      </div>
      <div>
        <span class="tag status-middle"><i class="fas fa-arrows-alt-h"></i> MIDDLE BLOCK</span>
        <span id="midBlockName" class="ml-2 font-bold text-lg"></span>
      </div>
      <div>
        <span class="tag status-bottom"><i class="fas fa-arrow-down"></i> BOTTOM BLOCK</span>
        <span id="bottomBlockName" class="ml-2 font-bold text-lg"></span>
      </div>
      <div class="flex flex-row gap-3 ml-auto">
        <label class="mr-2 font-bold">Sort by:</label>
        <select id="sortMetric" class="rounded px-2 py-1 text-slate-700" onchange="refreshBlockRanking()"></select>
        <button class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-700" onclick="refreshData()">Refresh</button>
      </div>
    </div>

    <!-- Chart -->
    <section class="glass-card mb-6 p-4">
      <h2 class="text-lg font-bold mb-2">Block Scores Leaderboard</h2>
      <div style="height: 350px;">
        <canvas id="blockChart"></canvas>
      </div>
    </section>

    <!-- Full table -->
    <section class="glass-card p-4">
      <h2 class="text-lg font-bold mb-3">Complete Block Ranking Table</h2>
      <div style="overflow-x:auto">
        <table class="ranking-table w-full text-base text-white" id="rankingTable">
          <thead>
            <tr id="tableHead"></tr>
          </thead>
          <tbody id="rankingTableBody"></tbody>
        </table>
      </div>
    </section>
  </main>
  <script>
    // 1. Google Sheets config
    const GOOGLE_SHEETS_CONFIG = {
      apiKey: 'AIzaSyDhCjnUv7x5yj9cXKV52Qv8CrYwUhBIWuU',
      spreadsheetId: '1y_EVqNg-reS3xV-Kn6cmTou7u_6kuyqykNdgdzXEMkE',
      range: 'Rank!B5:AJ20', // B5:AJ20 -- your real data range
      baseUrl: 'https://sheets.googleapis.com/v4/spreadsheets'
    };

    let blockData = [];
    let chart = null;
    let availableMetrics = [];
    let selectedMetric = "Total Score"; // default metric: can be changed below

    document.addEventListener('DOMContentLoaded', () => {
      refreshData();
    });

    async function refreshData() {
      try {
        const res = await loadBlockDataFromGoogleSheets();
        blockData = parseBlockSheetData(res.values);
        setUpMetricDropdown(res.values[0]);
        refreshBlockRanking();
      } catch (e) {
        alert("Failed to load sheet! " + e.message + ". Showing sample data.");
        blockData = getSampleBlockData();
        setUpMetricDropdown(Object.keys(blockData[0]));
        refreshBlockRanking();
      }
    }

    async function loadBlockDataFromGoogleSheets() {
      const { baseUrl, spreadsheetId, range, apiKey } = GOOGLE_SHEETS_CONFIG;
      const url = `${baseUrl}/${spreadsheetId}/values/${encodeURIComponent(range)}?majorDimension=ROWS&valueRenderOption=UNFORMATTED_VALUE&key=${apiKey}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error('API status ' + res.status);
      return await res.json();
    }

    // 2. Sheet parsing logic - Map your columns below!
    // Column headers expected:
    // Block Name | ... | Total Score | ... |
    function parseBlockSheetData(values) {
      const headers = values[0].map(h => h.toString().trim());
      // Find block name + numeric metrics positions
      const blockNameCol = headers.findIndex(h => /block.?name/i.test(h));
      // Find all numeric columns (for metrics drop-down)
      availableMetrics = headers
        .map((h,i) => ({h,i}))
        .filter(o => o.h !== headers[blockNameCol] && !/rank|name|block/i.test(o.h))
        .map(o => o.h)
        .concat(headers.filter(h=>/total.?score/i.test(h))); // ensure "Total Score" is included

      // Defensive: fallback for block name
      const fallbackBlockCol = 0;

      // Map each row to an object
      const rows = values.slice(1).filter(r => r.length && (r[blockNameCol]||r[fallbackBlockCol]));
      const entries = rows.map(row => {
        let entry = {};
        headers.forEach((h,idx) => {
          entry[h] = row[idx];
        });
        return entry;
      });
      return entries;
    }

    // 3. Sorting & UI render
    function refreshBlockRanking() {
      // Pick current metric to rank by
      selectedMetric = document.getElementById("sortMetric").value || selectedMetric;

      // Prepare block ranking
      // Use parseFloat safest possible
      let entries = blockData.map(row => ({
        ...row,
        _score: parseFloat(row[selectedMetric]) || 0
      })).sort((a, b) => b._score - a._score)
        .map((entry, idx) => ({ ...entry, _rank: idx + 1 }));

      // What's the "mid" block? (index: floor(length/2))
      const n = entries.length;
      const topBlock = entries[0];
      const midBlock = entries[Math.floor((n-1) / 2)]; // choose middle when odd
      const bottomBlock = entries[n-1];

      // Set highlight boxes
      document.getElementById("topBlockName").textContent = `${topBlock["Block Name"]||topBlock["Block"]||topBlock["Name"]||"?"} (${topBlock[selectedMetric]})`;
      document.getElementById("midBlockName").textContent = `${midBlock["Block Name"]||midBlock["Block"]||midBlock["Name"]||"?"} (${midBlock[selectedMetric]})`;
      document.getElementById("bottomBlockName").textContent = `${bottomBlock["Block Name"]||bottomBlock["Block"]||bottomBlock["Name"]||"?"} (${bottomBlock[selectedMetric]})`;

      // Table build
      buildRankingTable(entries);

      // Chart
      buildBlockChart(entries);
    }

    function setUpMetricDropdown(headerRow) {
      const sel = document.getElementById("sortMetric");
      // Refresh availableMetrics if not already present
      if (!availableMetrics.length || typeof headerRow[0]==="string") {
        availableMetrics = headerRow.filter(h => h && !/name|block|rank/i.test(h));
        if (headerRow.some(h=>/total.?score/i.test(h))) {
          availableMetrics.unshift(headerRow.find(h=>/total.?score/i.test(h)));
        }
        availableMetrics = [...new Set(availableMetrics.filter(Boolean))];
      }
      sel.innerHTML = "";
      availableMetrics.forEach(metric => {
        sel.innerHTML += `<option value="${metric}" ${/total.?score/i.test(metric)?"selected":""}>${metric}</option>`;
      });
      if (!sel.value) sel.value = availableMetrics[0];
      selectedMetric = sel.value;
    }

    function buildRankingTable(entries) {
      const headers = Object.keys(entries[0]);
      document.getElementById("tableHead").innerHTML =
        `<th>Rank</th>` +
        headers.map(
          h => `<th>${h.replace(/_/g, " ")}</th>`
        ).join('') +
        `<th>Tag</th>`;
      let rows = "";
      const n = entries.length;
      entries.forEach((row, idx) => {
        let tag;
        if (idx === 0) tag = `<span class="tag status-top">TOP</span>`;
        else if (idx === Math.floor((n-1)/2)) tag = `<span class="tag status-middle">MIDDLE</span>`;
        else if (idx === n-1) tag = `<span class="tag status-bottom">BOTTOM</span>`;
        else tag = "";
        rows += "<tr" +
                (idx===0?" class='status-top' ": idx===n-1?" class='status-bottom' ": idx===Math.floor((n-1)/2)?" class='status-middle'" : "") +
                ">";
        rows += `<td><b>${row._rank}</b></td>`;
        headers.forEach(h=>{
          let v = row[h];
          if(h===selectedMetric) v = `<b>${v}</b>`;
          rows += `<td>${v||""}</td>`;
        });
        rows += `<td>${tag}</td>`;
        rows += "</tr>";
      });
      document.getElementById("rankingTableBody").innerHTML = rows;
    }

    function buildBlockChart(entries) {
      const blockNames = entries.map(row => row["Block Name"]||row["Block"]||row["Name"]||"?");
      const blockScores = entries.map(row => row[selectedMetric]);
      // Set color, with top/mid/bottom tagged
      const baseColor = "rgba(102,126,234,0.8)";
      const colors = entries.map((row, idx) => {
        if (idx === 0) return "#10b981"; // Top
        if (idx === entries.length-1) return "#ef4444"; // Bottom
        if (idx === Math.floor((entries.length-1)/2)) return "#f59e0b"; // Middle
        return baseColor;
      });

      // Destroy old chart if exists
      if (chart) chart.destroy();

      const ctx = document.getElementById('blockChart').getContext('2d');
      chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: blockNames,
          datasets: [{
            label: selectedMetric + ' (for Block)',
            data: blockScores,
            backgroundColor: colors,
            borderRadius: 9,
            borderSkipped: false
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {display: false},
            datalabels: {
              display: true,
              anchor: "end", align: "end",
              color: "#fff",
              font: {weight:"bold"},
              formatter: v => v
            }
          },
          scales: {
            y: {beginAtZero: true}
          }
        },
        plugins: [ChartDataLabels]
      });
    }

    // Sample fallback data if Sheet API fails; adjust names/metrics as needed for demo/testing
    function getSampleBlockData() {
      return [
        {"Block Name":"Amalner","Total Score":92,"Sanitation":75,"Agriculture":89},
        {"Block Name":"Bhadgaon","Total Score":82,"Sanitation":60,"Agriculture":77},
        {"Block Name":"Chopda","Total Score":67,"Sanitation":71,"Agriculture":79},
        {"Block Name":"Jamner","Total Score":46,"Sanitation":77,"Agriculture":86},
        {"Block Name":"Dharangaon","Total Score":37,"Sanitation":71,"Agriculture":63},
        {"Block Name":"Erandol","Total Score":55,"Sanitation":55,"Agriculture":72},
        {"Block Name":"Jalgaon","Total Score":74,"Sanitation":93,"Agriculture":85},
        {"Block Name":"Pachora","Total Score":65,"Sanitation":65,"Agriculture":60},
        {"Block Name":"Parola","Total Score":88,"Sanitation":85,"Agriculture":95},
        {"Block Name":"Yawal","Total Score":49,"Sanitation":73,"Agriculture":71},
      ];
    }
  </script>
</body>
</html>
