<!DOCTYPE html>
<html lang="mr">
<head>
  <meta charset="UTF-8" />
  <title>‡§Ø‡•ã‡§ú‡§®‡§æ ‡§°‡•Ö‡§∂‡§¨‡•ã‡§∞‡•ç‡§° ¬∑ ‡§ú‡§≥‡§ó ‡§ú‡§ø‡§≤‡•ç‡§π‡§æ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap & Fonts -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@700;400&display=swap" rel="stylesheet"/>
  <!-- Chart.js & DataLabels -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <style>
    body { font-family:'Noto Sans Devanagari',sans-serif; background:#f5f8ff; color:#23263a; margin:0; padding:1.5rem;}
    .glass { background:#fff; border-radius:15px; box-shadow:0 4px 18px rgba(0,0,0,0.1); margin-bottom:1.5rem; padding:1.5rem;}
    .tab-btn { font-weight:700; padding:.5em 1.5em; border-radius:2em; margin-right:10px; background:#ede9fe; border:none; cursor:pointer; transition:.16s;}
    .tab-btn.active, .tab-btn:hover { background:#7c3aed; color:#fff; transform:scale(1.07);}
    .chip { display:inline-block; padding:.3em 1em; margin:3px; border-radius:20px; background:#e0e7ff; cursor:pointer; transition:.15s;}
    .chip.selected, .chip:hover { background:#fbbf24; color:#78350f; transform:scale(1.05);}
    .kpi-row-wrap { display:flex; gap:1rem; justify-content:center; flex-wrap:wrap; }
    .kpi-kard { background:#fff; border-radius:24px; box-shadow:0 3px 18px rgba(0,0,0,0.1); flex:1 1 260px; text-align:center; padding:1.2em; transition:.2s; cursor:pointer; border:2px solid transparent;}
    .kpi-kard:hover { box-shadow:0 8px 28px rgba(0,0,0,0.15); border-color:#6366f1;}
    .kpi-kard.top { background:linear-gradient(92deg,#d1fae5,#bbf7d0); }
    .kpi-kard.mid { background:linear-gradient(92deg,#fef9c3,#fde68a); }
    .kpi-kard.bot { background:linear-gradient(92deg,#fee2e2,#fecaca); }
    .kpi-medal { margin-bottom:.5em; animation:pop 1.3s infinite alternate;}
    @keyframes pop {0%{transform:scale(1)}100%{transform:scale(1.1)}}
    .kpi-label { font-size:1.1em; font-weight:700; margin-bottom:.3em;}
    .kpi-list { list-style:none; padding:0; margin:0; }
    .kpi-list li { font-size:1em; margin:.2em 0; }
    .chart-header { font-size:1.2em; font-weight:700; text-align:center; margin-bottom:.8em; color:#6366f1;}
    .chart-panel { background:#f9fafb; border-radius:16px; padding:1em; box-shadow:0 2px 8px rgba(0,0,0,0.05); margin-bottom:1em;}
    .chart-container { height:240px!important; }
    .table thead th { background:#6366f1; color:#fff; text-align:center; }
    .table tbody tr.top td { background:#d1fae5!important; }
    .table tbody tr.mid td { background:#fef9c7!important; }
    .table tbody tr.bot td { background:#fee2e2!important; }
    .table tbody td { text-align:center; }
    .suggestion-box { background:#e0f2fe; border-radius:12px; padding:1em; font-size:1.05em; }
    @media(max-width:900px){ .chart-panel{ min-width:100%!important;} }
  </style>
</head>
<body>
  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
      <h2>üìä ‡§§‡§æ‡§≤‡•Å‡§ï‡§æ ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§°‡•Ö‡§∂‡§¨‡•ã‡§∞‡•ç‡§°</h2>
      <div>
        <button id="p1btn" class="tab-btn active">‡§Æ‡•Å‡§ñ‡•ç‡§Ø</button>
        <button id="p2btn" class="tab-btn">‡§Ø‡•ã‡§ú‡§®‡§æ ‡§§‡§™‡§∂‡•Ä‡§≤</button>
      </div>
    </div>

    <!-- Page 1 -->
    <div id="page1">
      <div class="glass mb-4">
        <div class="row g-2 align-items-end">
          <div class="col-md-6">
            <select id="schemeDropdown" class="form-select form-select-sm"></select>
          </div>
          <div class="col-md-6">
            <div id="talukaChips"></div>
          </div>
        </div>
        <div class="text-end mt-3">
          <button id="resetBtn" class="btn btn-compact">üîÑ Reset</button>
          <button id="updateBtn" class="btn btn-compact">üîç Submit</button>
        </div>
      </div>

      <div class="kpi-row-wrap mb-4">
        <div class="kpi-kard top">
          <div class="kpi-medal">ü•á</div>
          <div class="kpi-label">‡§ü‡•â‡§™ ‡•´</div>
          <ul class="kpi-list" id="kpiTopList"></ul>
        </div>
        <div class="kpi-kard mid">
          <div class="kpi-medal">ü•à</div>
          <div class="kpi-label">‡§Æ‡§ß‡•ç‡§Ø‡§Æ ‡•´</div>
          <ul class="kpi-list" id="kpiMidList"></ul>
        </div>
        <div class="kpi-kard bot">
          <div class="kpi-medal">ü•â</div>
          <div class="kpi-label">‡§§‡§≥ ‡•´</div>
          <ul class="kpi-list" id="kpiBotList"></ul>
        </div>
      </div>

      <div class="glass mb-4">
        <div class="chart-panel">
          <div class="chart-header">üìä ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§™‡•ç‡§∞‡§¶‡§∞‡•ç‡§∂‡§® ‡§§‡•Å‡§≤‡§®‡§æ</div>
          <canvas id="barChart" class="chart-container"></canvas>
        </div>
        <div class="chart-panel">
          <div class="chart-header">ü•ß ‡§™‡•ç‡§∞‡§§‡§ø‡§∂‡§§ ‡§µ‡§æ‡§ü‡§™</div>
          <canvas id="donutChart" class="chart-container"></canvas>
        </div>
        <div class="suggestion-box" id="aiSuggestion"></div>
      </div>

      <div class="glass">
        <h5 class="mb-3">‡§§‡§æ‡§≤‡•Å‡§ï‡•ç‡§Ø‡§æ‡§Ç‡§ö‡•Ä ‡§∏‡§Ç‡§™‡•Ç‡§∞‡•ç‡§£ ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§µ ‡§∞‡§Å‡§ï‡§ø‡§Ç‡§ó</h5>
        <div class="table-responsive" style="max-height:300px; overflow-y:auto;">
          <table class="table table-sm mb-0" id="blockDetailsTable">
            <thead><tr><th>‡§§‡§æ‡§≤‡•Å‡§ï‡§æ</th><th>‡§∞‡§Å‡§ï</th></tr></thead>
            <tbody id="talukaRanksBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Page 2 (unchanged placeholder) -->
    <div id="page2" style="display:none;">
      <div class="glass text-center" style="min-height:300px;">
        <p style="opacity:.6;">‡§¶‡•Å‡§∏‡§∞‡•á ‡§™‡•É‡§∑‡•ç‡§† ‡§§‡§Ø‡§æ‡§∞ ‡§ï‡§∞‡§£‡•ç‡§Ø‡§æ‡§§ ‡§Ø‡•á‡§à‡§≤...</p>
      </div>
    </div>
  </div>

  <script>
    const API = "AIzaSyDhCjnUv7x5yj9cXKV52Qv8CrYwUhBIWuU",
          SHEET = "1y_EVqNg-reS3xV-Kn6cmTou7u_6kuyqykNdgdzXEMkE",
          RANGE = "Rank!B5:AJ20";
    let headers, rawData, schemes, barChart, donutChart;

    async function init() {
      const vals = await fetch(
        `https://sheets.googleapis.com/v4/spreadsheets/${SHEET}/values/${encodeURIComponent(RANGE)}?key=${API}`
      ).then(r=>r.json()).then(d=>d.values);
      headers = vals[0];
      rawData = vals.slice(1).map(r=>{
        let o={}; headers.forEach((h,i)=>o[h]=r[i]); o._block=r[0]; return o;
      });
      schemes = headers;
      renderTalukaChips();
      renderSchemeDropdown();
      renderPage1();
      bindUI();
    }

    function renderTalukaChips(){
      const chips = document.getElementById("talukaChips");
      chips.innerHTML = rawData.map(r=>`<span class="chip">${r._block}</span>`).join("");
      chips.querySelectorAll(".chip").forEach(el=>el.onclick=()=>el.classList.toggle("selected"));
    }

    function renderSchemeDropdown(){
      document.getElementById("schemeDropdown").innerHTML =
        schemes.map(s=>`<option>${s}</option>`).join("");
    }

    function getRankList(scheme){
      return rawData.map(r=>({b:r._block,rank:parseInt(r[scheme])||999}))
                    .sort((a,b)=>a.rank-b.rank);
    }

    function renderPage1(){
      const scheme = document.getElementById("schemeDropdown").value || schemes[0];
      const all = getRankList(scheme);

      document.getElementById("kpiTopList").innerHTML =
        all.slice(0,5).map(x=>`<li>${x.b} <span style="color:#818cf8">#${x.rank}</span></li>`).join("");
      document.getElementById("kpiMidList").innerHTML =
        all.slice(5,10).map(x=>`<li>${x.b} <span style="color:#b45309">#${x.rank}</span></li>`).join("");
      document.getElementById("kpiBotList").innerHTML =
        all.slice(10,15).map(x=>`<li>${x.b} <span style="color:#b91c1c">#${x.rank}</span></li>`).join("");

      const pal = ["#6366f1","#10b981","#f59e0b","#ef4444","#3b82f6","#818cf8"];
      barChart?.destroy(); donutChart?.destroy();

      barChart = new Chart(document.getElementById("barChart").getContext("2d"), {
        type:"bar",
        data:{labels:all.map(x=>x.b),datasets:[{data:all.map(x=>x.rank>15?0:x.rank),backgroundColor:pal,borderRadius:8}]},
        options:{indexAxis:"y",plugins:{legend:{display:false},datalabels:{anchor:"end",align:"right",formatter:v=>`#${v}`}},responsive:true,maintainAspectRatio:false},
        plugins:[ChartDataLabels]
      });

      donutChart = new Chart(document.getElementById("donutChart").getContext("2d"), {
        type:"doughnut",
        data:{labels:all.map(x=>x.b),datasets:[{data:all.map(x=>x.rank>15?0:x.rank),backgroundColor:pal}]},
        options:{plugins:{legend:{position:"bottom"},datalabels:{formatter:v=>`#${v}`}},responsive:true,maintainAspectRatio:false},
        plugins:[ChartDataLabels]
      });

      document.getElementById("talukaRanksBody").innerHTML =
        all.slice(0,15).map((x,i)=>`<tr class="${i<5?'top':i<10?'mid':'bot'}"><td>${x.b}</td><td><b>${x.rank<=15?x.rank:'-'}</b></td></tr>`).join("");
    }

    function bindUI(){
      document.getElementById("p1btn").onclick = ()=>showPage(1);
      document.getElementById("p2btn").onclick = ()=>showPage(2);
      document.getElementById("schemeDropdown").onchange = ()=>renderPage1();
      document.getElementById("resetBtn").onclick = ()=>{
        document.querySelectorAll(".chip").forEach(e=>e.classList.remove("selected"));
        renderPage1();
      };
      document.getElementById("updateBtn").onclick = ()=>renderPage1();
    }

    function showPage(pg){
      document.getElementById("page1").style.display = pg===1?"":"none";
      document.getElementById("page2").style.display = pg===2?"":"none";
      if(pg===1) renderPage1();
    }

    window.onload = init;
  </script>
</body>
</html>
