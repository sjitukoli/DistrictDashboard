<!DOCTYPE html>
<html lang="mr">
<head>
  <meta charset="UTF-8">
  <title>ЁЯУК рддрд╛рд▓реБрдХрд╛ рдпреЛрдЬрдирд╛ рдбреЕрд╢рдмреЛрд░реНрдб тАУ рдЬрд│рдЧрд╛рд╡ рдЬрд┐рд▓реНрд╣рд╛</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <!-- Devanagari Font & FontAwesome -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;700&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet"/>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <style>
    body { font-family: 'Noto Sans Devanagari', sans-serif; background:#f2f4fb; color:#333; margin:0; padding:1rem; }
    .glass { background:#fff; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.06); margin-bottom:1rem; padding:1rem; transition:.2s; }
    .glass:hover { transform: translateY(-3px); box-shadow:0 8px 24px rgba(0,0,0,0.1); }
    .nav-switcher .nav-link { cursor:pointer; transition:.2s; }
    .nav-switcher .nav-link.active { background:#6366f1; color:#fff; }
    .kpi-card {
      position: relative; border-radius:50px; padding:.6rem; margin:.4rem 0; text-align:center;
      font-weight:700; cursor:pointer; transition:.2s; border:2px solid transparent;
    }
    .kpi-card:hover { border-color:#6366f1; box-shadow:0 2px 8px rgba(99,102,241,0.3); }
    .kpi-icon { font-size:1.8em; margin-bottom:.3rem; }
    .kpi-card.top .kpi-icon { animation:blink 1.2s infinite; color:#10b981; }
    @keyframes blink {0%,50%,100%{opacity:1}25%,75%{opacity:0.3}}
    .kpi-name { font-size:1.05em; }
    .kpi-score { font-size:1.25em; }
    .dept-chip {
      display:inline-block; padding:5px 10px; margin:3px; border-radius:16px;
      background:#e0e7ff; color:#1e3a8a; font-weight:600; cursor:pointer; transition:.15s;
    }
    .dept-chip.selected, .dept-chip:hover {
      background:#fbbf24; color:#92400e; transform:scale(1.05);
    }
    .chart-header { text-align:center; font-weight:700; margin-bottom:.5rem; color:#6366f1; }
    .chart-container { flex:1; position:relative; margin-bottom:.8rem; }
    .btn-compact { padding:.3rem .6rem; font-size:.85em; transition:.2s; }
    .btn-compact:hover { transform:scale(1.05); }
    .table thead th { background:#6366f1; color:#fff; text-align:center; }
    .table tbody td { text-align:center; }
    .table .selected-block td { background:#dbeafe!important; font-weight:700; }
    .table .top5 td { background:#d1fae5!important; }
    .table .mid5 td { background:#fef3c7!important; }
    .table .bot5 td { background:#fee2e2!important; }
    @media(max-width:1200px){.dashboard-4col{flex-direction:column;height:auto}.dashboard-4col>div{height:300px}}
  </style>
</head>
<body>
  <div class="container-fluid">

    <!-- PAGE 1 -->
    <div id="page1">
      <h2 class="text-center mb-3">ЁЯУК рддрд╛рд▓реБрдХрд╛ рдпреЛрдЬрдирд╛ рддреБрд▓рдирд╛рддреНрдордХ рдбреЕрд╢рдмреЛрд░реНрдб</h2>
      <div class="glass mb-3">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">рдпреЛрдЬрдирд╛ рдирд┐рд╡рдбрд╛:</label>
            <select id="schemeSelect" multiple class="form-select form-select-sm" size="6"></select>
          </div>
          <div class="col-md-6">
            <label class="form-label">рддрд╛рд▓реБрдХрд╛ рдирд┐рд╡рдбрд╛:</label>
            <div id="talukaChips" class="mt-1"></div>
          </div>
        </div>
        <div class="text-end mt-3">
          <button id="resetBtn" class="btn btn-outline-danger btn-compact">Reset</button>
          <button id="updateBtn" class="btn btn-primary btn-compact ms-2">Update</button>
        </div>
      </div>

      <div class="glass d-flex gap-3">
        <!-- KPI -->
        <div style="flex:0 0 22%; overflow-y:auto;">
          <div class="chart-header">ЁЯПЖ KPI</div>
          <div id="kpiCol"></div>
        </div>
        <!-- Bar Chart -->
        <div style="flex:0 0 26%; display:flex; flex-direction:column;">
          <div class="chart-header">ЁЯУИ рдХрд╛рд░реНрдпрдкреНрд░рджрд░реНрд╢рди рддреБрд▓рдирд╛</div>
          <div class="chart-container"><canvas id="barChart"></canvas></div>
          <button id="dlBar" class="btn btn-success btn-compact">тмЗя╕П рдбрд╛рдЙрдирд▓реЛрдб</button>
        </div>
        <!-- Donut Chart -->
        <div style="flex:0 0 26%; display:flex; flex-direction:column;">
          <div class="chart-header">ЁЯУК рдкреНрд░рддрд┐рд╢рдд рд╡рд╛рдЯрдк</div>
          <div class="chart-container"><canvas id="donutChart"></canvas></div>
          <button id="dlDonut" class="btn btn-warning btn-compact">тмЗя╕П рдбрд╛рдЙрдирд▓реЛрдб</button>
        </div>
        <!-- Scheme Rank -->
        <div style="flex:0 0 26%; display:flex; flex-direction:column;">
          <div class="chart-header">ЁЯЧВ рдпреЛрдЬрдирд╛ рд░рдБрдХ рд╡рд┐рд╢реНрд▓реЗрд╖рдг</div>
          <div class="chart-container"><canvas id="schemeRankChart"></canvas></div>
          <button id="dlScheme" class="btn btn-info btn-compact">тмЗя╕П рдбрд╛рдЙрдирд▓реЛрдб</button>
        </div>
      </div>

      <div class="glass mt-3">
        <h6 class="mb-2">ЁЯУЛ рддрд╛рд▓реБрдХреНрдпрд╛рдВрдЪреА рд╕рдВрдкреВрд░реНрдг рдорд╛рд╣рд┐рддреА рд╡ рд░рдБрдХрд┐рдВрдЧ</h6>
        <div class="table-responsive" style="max-height:300px; overflow-y:auto;">
          <table class="table mb-0" id="dataTable">
            <thead><tr id="tblHead"></tr></thead>
            <tbody id="tblBody"></tbody>
          </table>
        </div>
        <div class="text-end mt-2">
          <button id="dlCsv" class="btn btn-secondary btn-compact">ЁЯУК CSV рдбрд╛рдЙрдирд▓реЛрдб</button>
        </div>
      </div>
    </div>

    <!-- PAGE 2 -->
    <div id="page2" style="display:none;">
      <ul class="nav nav-pills nav-switcher mb-3">
        <li class="nav-item"><a class="nav-link active" data-type="top">TOP 5</a></li>
        <li class="nav-item"><a class="nav-link" data-type="mid">рдордзреНрдпрдо 5</a></li>
        <li class="nav-item"><a class="nav-link" data-type="bot">рддрд│ 5</a></li>
      </ul>

      <div class="glass">
        <div class="row">
          <div class="col-lg-4" id="page2KPI"></div>
          <div class="col-lg-4" style="display:flex;flex-direction:column;">
            <div class="chart-header">ЁЯЧВ рдпреЛрдЬрдирд╛ рд░рдБрдХ рд╡рд┐рд╢реНрд▓реЗрд╖рдг</div>
            <div class="chart-container"><canvas id="schemeRankChart2"></canvas></div>
          </div>
          <div class="col-lg-4" id="detailSection"></div>
        </div>
      </div>

      <div class="text-center mt-3">
        <button class="btn btn-outline-primary btn-compact" onclick="showPage(1)">тЖР рдореБрдЦреНрдп рдбреЕрд╢рдмреЛрд░реНрдб</button>
      </div>
    </div>

  </div>

  <script>
    const API_KEY = 'AIzaSyDhCjnUv7x5yj9cXKV52Qv8CrYwUhBIWuU';
    const SHEET_ID = '1y_EVqNg-reS3xV-Kn6cmTou7u_6kuyqykNdgdzXEMkE';
    const RANGE = 'Rank!B5:AJ20';
    let headers, rawData, schemes;
    let barChart, donutChart, schemeRankChart, schemeRankChart2;

    async function init() {
      const vals = await fetch(
        `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(RANGE)}?key=${API_KEY}`
      ).then(r=>r.json()).then(d=>d.values);
      headers = vals[0];
      rawData = vals.slice(1).map(r=>{
        const o={}; headers.forEach((h,i)=>o[h]=r[i]); o._block=r[0]; return o;
      });
      schemes = headers.slice();
      renderControls();
      updateAll();
    }

    function renderControls() {
      const sc = document.getElementById('schemeSelect');
      sc.innerHTML = schemes.map(s=>`<option>${s}</option>`).join('');
      sc.addEventListener('change',()=>{});
      const tc = document.getElementById('talukaChips');
      tc.innerHTML = rawData.map(r=>`<span class="dept-chip">${r._block}</span>`).join('');
      tc.querySelectorAll('.dept-chip').forEach(el=>el.onclick=()=>el.classList.toggle('selected'));
      document.getElementById('updateBtn').onclick=updateAll;
      document.getElementById('resetBtn').onclick=()=>{document.querySelectorAll('.dept-chip').forEach(e=>e.classList.remove('selected'));updateAll();};
      document.getElementById('dlBar').onclick=()=>barChart&&downloadChart(barChart,'bar.png');
      document.getElementById('dlDonut').onclick=()=>donutChart&&downloadChart(donutChart,'donut.png');
      document.getElementById('dlScheme').onclick=()=>schemeRankChart&&downloadChart(schemeRankChart,'scheme.png');
      document.getElementById('dlCsv').onclick=downloadCSV;
      document.querySelectorAll('.nav-switcher .nav-link').forEach(el=>{
        el.onclick=()=>{document.querySelectorAll('.nav-switcher .nav-link').forEach(x=>x.classList.remove('active'));el.classList.add('active');renderPage2();};
      });
    }

    function getSelections() {
      const selS = Array.from(document.getElementById('schemeSelect').selectedOptions).map(o=>o.value);
      const selT = Array.from(document.querySelectorAll('.dept-chip.selected')).map(e=>e.innerText);
      return { selS: selS.length?selS:schemes.slice(), selT: selT.length?selT: rawData.map(r=>r._block) };
    }

    // Count #1 ranks per block
    function computeRankOnes() {
      const cnt={};
      schemes.forEach(s=>{
        let best=Infinity,tops=[];
        rawData.forEach(r=>{const rk=parseInt(r[s])||999; if(rk<best){best=rk;tops=[r._block];} else if(rk===best)tops.push(r._block)});
        if(best===1)tops.forEach(t=>cnt[t]=(cnt[t]||0)+1);
      });
      const arr=rawData.map(r=>({b:r._block,ones:cnt[r._block]||0})).sort((a,b)=>b.ones-a.ones);
      arr.forEach((d,i)=>d.rank=i+1);
      return arr;
    }

    function updateAll() {
      const {selS, selT} = getSelections();
      // Filter rawData if needed by date etc.
      const data = computeRankOnes().filter(d=>selT.includes(d.b));
      renderKPI(data);
      renderBar(data);
      renderDonut(data);
      renderTable(data);

      // Scheme Rank chart for first taluka
      if(data.length) renderSchemeRankChart(data[0].b);
    }

    function renderKPI(data) {
      const col=document.getElementById('kpiCol'); col.innerHTML='';
      [['top','fa-trophy'],['mid','fa-balance-scale'],['bot','fa-exclamation-circle']].forEach((c,i)=>{
        const idx = i===0?0:i===1?Math.floor(data.length/2):data.length-1;
        const it = data[idx];
        if(it) col.innerHTML += `
          <div class="kpi-card ${c[0]}${i===0?' blink':''}" onclick="renderPage2('${it.b}')">
            <i class="fas ${c[1]} kpi-icon"></i>
            <div class="kpi-name">${it.b}</div>
            <div class="kpi-score">${it.ones} #1s</div>
          </div>`;
      });
    }

    function renderBar(data) {
      const ctx = document.getElementById('barChart').getContext('2d');
      barChart&&barChart.destroy();
      const pal=['#6366f1','#10b981','#f59e0b','#ef4444','#3b82f6'];
      barChart=new Chart(ctx,{type:'bar',data:{labels:data.map(x=>x.b),datasets:[{data:data.map(x=>x.ones),backgroundColor:pal}]},options:{indexAxis:'y',plugins:{legend:{display:false},datalabels:{anchor:'end',align:'right',formatter:v=>v+' #1s'}},responsive:true,maintainAspectRatio:false},plugins:[ChartDataLabels]});
    }

    function renderDonut(data) {
      const ctx=document.getElementById('donutChart').getContext('2d');
      donutChart&&donutChart.destroy();
      const pal=['#4f46e5','#10b981','#f59e0b','#ef4444','#3b82f6'];
      donutChart=new Chart(ctx,{type:'doughnut',data:{labels:data.map(x=>x.b),datasets:[{data:data.map(x=>x.ones),backgroundColor:pal}]},options:{plugins:{legend:{position:'bottom'},datalabels:{formatter:v=>v}},responsive:true,maintainAspectRatio:false},plugins:[ChartDataLabels]});
    }

    function renderSchemeRankChart(block) {
      const tal=rawData.find(r=>r._block===block);
      const arr=schemes.map(s=>({s,rank:parseInt(tal[s])||999})).sort((a,b)=>a.rank-b.rank);
      const ctx=document.getElementById('schemeRankChart').getContext('2d');
      schemeRankChart&&schemeRankChart.destroy();
      schemeRankChart=new Chart(ctx,{type:'bar',data:{labels:arr.map(a=>a.s),datasets:[{data:arr.map(a=>a.rank),backgroundColor:arr.map(a=>a.rank===1?'#10b981':a.rank<=3?'#f59e0b':'#ef4444')}]},options:{plugins:{legend:{display:false},datalabels:{anchor:'end',align:'top',formatter:v=>`#${v}`}},scales:{y:{reverse:true}},responsive:true,maintainAspectRatio:false},plugins:[ChartDataLabels]});
    }

    function renderTable(data) {
      const th='<th>рд░рдБрдХ</th><th>#1s</th>'+schemes.map(h=>`<th>${h}</th>`).join('');
      document.getElementById('tblHead').innerHTML=th;
      const rows=data.map((r,i)=>`<tr class="${i<3?'top5':''}${i>=data.length-3?' bot5':''}">
        <td>${r.rank}</td><td>${r.ones}</td>${schemes.map(s=>`<td>${rawData.find(x=>x._block===r.b)[s]||''}</td>`).join('')}
      </tr>`).join('');
      document.getElementById('tblBody').innerHTML=rows;
    }

    function renderPage2(block) {
      document.getElementById('page1').style.display='none';
      document.getElementById('page2').style.display='';
      const nav=document.querySelectorAll('.nav-switcher .nav-link');
      nav.forEach(n=>n.onclick=()=>{nav.forEach(x=>x.classList.remove('active'));n.classList.add('active');showSection(n.dataset.type,block);});
      nav[0].click();
    }

    function showSection(type,block) {
      const all = compute();
      let arr = type==='top'?all.slice(0,5): type==='mid'?all.slice(5,10): all.slice(-5);
      document.getElementById('page2KPI').innerHTML = arr.map(it=>`
        <div class="kpi-card ${type}" onclick="showTalukaAnalysis('${it.b}')">
          <i class="fas fa-chart-line kpi-icon"></i>
          <div class="kpi-name">${it.b}</div>
          <div class="kpi-score">${it.ones} #1s</div>
        </div>`).join('');
      renderSchemeRankChart2(block);
      renderDetail(block);
    }

    function renderSchemeRankChart2(block) {
      const tal=rawData.find(r=>r._block===block);
      const arr=schemes.map(s=>({s,rank:parseInt(tal[s])||999})).sort((a,b)=>a.rank-b.rank);
      const ctx=document.getElementById('schemeRankChart2').getContext('2d');
      schemeRankChart2&&schemeRankChart2.destroy();
      schemeRankChart2=new Chart(ctx,{type:'bar',data:{labels:arr.map(a=>a.s),datasets:[{data:arr.map(a=>a.rank),backgroundColor:arr.map(a=>a.rank===1?'#10b981':a.rank<=3?'#f59e0b':'#ef4444')}]},options:{plugins:{legend:{display:false},datalabels:{anchor:'end',align:'top',formatter:v=>`#${v}`}},scales:{y:{reverse:true}},responsive:true,maintainAspectRatio:false},plugins:[ChartDataLabels]});
    }

    function renderDetail(block) {
      const tal=rawData.find(r=>r._block===block);
      const arr=schemes.map(s=>({s,rank:parseInt(tal[s])||999})).sort((a,b)=>a.rank-b.rank);
      const exc=arr.slice(0,5),need=arr.slice(5,arr.length-5),att=arr.slice(-5);
      document.getElementById('detailSection').innerHTML = `
        <div class="glass progress-section progress-excellent">ЁЯПЖ Top рдкреНрд░рдЧрддреА: ${exc.map(x=>x.s).join(', ')}</div>
        <div class="glass progress-section progress-needs">тЪЦя╕П рдордзреНрдпрдо рдкреНрд░рдЧрддреА: ${need.map(x=>x.s).join(', ')}</div>
        <div class="glass progress-section progress-attention">ЁЯЪи рдкреНрд░рдЧрддреА рдЖрд╡рд╢реНрдпрдХ: ${att.map(x=>x.s).join(', ')}</div>`;
    }

    function showPage(p) {
      document.getElementById('page1').style.display=p===1?'':'none';
      document.getElementById('page2').style.display=p===2?'':'none';
    }

    function compute() { return getRankOnes(); }

    function getRankOnes() {
      const cnt={};
      schemes.forEach(s=>{let best=999,t=[];rawData.forEach(r=>{const rk=parseInt(r[s])||999;if(rk<best){best=rk;t=[r._block];}else if(rk===best)t.push(r._block)});if(best===1)t.forEach(b=>cnt[b]=(cnt[b]||0)+1)});
      const arr=rawData.map(r=>({b:r._block,ones:cnt[r._block]||0})).sort((a,b)=>b.ones-a.ones);
      arr.forEach((d,i)=>d.rank=i+1);
      return arr;
    }

    function downloadCSV() {
      const d=getRankOnes();
      const csv=['рд░рдБрдХ,#1s,'+schemes.join(',')].concat(
        d.map(r=>`${r.rank},${r.ones},`+schemes.map(s=>rawData.find(x=>x._block===r.b)[s]||'').join(','))
      ).join('\n');
      const blob=new Blob([csv],{type:'text/csv'}),u=URL.createObjectURL(blob),a=document.createElement('a');
      a.href=u;a.download='taluka.csv';a.click();URL.revokeObjectURL(u);
    }

    init();
  </script>
</body>
</html>
